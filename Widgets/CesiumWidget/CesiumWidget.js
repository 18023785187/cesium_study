import buildModuleUrl from"../../Core/buildModuleUrl.js";import Cartesian3 from"../../Core/Cartesian3.js";import Clock from"../../Core/Clock.js";import defaultValue from"../../Core/defaultValue.js";import defined from"../../Core/defined.js";import destroyObject from"../../Core/destroyObject.js";import DeveloperError from"../../Core/DeveloperError.js";import Ellipsoid from"../../Core/Ellipsoid.js";import FeatureDetection from"../../Core/FeatureDetection.js";import formatError from"../../Core/formatError.js";import requestAnimationFrame from"../../Core/requestAnimationFrame.js";import ScreenSpaceEventHandler from"../../Core/ScreenSpaceEventHandler.js";import createWorldImagery from"../../Scene/createWorldImagery.js";import Globe from"../../Scene/Globe.js";import Moon from"../../Scene/Moon.js";import Scene from"../../Scene/Scene.js";import SceneMode from"../../Scene/SceneMode.js";import ShadowMode from"../../Scene/ShadowMode.js";import SkyAtmosphere from"../../Scene/SkyAtmosphere.js";import SkyBox from"../../Scene/SkyBox.js";import Sun from"../../Scene/Sun.js";import getElement from"../getElement.js";function getDefaultSkyBoxUrl(e){return buildModuleUrl("Assets/Textures/SkyBox/tycho2t3_80_"+e+".jpg")}function startRenderLoop(e){e._renderLoopRunning=!0;var r=0;requestAnimationFrame((function t(n){if(!e.isDestroyed())if(e._useDefaultRenderLoop)try{var i=e._targetFrameRate;if(defined(i)){var o=1e3/i,a=n-r;a>o&&(e.resize(),e.render(),r=n-a%o),requestAnimationFrame(t)}else e.resize(),e.render(),requestAnimationFrame(t)}catch(r){e._useDefaultRenderLoop=!1,e._renderLoopRunning=!1,e._showRenderLoopErrors&&e.showErrorPanel("An error occurred while rendering.  Rendering has stopped.",void 0,r)}else e._renderLoopRunning=!1}))}function configurePixelRatio(e){var r=e._useBrowserRecommendedResolution?1:window.devicePixelRatio;return r*=e._resolutionScale,defined(e._scene)&&(e._scene.pixelRatio=r),r}function configureCanvasSize(e){var r=e._canvas,t=r.clientWidth,n=r.clientHeight,i=configurePixelRatio(e);e._canvasClientWidth=t,e._canvasClientHeight=n,t*=i,n*=i,r.width=t,r.height=n,e._canRender=0!==t&&0!==n,e._lastDevicePixelRatio=window.devicePixelRatio}function configureCameraFrustum(e){var r=e._canvas,t=r.width,n=r.height;if(0!==t&&0!==n){var i=e._scene.camera.frustum;defined(i.aspectRatio)?i.aspectRatio=t/n:(i.top=i.right*(n/t),i.bottom=-i.top)}}function CesiumWidget(e,r){if(!defined(e))throw new DeveloperError("container is required.");e=getElement(e),r=defaultValue(r,defaultValue.EMPTY_OBJECT);var t=document.createElement("div");t.className="cesium-widget",e.appendChild(t);var n=document.createElement("canvas"),i=FeatureDetection.supportsImageRenderingPixelated();function o(){n!==n.ownerDocument.activeElement&&n.ownerDocument.activeElement.blur()}this._supportsImageRenderingPixelated=i,i&&(n.style.imageRendering=FeatureDetection.imageRenderingValue()),n.oncontextmenu=function(){return!1},n.onselectstart=function(){return!1},n.addEventListener("mousedown",o),n.addEventListener("pointerdown",o),t.appendChild(n);var a=document.createElement("div");a.className="cesium-widget-credits";var s=defined(r.creditContainer)?getElement(r.creditContainer):t;s.appendChild(a);var d=defined(r.creditViewport)?getElement(r.creditViewport):t,c=defaultValue(r.showRenderLoopErrors,!0),l=defaultValue(r.useBrowserRecommendedResolution,!0);this._element=t,this._container=e,this._canvas=n,this._canvasClientWidth=0,this._canvasClientHeight=0,this._lastDevicePixelRatio=0,this._creditViewport=d,this._creditContainer=s,this._innerCreditContainer=a,this._canRender=!1,this._renderLoopRunning=!1,this._showRenderLoopErrors=c,this._resolutionScale=1,this._useBrowserRecommendedResolution=l,this._forceResize=!1,this._clock=defined(r.clock)?r.clock:new Clock,configureCanvasSize(this);try{var u=new Scene({canvas:n,contextOptions:r.contextOptions,creditContainer:a,creditViewport:d,mapProjection:r.mapProjection,orderIndependentTranslucency:r.orderIndependentTranslucency,scene3DOnly:defaultValue(r.scene3DOnly,!1),shadows:r.shadows,mapMode2D:r.mapMode2D,requestRenderMode:r.requestRenderMode,maximumRenderTimeChange:r.maximumRenderTimeChange});this._scene=u,u.camera.constrainedAxis=Cartesian3.UNIT_Z,configurePixelRatio(this),configureCameraFrustum(this);var m=defaultValue(u.mapProjection.ellipsoid,Ellipsoid.WGS84),h=r.globe;defined(h)||(h=new Globe(m)),!1!==h&&(u.globe=h,u.globe.shadows=defaultValue(r.terrainShadows,ShadowMode.RECEIVE_ONLY));var p=r.skyBox;defined(p)||(p=new SkyBox({sources:{positiveX:getDefaultSkyBoxUrl("px"),negativeX:getDefaultSkyBoxUrl("mx"),positiveY:getDefaultSkyBoxUrl("py"),negativeY:getDefaultSkyBoxUrl("my"),positiveZ:getDefaultSkyBoxUrl("pz"),negativeZ:getDefaultSkyBoxUrl("mz")}})),!1!==p&&(u.skyBox=p,u.sun=new Sun,u.moon=new Moon);var f=r.skyAtmosphere;defined(f)||(f=new SkyAtmosphere(m)),!1!==f&&(u.skyAtmosphere=f);var g=!1!==r.globe&&r.imageryProvider;defined(g)||(g=createWorldImagery()),!1!==g&&u.imageryLayers.addImageryProvider(g),defined(r.terrainProvider)&&!1!==r.globe&&(u.terrainProvider=r.terrainProvider),this._screenSpaceEventHandler=new ScreenSpaceEventHandler(n),defined(r.sceneMode)&&(r.sceneMode===SceneMode.SCENE2D&&this._scene.morphTo2D(0),r.sceneMode===SceneMode.COLUMBUS_VIEW&&this._scene.morphToColumbusView(0)),this._useDefaultRenderLoop=void 0,this.useDefaultRenderLoop=defaultValue(r.useDefaultRenderLoop,!0),this._targetFrameRate=void 0,this.targetFrameRate=r.targetFrameRate;var v=this;this._onRenderError=function(e,r){v._useDefaultRenderLoop=!1,v._renderLoopRunning=!1,v._showRenderLoopErrors&&v.showErrorPanel("An error occurred while rendering.  Rendering has stopped.",void 0,r)},u.renderError.addEventListener(this._onRenderError)}catch(e){throw c&&this.showErrorPanel("Error constructing CesiumWidget.",'Visit <a href="http://get.webgl.org">http://get.webgl.org</a> to verify that your web browser and hardware support WebGL.  Consider trying a different web browser or updating your video drivers.  Detailed error information is below:',e),e}}Object.defineProperties(CesiumWidget.prototype,{container:{get:function(){return this._container}},canvas:{get:function(){return this._canvas}},creditContainer:{get:function(){return this._creditContainer}},creditViewport:{get:function(){return this._creditViewport}},scene:{get:function(){return this._scene}},imageryLayers:{get:function(){return this._scene.imageryLayers}},terrainProvider:{get:function(){return this._scene.terrainProvider},set:function(e){this._scene.terrainProvider=e}},camera:{get:function(){return this._scene.camera}},clock:{get:function(){return this._clock}},screenSpaceEventHandler:{get:function(){return this._screenSpaceEventHandler}},targetFrameRate:{get:function(){return this._targetFrameRate},set:function(e){if(e<=0)throw new DeveloperError("targetFrameRate must be greater than 0, or undefined.");this._targetFrameRate=e}},useDefaultRenderLoop:{get:function(){return this._useDefaultRenderLoop},set:function(e){this._useDefaultRenderLoop!==e&&(this._useDefaultRenderLoop=e,e&&!this._renderLoopRunning&&startRenderLoop(this))}},resolutionScale:{get:function(){return this._resolutionScale},set:function(e){if(e<=0)throw new DeveloperError("resolutionScale must be greater than 0.");this._resolutionScale!==e&&(this._resolutionScale=e,this._forceResize=!0)}},useBrowserRecommendedResolution:{get:function(){return this._useBrowserRecommendedResolution},set:function(e){this._useBrowserRecommendedResolution!==e&&(this._useBrowserRecommendedResolution=e,this._forceResize=!0)}}}),CesiumWidget.prototype.showErrorPanel=function(e,r,t){var n=this._element,i=document.createElement("div");i.className="cesium-widget-errorPanel";var o=document.createElement("div");o.className="cesium-widget-errorPanel-content",i.appendChild(o);var a=document.createElement("div");a.className="cesium-widget-errorPanel-header",a.appendChild(document.createTextNode(e)),o.appendChild(a);var s=document.createElement("div");function d(){s.style.maxHeight=Math.max(Math.round(.9*n.clientHeight-100),30)+"px"}s.className="cesium-widget-errorPanel-scroll",o.appendChild(s),d(),defined(window.addEventListener)&&window.addEventListener("resize",d,!1);var c=defined(r),l=defined(t);if(c||l){var u=document.createElement("div");if(u.className="cesium-widget-errorPanel-message",s.appendChild(u),l){var m=formatError(t);c||("string"==typeof t&&(t=new Error(t)),r=formatError({name:t.name,message:t.message}),m=t.stack),"undefined"!=typeof console&&console.error(e+"\n"+r+"\n"+m);var h=document.createElement("div");h.className="cesium-widget-errorPanel-message-details collapsed";var p=document.createElement("span");p.className="cesium-widget-errorPanel-more-details",p.appendChild(document.createTextNode("See more...")),h.appendChild(p),h.onclick=function(e){h.removeChild(p),h.appendChild(document.createTextNode(m)),h.className="cesium-widget-errorPanel-message-details",o.className="cesium-widget-errorPanel-content expanded",h.onclick=void 0},s.appendChild(h)}u.innerHTML="<p>"+r+"</p>"}var f=document.createElement("div");f.className="cesium-widget-errorPanel-buttonPanel",o.appendChild(f);var g=document.createElement("button");g.setAttribute("type","button"),g.className="cesium-button",g.appendChild(document.createTextNode("OK")),g.onclick=function(){defined(d)&&defined(window.removeEventListener)&&window.removeEventListener("resize",d,!1),n.removeChild(i)},f.appendChild(g),n.appendChild(i)},CesiumWidget.prototype.isDestroyed=function(){return!1},CesiumWidget.prototype.destroy=function(){defined(this._scene)&&(this._scene.renderError.removeEventListener(this._onRenderError),this._scene=this._scene.destroy()),this._container.removeChild(this._element),this._creditContainer.removeChild(this._innerCreditContainer),destroyObject(this)},CesiumWidget.prototype.resize=function(){var e=this._canvas;(this._forceResize||this._canvasClientWidth!==e.clientWidth||this._canvasClientHeight!==e.clientHeight||this._lastDevicePixelRatio!==window.devicePixelRatio)&&(this._forceResize=!1,configureCanvasSize(this),configureCameraFrustum(this),this._scene.requestRender())},CesiumWidget.prototype.render=function(){if(this._canRender){this._scene.initializeFrame();var e=this._clock.tick();this._scene.render(e)}else this._clock.tick()};export default CesiumWidget;