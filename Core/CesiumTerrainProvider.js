import when from"../ThirdParty/when.js";import AttributeCompression from"./AttributeCompression.js";import BoundingSphere from"./BoundingSphere.js";import Cartesian3 from"./Cartesian3.js";import Credit from"./Credit.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import Event from"./Event.js";import GeographicTilingScheme from"./GeographicTilingScheme.js";import WebMercatorTilingScheme from"./WebMercatorTilingScheme.js";import getJsonFromTypedArray from"./getJsonFromTypedArray.js";import HeightmapTerrainData from"./HeightmapTerrainData.js";import IndexDatatype from"./IndexDatatype.js";import OrientedBoundingBox from"./OrientedBoundingBox.js";import QuantizedMeshTerrainData from"./QuantizedMeshTerrainData.js";import Request from"./Request.js";import RequestType from"./RequestType.js";import Resource from"./Resource.js";import RuntimeError from"./RuntimeError.js";import TerrainProvider from"./TerrainProvider.js";import TileAvailability from"./TileAvailability.js";import TileProviderError from"./TileProviderError.js";function LayerInformation(e){this.resource=e.resource,this.version=e.version,this.isHeightmap=e.isHeightmap,this.tileUrlTemplates=e.tileUrlTemplates,this.availability=e.availability,this.hasVertexNormals=e.hasVertexNormals,this.hasWaterMask=e.hasWaterMask,this.hasMetadata=e.hasMetadata,this.availabilityLevels=e.availabilityLevels,this.availabilityTilesLoaded=e.availabilityTilesLoaded,this.littleEndianExtensionSize=e.littleEndianExtensionSize,this.availabilityPromiseCache={}}function CesiumTerrainProvider(e){if(!defined(e)||!defined(e.url))throw new DeveloperError("options.url is required.");this._heightmapWidth=65,this._heightmapStructure=void 0,this._hasWaterMask=!1,this._hasVertexNormals=!1,this._ellipsoid=e.ellipsoid,this._requestVertexNormals=defaultValue(e.requestVertexNormals,!1),this._requestWaterMask=defaultValue(e.requestWaterMask,!1),this._requestMetadata=defaultValue(e.requestMetadata,!0),this._errorEvent=new Event;var r=e.credit;"string"==typeof r&&(r=new Credit(r)),this._credit=r,this._availability=void 0;var t=when.defer();this._ready=!1,this._readyPromise=t,this._tileCredits=void 0;var i,a,n,o=this,s=this._layers=[],l="",d=[],h=0;function v(e){var r;if(!e.format)return r="The tile format is not specified in the layer.json file.",void(n=TileProviderError.handleError(n,o,o._errorEvent,r,void 0,void 0,void 0,c));if(!e.tiles||0===e.tiles.length)return r="The layer.json file does not specify any tile URL templates.",void(n=TileProviderError.handleError(n,o,o._errorEvent,r,void 0,void 0,void 0,c));var t=!1,m=!1,f=!1,y=!0,p=!1;if("heightmap-1.0"===e.format)p=!0,defined(o._heightmapStructure)||(o._heightmapStructure={heightScale:.2,heightOffset:-1e3,elementsPerHeight:1,stride:1,elementMultiplier:256,isBigEndian:!1,lowestEncodedHeight:0,highestEncodedHeight:65535}),m=!0,o._requestWaterMask=!0;else if(0!==e.format.indexOf("quantized-mesh-1."))return r='The tile format "'+e.format+'" is invalid or not supported.',void(n=TileProviderError.handleError(n,o,o._errorEvent,r,void 0,void 0,void 0,c));var g,E=e.tiles,_=e.maxzoom;if(h=Math.max(h,_),e.projection&&"EPSG:4326"!==e.projection){if("EPSG:3857"!==e.projection)return r='The projection "'+e.projection+'" is invalid or not supported.',void(n=TileProviderError.handleError(n,o,o._errorEvent,r,void 0,void 0,void 0,c));o._tilingScheme=new WebMercatorTilingScheme({numberOfLevelZeroTilesX:1,numberOfLevelZeroTilesY:1,ellipsoid:o._ellipsoid})}else o._tilingScheme=new GeographicTilingScheme({numberOfLevelZeroTilesX:2,numberOfLevelZeroTilesY:1,ellipsoid:o._ellipsoid});if(o._levelZeroMaximumGeometricError=TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(o._tilingScheme.ellipsoid,o._heightmapWidth,o._tilingScheme.getNumberOfXTilesAtLevel(0)),e.scheme&&"tms"!==e.scheme&&"slippyMap"!==e.scheme)return r='The scheme "'+e.scheme+'" is invalid or not supported.',void(n=TileProviderError.handleError(n,o,o._errorEvent,r,void 0,void 0,void 0,c));o._scheme=e.scheme,defined(e.extensions)&&-1!==e.extensions.indexOf("octvertexnormals")?t=!0:defined(e.extensions)&&-1!==e.extensions.indexOf("vertexnormals")&&(t=!0,y=!1),defined(e.extensions)&&-1!==e.extensions.indexOf("watermask")&&(m=!0),defined(e.extensions)&&-1!==e.extensions.indexOf("metadata")&&(f=!0);var T,b=e.metadataAvailability,A=e.available;if(defined(A)&&!defined(b)){T=new TileAvailability(o._tilingScheme,A.length);for(var M=0;M<A.length;++M){var x=A[M],S=o._tilingScheme.getNumberOfYTilesAtLevel(M);defined(d[M])||(d[M]=[]);for(var w=0;w<x.length;++w){var L=x[w],R=S-L.endY-1,P=S-L.startY-1;d[M].push([L.startX,R,L.endX,P]),T.addAvailableTileRange(M,L.startX,R,L.endX,P)}}}else defined(b)&&(g=new TileAvailability(o._tilingScheme,_),T=new TileAvailability(o._tilingScheme,_),d[0]=[[0,0,1,0]],T.addAvailableTileRange(0,0,0,1,0));o._hasWaterMask=o._hasWaterMask||m,o._hasVertexNormals=o._hasVertexNormals||t,o._hasMetadata=o._hasMetadata||f,defined(e.attribution)&&(l.length>0&&(l+=" "),l+=e.attribution),s.push(new LayerInformation({resource:i,version:e.version,isHeightmap:p,tileUrlTemplates:E,availability:T,hasVertexNormals:t,hasWaterMask:m,hasMetadata:f,availabilityLevels:b,availabilityTilesLoaded:g,littleEndianExtensionSize:y}));var q=e.parentUrl;if(defined(q)){if(!defined(T))return console.log("A layer.json can't have a parentUrl if it does't have an available array."),when.resolve();(i=i.getDerivedResource({url:q})).appendForwardSlash();var N=(a=i.getDerivedResource({url:"layer.json"})).fetchJson();return when(N,v,u)}return when.resolve()}function u(e){var r="An error occurred while accessing "+a.url+".";n=TileProviderError.handleError(n,o,o._errorEvent,r,void 0,void 0,void 0,c)}function m(e){v(e).then((function(){if(!defined(n)){var e=d.length;if(e>0)for(var r=o._availability=new TileAvailability(o._tilingScheme,h),t=0;t<e;++t)for(var i=d[t],a=0;a<i.length;++a){var s=i[a];r.addAvailableTileRange(t,s[0],s[1],s[2],s[3])}if(l.length>0){var v=new Credit(l);defined(o._tileCredits)?o._tileCredits.push(v):o._tileCredits=[v]}o._ready=!0,o._readyPromise.resolve(!0)}}))}function f(e){defined(e)&&404===e.statusCode?m({tilejson:"2.1.0",format:"heightmap-1.0",version:"1.0.0",scheme:"tms",tiles:["{z}/{x}/{y}.terrain?v={version}"]}):u()}function c(){when(a.fetchJson()).then(m).otherwise(f)}when(e.url).then((function(e){var r=Resource.createIfNeeded(e);r.appendForwardSlash(),a=(i=r).getDerivedResource({url:"layer.json"}),o._tileCredits=r.credits,c()})).otherwise((function(e){t.reject(e)}))}var QuantizedMeshExtensionIds={OCT_VERTEX_NORMALS:1,WATER_MASK:2,METADATA:4};function getRequestHeader(e){return defined(e)&&0!==e.length?{Accept:"application/vnd.quantized-mesh;extensions="+e.join("-")+",application/octet-stream;q=0.9,*/*;q=0.01"}:{Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9,*/*;q=0.01"}}function createHeightmapTerrainData(e,r,t,i,a){var n=new Uint16Array(r,0,e._heightmapWidth*e._heightmapWidth);return new HeightmapTerrainData({buffer:n,childTileMask:new Uint8Array(r,n.byteLength,1)[0],waterMask:new Uint8Array(r,n.byteLength+1,r.byteLength-n.byteLength-1),width:e._heightmapWidth,height:e._heightmapWidth,structure:e._heightmapStructure,credits:e._tileCredits})}function createQuantizedMeshTerrainData(e,r,t,i,a,n){var o=n.littleEndianExtensionSize,s=0,l=3*Float64Array.BYTES_PER_ELEMENT,d=4*Float64Array.BYTES_PER_ELEMENT,h=3*Uint16Array.BYTES_PER_ELEMENT,v=Uint16Array.BYTES_PER_ELEMENT,u=3*v,m=new DataView(r),f=new Cartesian3(m.getFloat64(s,!0),m.getFloat64(s+8,!0),m.getFloat64(s+16,!0));s+=l;var c=m.getFloat32(s,!0);s+=Float32Array.BYTES_PER_ELEMENT;var y=m.getFloat32(s,!0);s+=Float32Array.BYTES_PER_ELEMENT;var p=new BoundingSphere(new Cartesian3(m.getFloat64(s,!0),m.getFloat64(s+8,!0),m.getFloat64(s+16,!0)),m.getFloat64(s+l,!0));s+=d;var g=new Cartesian3(m.getFloat64(s,!0),m.getFloat64(s+8,!0),m.getFloat64(s+16,!0));s+=l;var E=m.getUint32(s,!0);s+=Uint32Array.BYTES_PER_ELEMENT;var _=new Uint16Array(r,s,3*E);s+=E*h,E>65536&&(u=3*(v=Uint32Array.BYTES_PER_ELEMENT));var T=_.subarray(0,E),b=_.subarray(E,2*E),A=_.subarray(2*E,3*E);AttributeCompression.zigZagDeltaDecode(T,b,A),s%v!=0&&(s+=v-s%v);var M=m.getUint32(s,!0);s+=Uint32Array.BYTES_PER_ELEMENT;var x=IndexDatatype.createTypedArrayFromArrayBuffer(E,r,s,3*M);s+=M*u;for(var S=0,w=x.length,L=0;L<w;++L){var R=x[L];x[L]=S-R,0===R&&++S}var P=m.getUint32(s,!0);s+=Uint32Array.BYTES_PER_ELEMENT;var q=IndexDatatype.createTypedArrayFromArrayBuffer(E,r,s,P);s+=P*v;var N=m.getUint32(s,!0);s+=Uint32Array.BYTES_PER_ELEMENT;var j=IndexDatatype.createTypedArrayFromArrayBuffer(E,r,s,N);s+=N*v;var D=m.getUint32(s,!0);s+=Uint32Array.BYTES_PER_ELEMENT;var B=IndexDatatype.createTypedArrayFromArrayBuffer(E,r,s,D);s+=D*v;var C=m.getUint32(s,!0);s+=Uint32Array.BYTES_PER_ELEMENT;var U,k,W=IndexDatatype.createTypedArrayFromArrayBuffer(E,r,s,C);for(s+=C*v;s<m.byteLength;){var F=m.getUint8(s,!0);s+=Uint8Array.BYTES_PER_ELEMENT;var V=m.getUint32(s,o);if(s+=Uint32Array.BYTES_PER_ELEMENT,F===QuantizedMeshExtensionIds.OCT_VERTEX_NORMALS&&e._requestVertexNormals)U=new Uint8Array(r,s,2*E);else if(F===QuantizedMeshExtensionIds.WATER_MASK&&e._requestWaterMask)k=new Uint8Array(r,s,V);else if(F===QuantizedMeshExtensionIds.METADATA&&e._requestMetadata){var Y=m.getUint32(s,!0);if(Y>0){var z=getJsonFromTypedArray(new Uint8Array(r),s+Uint32Array.BYTES_PER_ELEMENT,Y).available;if(defined(z))for(var O=0;O<z.length;++O)for(var H=t+O+1,I=z[O],G=e._tilingScheme.getNumberOfYTilesAtLevel(H),X=0;X<I.length;++X){var Q=I[X],Z=G-Q.endY-1,J=G-Q.startY-1;e.availability.addAvailableTileRange(H,Q.startX,Z,Q.endX,J),n.availability.addAvailableTileRange(H,Q.startX,Z,Q.endX,J)}}n.availabilityTilesLoaded.addAvailableTileRange(t,i,a,i,a)}s+=V}var K=5*e.getLevelMaximumGeometricError(t),$=e._tilingScheme.tileXYToRectangle(i,a,t),ee=OrientedBoundingBox.fromRectangle($,c,y,e._tilingScheme.ellipsoid);return new QuantizedMeshTerrainData({center:f,minimumHeight:c,maximumHeight:y,boundingSphere:p,orientedBoundingBox:ee,horizonOcclusionPoint:g,quantizedVertices:_,encodedNormals:U,indices:x,westIndices:q,southIndices:j,eastIndices:B,northIndices:W,westSkirtHeight:K,southSkirtHeight:K,eastSkirtHeight:K,northSkirtHeight:K,childTileMask:e.availability.computeChildMaskForTile(t,i,a),waterMask:k,credits:e._tileCredits})}function requestTileGeometry(e,r,t,i,a,n){if(!defined(a))return when.reject(new RuntimeError("Terrain tile doesn't exist"));var o=a.tileUrlTemplates;if(0!==o.length){var s;s=e._scheme&&"tms"!==e._scheme?t:e._tilingScheme.getNumberOfYTilesAtLevel(i)-t-1;var l,d,h=[];e._requestVertexNormals&&a.hasVertexNormals&&h.push(a.littleEndianExtensionSize?"octvertexnormals":"vertexnormals"),e._requestWaterMask&&a.hasWaterMask&&h.push("watermask"),e._requestMetadata&&a.hasMetadata&&h.push("metadata");var v=o[(r+s+i)%o.length],u=a.resource;defined(u._ionEndpoint)&&!defined(u._ionEndpoint.externalType)?(0!==h.length&&(d={extensions:h.join("-")}),l=getRequestHeader(void 0)):l=getRequestHeader(h);var m=u.getDerivedResource({url:v,templateValues:{version:a.version,z:i,x:r,y:s},queryParameters:d,headers:l,request:n}).fetchArrayBuffer();if(defined(m))return m.then((function(n){return defined(e._heightmapStructure)?createHeightmapTerrainData(e,n,i,r,t):createQuantizedMeshTerrainData(e,n,i,r,t,a)}))}}function getAvailabilityTile(e,r,t,i){if(0!==i){var a=e.availabilityLevels,n=i%a==0?i-a:(i/a|0)*a,o=1<<i-n;return{level:n,x:r/o|0,y:t/o|0}}}function checkLayer(e,r,t,i,a,n){if(!defined(a.availabilityLevels))return{result:!1};for(var o,s=function(){delete a.availabilityPromiseCache[o]},l=a.availabilityTilesLoaded,d=a.availability,h=getAvailabilityTile(a,r,t,i);defined(h);){if(d.isTileAvailable(h.level,h.x,h.y)&&!l.isTileAvailable(h.level,h.x,h.y)){var v;if(!n&&(o=h.level+"-"+h.x+"-"+h.y,v=a.availabilityPromiseCache[o],!defined(v))){var u=new Request({throttle:!1,throttleByServer:!0,type:RequestType.TERRAIN});v=requestTileGeometry(e,h.x,h.y,h.level,a,u),defined(v)&&(a.availabilityPromiseCache[o]=v,v.then(s))}return{result:!0,promise:v}}h=getAvailabilityTile(a,h.x,h.y,h.level)}return{result:!1}}CesiumTerrainProvider.prototype.requestTileGeometry=function(e,r,t,i){if(!this._ready)throw new DeveloperError("requestTileGeometry must not be called before the terrain provider is ready.");var a,n=this._layers,o=n.length;if(1===o)a=n[0];else for(var s=0;s<o;++s){var l=n[s];if(!defined(l.availability)||l.availability.isTileAvailable(t,e,r)){a=l;break}}return requestTileGeometry(this,e,r,t,a,i)},Object.defineProperties(CesiumTerrainProvider.prototype,{errorEvent:{get:function(){return this._errorEvent}},credit:{get:function(){if(!this._ready)throw new DeveloperError("credit must not be called before the terrain provider is ready.");return this._credit}},tilingScheme:{get:function(){if(!this._ready)throw new DeveloperError("tilingScheme must not be called before the terrain provider is ready.");return this._tilingScheme}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise.promise}},hasWaterMask:{get:function(){if(!this._ready)throw new DeveloperError("hasWaterMask must not be called before the terrain provider is ready.");return this._hasWaterMask&&this._requestWaterMask}},hasVertexNormals:{get:function(){if(!this._ready)throw new DeveloperError("hasVertexNormals must not be called before the terrain provider is ready.");return this._hasVertexNormals&&this._requestVertexNormals}},hasMetadata:{get:function(){if(!this._ready)throw new DeveloperError("hasMetadata must not be called before the terrain provider is ready.");return this._hasMetadata&&this._requestMetadata}},requestVertexNormals:{get:function(){return this._requestVertexNormals}},requestWaterMask:{get:function(){return this._requestWaterMask}},requestMetadata:{get:function(){return this._requestMetadata}},availability:{get:function(){if(!this._ready)throw new DeveloperError("availability must not be called before the terrain provider is ready.");return this._availability}}}),CesiumTerrainProvider.prototype.getLevelMaximumGeometricError=function(e){return this._levelZeroMaximumGeometricError/(1<<e)},CesiumTerrainProvider.prototype.getTileDataAvailable=function(e,r,t){if(defined(this._availability)){if(t>this._availability._maximumLevel)return!1;if(this._availability.isTileAvailable(t,e,r))return!0;if(!this._hasMetadata)return!1;for(var i=this._layers,a=i.length,n=0;n<a;++n)if(checkLayer(this,e,r,t,i[n],0===n).result)return;return!1}},CesiumTerrainProvider.prototype.loadTileDataAvailability=function(e,r,t){if(!(!defined(this._availability)||t>this._availability._maximumLevel||this._availability.isTileAvailable(t,e,r))&&this._hasMetadata)for(var i=this._layers,a=i.length,n=0;n<a;++n){var o=checkLayer(this,e,r,t,i[n],0===n);if(defined(o.promise))return o.promise}},CesiumTerrainProvider._getAvailabilityTile=getAvailabilityTile;export default CesiumTerrainProvider;