import ArcType from"./ArcType.js";import arrayFill from"./arrayFill.js";import BoundingSphere from"./BoundingSphere.js";import Check from"./Check.js";import ComponentDatatype from"./ComponentDatatype.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import Ellipsoid from"./Ellipsoid.js";import EllipsoidTangentPlane from"./EllipsoidTangentPlane.js";import Geometry from"./Geometry.js";import GeometryAttribute from"./GeometryAttribute.js";import GeometryAttributes from"./GeometryAttributes.js";import GeometryInstance from"./GeometryInstance.js";import GeometryOffsetAttribute from"./GeometryOffsetAttribute.js";import GeometryPipeline from"./GeometryPipeline.js";import IndexDatatype from"./IndexDatatype.js";import CesiumMath from"./Math.js";import PolygonGeometryLibrary from"./PolygonGeometryLibrary.js";import PolygonPipeline from"./PolygonPipeline.js";import PrimitiveType from"./PrimitiveType.js";import WindingOrder from"./WindingOrder.js";var createGeometryFromPositionsPositions=[],createGeometryFromPositionsSubdivided=[];function createGeometryFromPositions(e,t,r,i,o){var n,a,s=EllipsoidTangentPlane.fromPoints(t,e).projectPointsOntoPlane(t,createGeometryFromPositionsPositions);PolygonPipeline.computeWindingOrder2D(s)===WindingOrder.CLOCKWISE&&(s.reverse(),t=t.slice().reverse());var y=t.length,l=0;if(i)for(n=new Float64Array(2*y*3),a=0;a<y;a++){var p=t[a],m=t[(a+1)%y];n[l++]=p.x,n[l++]=p.y,n[l++]=p.z,n[l++]=m.x,n[l++]=m.y,n[l++]=m.z}else{var u=0;if(o===ArcType.GEODESIC)for(a=0;a<y;a++)u+=PolygonGeometryLibrary.subdivideLineCount(t[a],t[(a+1)%y],r);else if(o===ArcType.RHUMB)for(a=0;a<y;a++)u+=PolygonGeometryLibrary.subdivideRhumbLineCount(e,t[a],t[(a+1)%y],r);for(n=new Float64Array(3*u),a=0;a<y;a++){var d;o===ArcType.GEODESIC?d=PolygonGeometryLibrary.subdivideLine(t[a],t[(a+1)%y],r,createGeometryFromPositionsSubdivided):o===ArcType.RHUMB&&(d=PolygonGeometryLibrary.subdivideRhumbLine(e,t[a],t[(a+1)%y],r,createGeometryFromPositionsSubdivided));for(var f=d.length,g=0;g<f;++g)n[l++]=d[g]}}var c=2*(y=n.length/3),h=IndexDatatype.createTypedArray(y,c);for(l=0,a=0;a<y-1;a++)h[l++]=a,h[l++]=a+1;return h[l++]=y-1,h[l++]=0,new GeometryInstance({geometry:new Geometry({attributes:new GeometryAttributes({position:new GeometryAttribute({componentDatatype:ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:n})}),indices:h,primitiveType:PrimitiveType.LINES})})}function createGeometryFromPositionsExtruded(e,t,r,i,o){var n,a,s=EllipsoidTangentPlane.fromPoints(t,e).projectPointsOntoPlane(t,createGeometryFromPositionsPositions);PolygonPipeline.computeWindingOrder2D(s)===WindingOrder.CLOCKWISE&&(s.reverse(),t=t.slice().reverse());var y=t.length,l=new Array(y),p=0;if(i)for(n=new Float64Array(2*y*3*2),a=0;a<y;++a){l[a]=p/3;var m=t[a],u=t[(a+1)%y];n[p++]=m.x,n[p++]=m.y,n[p++]=m.z,n[p++]=u.x,n[p++]=u.y,n[p++]=u.z}else{var d=0;if(o===ArcType.GEODESIC)for(a=0;a<y;a++)d+=PolygonGeometryLibrary.subdivideLineCount(t[a],t[(a+1)%y],r);else if(o===ArcType.RHUMB)for(a=0;a<y;a++)d+=PolygonGeometryLibrary.subdivideRhumbLineCount(e,t[a],t[(a+1)%y],r);for(n=new Float64Array(3*d*2),a=0;a<y;++a){var f;l[a]=p/3,o===ArcType.GEODESIC?f=PolygonGeometryLibrary.subdivideLine(t[a],t[(a+1)%y],r,createGeometryFromPositionsSubdivided):o===ArcType.RHUMB&&(f=PolygonGeometryLibrary.subdivideRhumbLine(e,t[a],t[(a+1)%y],r,createGeometryFromPositionsSubdivided));for(var g=f.length,c=0;c<g;++c)n[p++]=f[c]}}y=n.length/6;var h=l.length,P=2*(2*y+h),b=IndexDatatype.createTypedArray(y+h,P);for(p=0,a=0;a<y;++a)b[p++]=a,b[p++]=(a+1)%y,b[p++]=a+y,b[p++]=(a+1)%y+y;for(a=0;a<h;a++){var G=l[a];b[p++]=G,b[p++]=G+y}return new GeometryInstance({geometry:new Geometry({attributes:new GeometryAttributes({position:new GeometryAttribute({componentDatatype:ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:n})}),indices:b,primitiveType:PrimitiveType.LINES})})}function PolygonOutlineGeometry(e){if(Check.typeOf.object("options",e),Check.typeOf.object("options.polygonHierarchy",e.polygonHierarchy),e.perPositionHeight&&defined(e.height))throw new DeveloperError("Cannot use both options.perPositionHeight and options.height");if(defined(e.arcType)&&e.arcType!==ArcType.GEODESIC&&e.arcType!==ArcType.RHUMB)throw new DeveloperError("Invalid arcType. Valid options are ArcType.GEODESIC and ArcType.RHUMB.");var t=e.polygonHierarchy,r=defaultValue(e.ellipsoid,Ellipsoid.WGS84),i=defaultValue(e.granularity,CesiumMath.RADIANS_PER_DEGREE),o=defaultValue(e.perPositionHeight,!1),n=o&&defined(e.extrudedHeight),a=defaultValue(e.arcType,ArcType.GEODESIC),s=defaultValue(e.height,0),y=defaultValue(e.extrudedHeight,s);if(!n){var l=Math.max(s,y);y=Math.min(s,y),s=l}this._ellipsoid=Ellipsoid.clone(r),this._granularity=i,this._height=s,this._extrudedHeight=y,this._arcType=a,this._polygonHierarchy=t,this._perPositionHeight=o,this._perPositionHeightExtrude=n,this._offsetAttribute=e.offsetAttribute,this._workerName="createPolygonOutlineGeometry",this.packedLength=PolygonGeometryLibrary.computeHierarchyPackedLength(t)+Ellipsoid.packedLength+8}PolygonOutlineGeometry.pack=function(e,t,r){return Check.typeOf.object("value",e),Check.defined("array",t),r=defaultValue(r,0),r=PolygonGeometryLibrary.packPolygonHierarchy(e._polygonHierarchy,t,r),Ellipsoid.pack(e._ellipsoid,t,r),r+=Ellipsoid.packedLength,t[r++]=e._height,t[r++]=e._extrudedHeight,t[r++]=e._granularity,t[r++]=e._perPositionHeightExtrude?1:0,t[r++]=e._perPositionHeight?1:0,t[r++]=e._arcType,t[r++]=defaultValue(e._offsetAttribute,-1),t[r]=e.packedLength,t};var scratchEllipsoid=Ellipsoid.clone(Ellipsoid.UNIT_SPHERE),dummyOptions={polygonHierarchy:{}};PolygonOutlineGeometry.unpack=function(e,t,r){Check.defined("array",e),t=defaultValue(t,0);var i=PolygonGeometryLibrary.unpackPolygonHierarchy(e,t);t=i.startingIndex,delete i.startingIndex;var o=Ellipsoid.unpack(e,t,scratchEllipsoid);t+=Ellipsoid.packedLength;var n=e[t++],a=e[t++],s=e[t++],y=1===e[t++],l=1===e[t++],p=e[t++],m=e[t++],u=e[t];return defined(r)||(r=new PolygonOutlineGeometry(dummyOptions)),r._polygonHierarchy=i,r._ellipsoid=Ellipsoid.clone(o,r._ellipsoid),r._height=n,r._extrudedHeight=a,r._granularity=s,r._perPositionHeight=l,r._perPositionHeightExtrude=y,r._arcType=p,r._offsetAttribute=-1===m?void 0:m,r.packedLength=u,r},PolygonOutlineGeometry.fromPositions=function(e){return e=defaultValue(e,defaultValue.EMPTY_OBJECT),Check.defined("options.positions",e.positions),new PolygonOutlineGeometry({polygonHierarchy:{positions:e.positions},height:e.height,extrudedHeight:e.extrudedHeight,ellipsoid:e.ellipsoid,granularity:e.granularity,perPositionHeight:e.perPositionHeight,arcType:e.arcType,offsetAttribute:e.offsetAttribute})},PolygonOutlineGeometry.createGeometry=function(e){var t=e._ellipsoid,r=e._granularity,i=e._polygonHierarchy,o=e._perPositionHeight,n=e._arcType,a=PolygonGeometryLibrary.polygonOutlinesFromHierarchy(i,!o,t);if(0!==a.length){var s,y,l,p=[],m=CesiumMath.chordLength(r,t.maximumRadius),u=e._height,d=e._extrudedHeight;if(e._perPositionHeightExtrude||!CesiumMath.equalsEpsilon(u,d,0,CesiumMath.EPSILON2))for(l=0;l<a.length;l++){if((s=createGeometryFromPositionsExtruded(t,a[l],m,o,n)).geometry=PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(s.geometry,u,d,t,o),defined(e._offsetAttribute)){var f=s.geometry.attributes.position.values.length/3,g=new Uint8Array(f);e._offsetAttribute===GeometryOffsetAttribute.TOP?g=arrayFill(g,1,0,f/2):(y=e._offsetAttribute===GeometryOffsetAttribute.NONE?0:1,g=arrayFill(g,y)),s.geometry.attributes.applyOffset=new GeometryAttribute({componentDatatype:ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:g})}p.push(s)}else for(l=0;l<a.length;l++){if((s=createGeometryFromPositions(t,a[l],m,o,n)).geometry.attributes.position.values=PolygonPipeline.scaleToGeodeticHeight(s.geometry.attributes.position.values,u,t,!o),defined(e._offsetAttribute)){var c=s.geometry.attributes.position.values.length,h=new Uint8Array(c/3);y=e._offsetAttribute===GeometryOffsetAttribute.NONE?0:1,arrayFill(h,y),s.geometry.attributes.applyOffset=new GeometryAttribute({componentDatatype:ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:h})}p.push(s)}var P=GeometryPipeline.combineInstances(p)[0],b=BoundingSphere.fromVertices(P.attributes.position.values);return new Geometry({attributes:P.attributes,indices:P.indices,primitiveType:P.primitiveType,boundingSphere:b,offsetAttribute:e._offsetAttribute})}};export default PolygonOutlineGeometry;