import protobuf from"../ThirdParty/protobufjs.js";import when from"../ThirdParty/when.js";import buildModuleUrl from"./buildModuleUrl.js";import Check from"./Check.js";import Credit from"./Credit.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import GoogleEarthEnterpriseTileInformation from"./GoogleEarthEnterpriseTileInformation.js";import isBitSet from"./isBitSet.js";import loadAndExecuteScript from"./loadAndExecuteScript.js";import CesiumMath from"./Math.js";import Request from"./Request.js";import Resource from"./Resource.js";import RuntimeError from"./RuntimeError.js";import TaskProcessor from"./TaskProcessor.js";function stringToBuffer(e){for(var t=e.length,r=new ArrayBuffer(t),o=new Uint8Array(r),i=0;i<t;++i)o[i]=e.charCodeAt(i);return r}var defaultKey=stringToBuffer('EÃ´Â½\vyÃ¢jE"Â’,ÃqÃ¸IFgQ\0B%Ã†Ã¨a,f)\bÃ†4Ãœjb%y\nwmiÃ–Ã°ÂœkÂ“Â¡Â½NuÃ A[ÃŸ@V\fÃ™Â»rÂ›Â|3SÃ®OlÃ”qÂ°{Ã€EVZÂ­wUe\v3Â’*Â¬l5Ã…0sÃ¸3>mF8JÂ´ÃÃ°.ÃuÃšÂŒDt"Ãºa"\f3"SoÂ¯9D\vÂŒ9Ã™9LÂ¹Â¿Â«\\ÂŒP_ÂŸ"uxÃ©qÂ‘h;ÃÃ„Â›Ã°<VqHÂ‚\'UfYNeÂ˜uÂ£aF}a?A\0ÂŸÃ—Â´4MÃÂ‡FÂ°Ã•Â¸ÂŠ\'{Â‹Ãœ+Â»Mg0ÃˆÃ‘Ã¶\\ÂPÃº[/FÂ›n5/\'C.Ã«\n\f^Â¥se4Ã¥l.jC\'c#UÂ©?q{gC}:Â¯ÃÃ¢TUÂœÃ½KÃ†Ã¢ÂŸ/(Ã­Ã‹\\Ã†-fÂˆÂ§;/*"NÂ°k.Ã\rÂ•}}GÂºCÂ²Â²+>MÂª>}Ã¦ÃIÂ‰Ã†Ã¦x\fa1-Â¤OÂ¥~q ÂˆÃ¬\r1Ã¨N\v\0nPh}=\b\rÂ•Â¦nÂ£hÂ—$[kÃ³#Ã³Â¶sÂ³\r\v@Ã€ÂŸÃ˜Q]Ãº".jÃŸI\0Â¹Â wUÃ†Ã¯jÂ¿{GLÂƒÃ®ÃœÃœFÂ…Â©Â­S+S4Ã¿Â”YÃ¤8Ã¨1ÂƒNÂ¹XFkÃ‹-#Â†Â’p\x005Âˆ"Ã1Â²&/Ã§Ãƒu-6,rtÂ°#GÂ·Ã“Ã‘&Â…7rÃ¢\0ÂŒDÃÃš3-Ã`Â†i#i*|ÃKQ\rÂ•T9w.)ÃªÂ¦PÂ¢jÂoPÂ™\\>TÃ»Ã¯P[\vEÂ‰m(w7Ã›ÂJfJoÂ™ Ã¥pÃ¢Â¹q~\fmI-zÃ¾rÃ‡Ã²Y0ÂÂ»]sÃ¥Ã‰ ÃªxÃ¬ ÂÃ°ÂŠB|G`Â°Â½&Â·qÂ¶Ã‡ÂŸÃ‘3Â‚=Ã“Â«Ã®cÂ™Ãˆ+SÂ D\\qÃ†ÃŒD2O<ÃŠÃ€)=RÃ“aXÂ©}eÂ´ÃœÃ\rÃ´=Ã±\bÂ©BÃš#\tÃ˜Â¿^PIÃ¸MÃ€Ã‹GLOÃ·{+Ã˜Ã…1Â’;ÂµoÃœl\rÂ’ÂˆÃ‘ÂÃ›?Ã¢Ã©Ãš_Ã”Â„Ã¢FaZÃUÃÂ¤\0Â¾Ã½ÃgÃ±JiÂ—Ã¦ HÃ˜]~Â®q NÂ®Ã€VÂ©Â‘<Â‚rÃ§vÃ¬)IÃ–]-ÂƒÃ£Ã›6Â©;fÂ—Â‡jÃ•Â¶=P^RÂ¹KÃ‡sWxÃ‰Ã´.YÂ•Â“oÃKW>\'\'Ã‡`Ã›;Ã­ÂšSD>?ÂÂ’mwÂ¢\nÃ«?RÂ¨Ã†U^1I7Â…Ã´Ã…&-Â©Â¿Â‹\'TÃšÃƒj Ã¥*xÂ°Ã–ÂprÂªÂ‹hÂ½ÂˆÃ·_HÂ±~Ã€XL?fÃ¹>Ã¡eÃ€pÂ§Ã8iÂ¯Ã°VldIÂœ\'Â­xtOÃ‚Â‡ÃV9\0Ãšw\vÃ‹-Â‰Ã»5OÃµ\bQ`Ã\nZGM&30xÃšÃ€ÂœFGÃ¢[y`In7gS\n>Ã©Ã¬F9Â²Ã±4\rÃ†Â„SunÃ¡\fYÃ™Ã)Â…{IIÂ¥wyÂ¾IV.6Ã§\v:Â»Ob{Ã’M1Â•/Â½8{Â¨O!Ã¡Ã¬FpvÂ•})"xÂˆ\nÂÃÂ\\ÃšÃQÃÃ°Ã¼YRe|3ÃŸÃ³HÃšÂ»*uÃ›`Â²Ã”Ã¼Ã­Ã¬5Â¨Ã¿(1-ÃˆÃœÂˆF|ÂŠ["');function GoogleEarthEnterpriseMetadata(e){Check.defined("resourceOrUrl",e);var t=e;"string"==typeof t||t instanceof Resource||(Check.typeOf.string("resourceOrUrl.url",e.url),t=e.url);var r=Resource.createIfNeeded(t);r.appendForwardSlash(),this._resource=r,this.imageryPresent=!0,this.protoImagery=void 0,this.terrainPresent=!0,this.negativeAltitudeExponentBias=32,this.negativeAltitudeThreshold=CesiumMath.EPSILON12,this.providers={},this.key=void 0,this._quadPacketVersion=1,this._tileInfo={},this._subtreePromises={};var o=this;this._readyPromise=requestDbRoot(this).then((function(){return o.getQuadTreePacket("",o._quadPacketVersion)})).then((function(){return!0})).otherwise((function(e){var t="An error occurred while accessing "+getMetadataResource(o,"",1).url+".";return when.reject(new RuntimeError(t))}))}Object.defineProperties(GoogleEarthEnterpriseMetadata.prototype,{url:{get:function(){return this._resource.url}},proxy:{get:function(){return this._resource.proxy}},resource:{get:function(){return this._resource}},readyPromise:{get:function(){return this._readyPromise}}}),GoogleEarthEnterpriseMetadata.tileXYToQuadKey=function(e,t,r){for(var o="",i=r;i>=0;--i){var n=1<<i,a=0;isBitSet(t,n)?isBitSet(e,n)&&(a|=1):(a|=2,isBitSet(e,n)||(a|=1)),o+=a}return o},GoogleEarthEnterpriseMetadata.quadKeyToTileXY=function(e){for(var t=0,r=0,o=e.length-1,i=o;i>=0;--i){var n=1<<i,a=+e[o-i];isBitSet(a,2)?isBitSet(a,1)||(t|=n):(r|=n,isBitSet(a,1)&&(t|=n))}return{x:t,y:r,level:o}},GoogleEarthEnterpriseMetadata.prototype.isValid=function(e){var t=this.getTileInformationFromQuadKey(e);if(defined(t))return null!==t;for(var r,o=!0,i=e;i.length>1;){if(r=i.substring(i.length-1),i=i.substring(0,i.length-1),t=this.getTileInformationFromQuadKey(i),defined(t)){t.hasSubtree()||t.hasChild(parseInt(r))||(o=!1);break}if(null===t){o=!1;break}}return o};var dbrootParser,dbrootParserPromise,taskProcessor=new TaskProcessor("decodeGoogleEarthEnterprisePacket");function populateSubtree(e,t,r){var o,i=e._tileInfo,n=t,a=i[n];if(defined(a)&&(!a.hasSubtree()||a.hasChildren()))return a;for(;void 0===a&&n.length>1;)a=i[n=n.substring(0,n.length-1)];var s=e._subtreePromises,u=s[n];return defined(u)?u.then((function(){return o=new Request({throttle:r.throttle,throttleByServer:r.throttleByServer,type:r.type,priorityFunction:r.priorityFunction}),populateSubtree(e,t,o)})):defined(a)&&a.hasSubtree()?(u=e.getQuadTreePacket(n,a.cnodeVersion,r),defined(u)?(s[n]=u,u.then((function(){return o=new Request({throttle:r.throttle,throttleByServer:r.throttleByServer,type:r.type,priorityFunction:r.priorityFunction}),populateSubtree(e,t,o)})).always((function(){delete s[n]}))):void 0):when.reject(new RuntimeError("Couldn't load metadata for tile "+t))}function getMetadataResource(e,t,r,o){return e._resource.getDerivedResource({url:"flatfile?q2-0"+t+"-q."+r.toString(),request:o})}function requestDbRoot(e){var t=e._resource.getDerivedResource({url:"dbRoot.v5",queryParameters:{output:"proto"}});if(!defined(dbrootParserPromise)){var r=buildModuleUrl("ThirdParty/google-earth-dbroot-parser.js"),o=window.cesiumGoogleEarthDbRootParser;dbrootParserPromise=loadAndExecuteScript(r).then((function(){dbrootParser=window.cesiumGoogleEarthDbRootParser(protobuf),defined(o)?window.cesiumGoogleEarthDbRootParser=o:delete window.cesiumGoogleEarthDbRootParser}))}return dbrootParserPromise.then((function(){return t.fetchArrayBuffer()})).then((function(t){var r=dbrootParser.EncryptedDbRootProto.decode(new Uint8Array(t)),o=r.encryptionData,i=o.byteOffset,n=i+o.byteLength,a=e.key=o.buffer.slice(i,n);n=(i=(o=r.dbrootData).byteOffset)+o.byteLength;var s=o.buffer.slice(i,n);return taskProcessor.scheduleTask({buffer:s,type:"DbRoot",key:a},[s])})).then((function(t){var r=dbrootParser.DbRootProto.decode(new Uint8Array(t.buffer));if(e.imageryPresent=defaultValue(r.imageryPresent,e.imageryPresent),e.protoImagery=r.protoImagery,e.terrainPresent=defaultValue(r.terrainPresent,e.terrainPresent),defined(r.endSnippet)&&defined(r.endSnippet.model)){var o=r.endSnippet.model;e.negativeAltitudeExponentBias=defaultValue(o.negativeAltitudeExponentBias,e.negativeAltitudeExponentBias),e.negativeAltitudeThreshold=defaultValue(o.compressedNegativeAltitudeThreshold,e.negativeAltitudeThreshold)}defined(r.databaseVersion)&&(e._quadPacketVersion=defaultValue(r.databaseVersion.quadtreeVersion,e._quadPacketVersion));for(var i=e.providers,n=defaultValue(r.providerInfo,[]),a=n.length,s=0;s<a;++s){var u=n[s],d=u.copyrightString;defined(d)&&(i[u.providerId]=new Credit(d.value))}})).otherwise((function(){console.log("Failed to retrieve "+t.url+". Using defaults."),e.key=defaultKey}))}GoogleEarthEnterpriseMetadata.prototype.getQuadTreePacket=function(e,t,r){t=defaultValue(t,1);var o=getMetadataResource(this,e=defaultValue(e,""),t,r).fetchArrayBuffer();if(defined(o)){var i=this._tileInfo,n=this.key;return o.then((function(t){return taskProcessor.scheduleTask({buffer:t,quadKey:e,type:"Metadata",key:n},[t]).then((function(t){var r,o=-1;if(""!==e){o=e.length+1;var n=t[e];(r=i[e])._bits|=n._bits,delete t[e]}var a=Object.keys(t);a.sort((function(e,t){return e.length-t.length}));for(var s=a.length,u=0;u<s;++u){var d=a[u];if(null!==t[d]){var l=GoogleEarthEnterpriseTileInformation.clone(t[d]),f=d.length;if(f===o)l.setParent(r);else if(f>1){var h=i[d.substring(0,d.length-1)];l.setParent(h)}i[d]=l}else i[d]=null}}))}))}},GoogleEarthEnterpriseMetadata.prototype.populateSubtree=function(e,t,r,o){return populateSubtree(this,GoogleEarthEnterpriseMetadata.tileXYToQuadKey(e,t,r),o)},GoogleEarthEnterpriseMetadata.prototype.getTileInformation=function(e,t,r){var o=GoogleEarthEnterpriseMetadata.tileXYToQuadKey(e,t,r);return this._tileInfo[o]},GoogleEarthEnterpriseMetadata.prototype.getTileInformationFromQuadKey=function(e){return this._tileInfo[e]};export default GoogleEarthEnterpriseMetadata;