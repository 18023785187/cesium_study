import protobuf from"../ThirdParty/protobufjs.js";import when from"../ThirdParty/when.js";import buildModuleUrl from"./buildModuleUrl.js";import Check from"./Check.js";import Credit from"./Credit.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import GoogleEarthEnterpriseTileInformation from"./GoogleEarthEnterpriseTileInformation.js";import isBitSet from"./isBitSet.js";import loadAndExecuteScript from"./loadAndExecuteScript.js";import CesiumMath from"./Math.js";import Request from"./Request.js";import Resource from"./Resource.js";import RuntimeError from"./RuntimeError.js";import TaskProcessor from"./TaskProcessor.js";function stringToBuffer(e){for(var t=e.length,r=new ArrayBuffer(t),o=new Uint8Array(r),i=0;i<t;++i)o[i]=e.charCodeAt(i);return r}var defaultKey=stringToBuffer('Eô½\vyâjE",ÍqøIFgQ\0B%Æèa,f)\bÆ4Üjb%y\nwmiÖðk¡½NuàA[ß@V\fÙ»r|3SîOlÔq°{ÀEVZ­wUe\v3*¬l5Å0sø3>mF8J´Ýð.ÝuÚDt"úa"\f3"So¯9D\v9Ù9L¹¿«\\P_"uxéqh;ÁÄð<VqH\'UfYNeu£aF}a?A\0×´4MÎF°Õ¸\'{Ü+»Mg0ÈÑö\\Pú[/Fn5/\'C.ë\n\f^¥se4ål.jC\'c#U©?q{gC}:¯ÍâTUýKÆâ/(íË\\Æ-f§;/*"N°k.Ý\r}}GºC²²+>Mª>}æÎIÆæx\fa1-¤O¥~q ì\r1èN\v\0nPh}=\b\r¦n£h$[kó#ó¶s³\r\v@ÀØQ]ú".jßI\0¹ wUÆïj¿{GLîÜÜF©­S+S4ÿYä8è1N¹XFkË-#p\x005"Ï1²&/çÃu-6,rt°#G·ÓÑ&7râ\0DÏÚ3-Þ`i#i*|ÍKQ\rT9w.)ê¦P¢joP\\>TûïP[\vEm(w7ÛJfJo åpâ¹q~\fmI-zþrÇòY0»]såÉ êxì ðB|G`°½&·q¶ÇÑ3=Ó«îcÈ+S D\\qÆÌD2O<ÊÀ)=RÓaX©}e´ÜÏ\rô=ñ\b©BÚ#\tØ¿^PIøMÀËGLO÷{+ØÅ1;µoÜl\rÑÛ?âéÚ_ÔâFaZÞUÏ¤\0¾ýÎgñJiæ HØ]~®q N®ÀV©<rçvì)IÖ]-ãÛ6©;fjÕ¶=P^R¹KÇsWxÉô.YoÐKW>\'\'Ç`Û;íSD>?mw¢\në?R¨ÆU^1I7ôÅ&-©¿\'TÚÃj å*x°Öprªh½÷_H±~ÀXL?fù>áeÀp§Ï8i¯ðVldI\'­xtOÂÞV9\0Úw\vË-û5Oõ\bQ`Á\nZGM&30xÚÀFGâ[y`In7gS\n>éìF9²ñ4\rÆSuná\fYÙÞ){II¥wy¾IV.6ç\v:»Ob{ÒM1/½8{¨O!áìFpv})"x\nÝ\\ÚÞQÏðüYRe|3ßóHÚ»*uÛ`²Ôüíì5¨ÿ(1-ÈÜF|["');function GoogleEarthEnterpriseMetadata(e){Check.defined("resourceOrUrl",e);var t=e;"string"==typeof t||t instanceof Resource||(Check.typeOf.string("resourceOrUrl.url",e.url),t=e.url);var r=Resource.createIfNeeded(t);r.appendForwardSlash(),this._resource=r,this.imageryPresent=!0,this.protoImagery=void 0,this.terrainPresent=!0,this.negativeAltitudeExponentBias=32,this.negativeAltitudeThreshold=CesiumMath.EPSILON12,this.providers={},this.key=void 0,this._quadPacketVersion=1,this._tileInfo={},this._subtreePromises={};var o=this;this._readyPromise=requestDbRoot(this).then((function(){return o.getQuadTreePacket("",o._quadPacketVersion)})).then((function(){return!0})).otherwise((function(e){var t="An error occurred while accessing "+getMetadataResource(o,"",1).url+".";return when.reject(new RuntimeError(t))}))}Object.defineProperties(GoogleEarthEnterpriseMetadata.prototype,{url:{get:function(){return this._resource.url}},proxy:{get:function(){return this._resource.proxy}},resource:{get:function(){return this._resource}},readyPromise:{get:function(){return this._readyPromise}}}),GoogleEarthEnterpriseMetadata.tileXYToQuadKey=function(e,t,r){for(var o="",i=r;i>=0;--i){var n=1<<i,a=0;isBitSet(t,n)?isBitSet(e,n)&&(a|=1):(a|=2,isBitSet(e,n)||(a|=1)),o+=a}return o},GoogleEarthEnterpriseMetadata.quadKeyToTileXY=function(e){for(var t=0,r=0,o=e.length-1,i=o;i>=0;--i){var n=1<<i,a=+e[o-i];isBitSet(a,2)?isBitSet(a,1)||(t|=n):(r|=n,isBitSet(a,1)&&(t|=n))}return{x:t,y:r,level:o}},GoogleEarthEnterpriseMetadata.prototype.isValid=function(e){var t=this.getTileInformationFromQuadKey(e);if(defined(t))return null!==t;for(var r,o=!0,i=e;i.length>1;){if(r=i.substring(i.length-1),i=i.substring(0,i.length-1),t=this.getTileInformationFromQuadKey(i),defined(t)){t.hasSubtree()||t.hasChild(parseInt(r))||(o=!1);break}if(null===t){o=!1;break}}return o};var dbrootParser,dbrootParserPromise,taskProcessor=new TaskProcessor("decodeGoogleEarthEnterprisePacket");function populateSubtree(e,t,r){var o,i=e._tileInfo,n=t,a=i[n];if(defined(a)&&(!a.hasSubtree()||a.hasChildren()))return a;for(;void 0===a&&n.length>1;)a=i[n=n.substring(0,n.length-1)];var s=e._subtreePromises,u=s[n];return defined(u)?u.then((function(){return o=new Request({throttle:r.throttle,throttleByServer:r.throttleByServer,type:r.type,priorityFunction:r.priorityFunction}),populateSubtree(e,t,o)})):defined(a)&&a.hasSubtree()?(u=e.getQuadTreePacket(n,a.cnodeVersion,r),defined(u)?(s[n]=u,u.then((function(){return o=new Request({throttle:r.throttle,throttleByServer:r.throttleByServer,type:r.type,priorityFunction:r.priorityFunction}),populateSubtree(e,t,o)})).always((function(){delete s[n]}))):void 0):when.reject(new RuntimeError("Couldn't load metadata for tile "+t))}function getMetadataResource(e,t,r,o){return e._resource.getDerivedResource({url:"flatfile?q2-0"+t+"-q."+r.toString(),request:o})}function requestDbRoot(e){var t=e._resource.getDerivedResource({url:"dbRoot.v5",queryParameters:{output:"proto"}});if(!defined(dbrootParserPromise)){var r=buildModuleUrl("ThirdParty/google-earth-dbroot-parser.js"),o=window.cesiumGoogleEarthDbRootParser;dbrootParserPromise=loadAndExecuteScript(r).then((function(){dbrootParser=window.cesiumGoogleEarthDbRootParser(protobuf),defined(o)?window.cesiumGoogleEarthDbRootParser=o:delete window.cesiumGoogleEarthDbRootParser}))}return dbrootParserPromise.then((function(){return t.fetchArrayBuffer()})).then((function(t){var r=dbrootParser.EncryptedDbRootProto.decode(new Uint8Array(t)),o=r.encryptionData,i=o.byteOffset,n=i+o.byteLength,a=e.key=o.buffer.slice(i,n);n=(i=(o=r.dbrootData).byteOffset)+o.byteLength;var s=o.buffer.slice(i,n);return taskProcessor.scheduleTask({buffer:s,type:"DbRoot",key:a},[s])})).then((function(t){var r=dbrootParser.DbRootProto.decode(new Uint8Array(t.buffer));if(e.imageryPresent=defaultValue(r.imageryPresent,e.imageryPresent),e.protoImagery=r.protoImagery,e.terrainPresent=defaultValue(r.terrainPresent,e.terrainPresent),defined(r.endSnippet)&&defined(r.endSnippet.model)){var o=r.endSnippet.model;e.negativeAltitudeExponentBias=defaultValue(o.negativeAltitudeExponentBias,e.negativeAltitudeExponentBias),e.negativeAltitudeThreshold=defaultValue(o.compressedNegativeAltitudeThreshold,e.negativeAltitudeThreshold)}defined(r.databaseVersion)&&(e._quadPacketVersion=defaultValue(r.databaseVersion.quadtreeVersion,e._quadPacketVersion));for(var i=e.providers,n=defaultValue(r.providerInfo,[]),a=n.length,s=0;s<a;++s){var u=n[s],d=u.copyrightString;defined(d)&&(i[u.providerId]=new Credit(d.value))}})).otherwise((function(){console.log("Failed to retrieve "+t.url+". Using defaults."),e.key=defaultKey}))}GoogleEarthEnterpriseMetadata.prototype.getQuadTreePacket=function(e,t,r){t=defaultValue(t,1);var o=getMetadataResource(this,e=defaultValue(e,""),t,r).fetchArrayBuffer();if(defined(o)){var i=this._tileInfo,n=this.key;return o.then((function(t){return taskProcessor.scheduleTask({buffer:t,quadKey:e,type:"Metadata",key:n},[t]).then((function(t){var r,o=-1;if(""!==e){o=e.length+1;var n=t[e];(r=i[e])._bits|=n._bits,delete t[e]}var a=Object.keys(t);a.sort((function(e,t){return e.length-t.length}));for(var s=a.length,u=0;u<s;++u){var d=a[u];if(null!==t[d]){var l=GoogleEarthEnterpriseTileInformation.clone(t[d]),f=d.length;if(f===o)l.setParent(r);else if(f>1){var h=i[d.substring(0,d.length-1)];l.setParent(h)}i[d]=l}else i[d]=null}}))}))}},GoogleEarthEnterpriseMetadata.prototype.populateSubtree=function(e,t,r,o){return populateSubtree(this,GoogleEarthEnterpriseMetadata.tileXYToQuadKey(e,t,r),o)},GoogleEarthEnterpriseMetadata.prototype.getTileInformation=function(e,t,r){var o=GoogleEarthEnterpriseMetadata.tileXYToQuadKey(e,t,r);return this._tileInfo[o]},GoogleEarthEnterpriseMetadata.prototype.getTileInformationFromQuadKey=function(e){return this._tileInfo[e]};export default GoogleEarthEnterpriseMetadata;