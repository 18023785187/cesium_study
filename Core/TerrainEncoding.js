import AttributeCompression from"./AttributeCompression.js";import Cartesian2 from"./Cartesian2.js";import Cartesian3 from"./Cartesian3.js";import ComponentDatatype from"./ComponentDatatype.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import CesiumMath from"./Math.js";import Matrix4 from"./Matrix4.js";import TerrainExaggeration from"./TerrainExaggeration.js";import TerrainQuantization from"./TerrainQuantization.js";var cartesian3Scratch=new Cartesian3,cartesian3DimScratch=new Cartesian3,cartesian2Scratch=new Cartesian2,matrix4Scratch=new Matrix4,matrix4Scratch2=new Matrix4,SHIFT_LEFT_12=Math.pow(2,12);function TerrainEncoding(t,e,a,r,i,n,o,s,c,m){var h,d,u=TerrainQuantization.NONE;if(defined(e)&&defined(a)&&defined(r)&&defined(i)){var f=e.minimum,l=e.maximum,x=Cartesian3.subtract(l,f,cartesian3DimScratch),p=r-a;u=Math.max(Cartesian3.maximumComponent(x),p)<SHIFT_LEFT_12-1?TerrainQuantization.BITS12:TerrainQuantization.NONE,h=Matrix4.inverseTransformation(i,new Matrix4);var S=Cartesian3.negate(f,cartesian3Scratch);Matrix4.multiply(Matrix4.fromTranslation(S,matrix4Scratch),h,h);var g=cartesian3Scratch;g.x=1/x.x,g.y=1/x.y,g.z=1/x.z,Matrix4.multiply(Matrix4.fromScale(g,matrix4Scratch),h,h),d=Matrix4.clone(i),Matrix4.setTranslation(d,Cartesian3.ZERO,d),i=Matrix4.clone(i,new Matrix4);var T=Matrix4.fromTranslation(f,matrix4Scratch),N=Matrix4.fromScale(x,matrix4Scratch2),C=Matrix4.multiply(T,N,matrix4Scratch);Matrix4.multiply(i,C,i),Matrix4.multiply(d,C,d)}this.quantization=u,this.minimumHeight=a,this.maximumHeight=r,this.center=Cartesian3.clone(t),this.toScaledENU=h,this.fromScaledENU=i,this.matrix=d,this.hasVertexNormals=n,this.hasWebMercatorT=defaultValue(o,!1),this.hasGeodeticSurfaceNormals=defaultValue(s,!1),this.exaggeration=defaultValue(c,1),this.exaggerationRelativeHeight=defaultValue(m,0),this.stride=0,this._offsetGeodeticSurfaceNormal=0,this._offsetVertexNormal=0,this._calculateStrideAndOffsets()}TerrainEncoding.prototype.encode=function(t,e,a,r,i,n,o,s){var c=r.x,m=r.y;if(this.quantization===TerrainQuantization.BITS12){(a=Matrix4.multiplyByPoint(this.toScaledENU,a,cartesian3Scratch)).x=CesiumMath.clamp(a.x,0,1),a.y=CesiumMath.clamp(a.y,0,1),a.z=CesiumMath.clamp(a.z,0,1);var h=this.maximumHeight-this.minimumHeight,d=CesiumMath.clamp((i-this.minimumHeight)/h,0,1);Cartesian2.fromElements(a.x,a.y,cartesian2Scratch);var u=AttributeCompression.compressTextureCoordinates(cartesian2Scratch);Cartesian2.fromElements(a.z,d,cartesian2Scratch);var f=AttributeCompression.compressTextureCoordinates(cartesian2Scratch);Cartesian2.fromElements(c,m,cartesian2Scratch);var l=AttributeCompression.compressTextureCoordinates(cartesian2Scratch);if(t[e++]=u,t[e++]=f,t[e++]=l,this.hasWebMercatorT){Cartesian2.fromElements(o,0,cartesian2Scratch);var x=AttributeCompression.compressTextureCoordinates(cartesian2Scratch);t[e++]=x}}else Cartesian3.subtract(a,this.center,cartesian3Scratch),t[e++]=cartesian3Scratch.x,t[e++]=cartesian3Scratch.y,t[e++]=cartesian3Scratch.z,t[e++]=i,t[e++]=c,t[e++]=m,this.hasWebMercatorT&&(t[e++]=o);return this.hasVertexNormals&&(t[e++]=AttributeCompression.octPackFloat(n)),this.hasGeodeticSurfaceNormals&&(t[e++]=s.x,t[e++]=s.y,t[e++]=s.z),e};var scratchPosition=new Cartesian3,scratchGeodeticSurfaceNormal=new Cartesian3;TerrainEncoding.prototype.addGeodeticSurfaceNormals=function(t,e,a){if(!this.hasGeodeticSurfaceNormals){var r=this.stride,i=t.length/r;this.hasGeodeticSurfaceNormals=!0,this._calculateStrideAndOffsets();for(var n=this.stride,o=0;o<i;o++){for(var s=0;s<r;s++){var c=o*r+s;e[o*n+s]=t[c]}var m=this.decodePosition(e,o,scratchPosition),h=a.geodeticSurfaceNormal(m,scratchGeodeticSurfaceNormal),d=o*n+this._offsetGeodeticSurfaceNormal;e[d]=h.x,e[d+1]=h.y,e[d+2]=h.z}}},TerrainEncoding.prototype.removeGeodeticSurfaceNormals=function(t,e){if(this.hasGeodeticSurfaceNormals){var a=this.stride,r=t.length/a;this.hasGeodeticSurfaceNormals=!1,this._calculateStrideAndOffsets();for(var i=this.stride,n=0;n<r;n++)for(var o=0;o<i;o++){var s=n*a+o;e[n*i+o]=t[s]}}},TerrainEncoding.prototype.decodePosition=function(t,e,a){if(defined(a)||(a=new Cartesian3),e*=this.stride,this.quantization===TerrainQuantization.BITS12){var r=AttributeCompression.decompressTextureCoordinates(t[e],cartesian2Scratch);a.x=r.x,a.y=r.y;var i=AttributeCompression.decompressTextureCoordinates(t[e+1],cartesian2Scratch);return a.z=i.x,Matrix4.multiplyByPoint(this.fromScaledENU,a,a)}return a.x=t[e],a.y=t[e+1],a.z=t[e+2],Cartesian3.add(a,this.center,a)},TerrainEncoding.prototype.getExaggeratedPosition=function(t,e,a){a=this.decodePosition(t,e,a);var r=this.exaggeration,i=this.exaggerationRelativeHeight;if(1!==r&&this.hasGeodeticSurfaceNormals){var n=this.decodeGeodeticSurfaceNormal(t,e,scratchGeodeticSurfaceNormal),o=this.decodeHeight(t,e),s=TerrainExaggeration.getHeight(o,r,i)-o;a.x+=n.x*s,a.y+=n.y*s,a.z+=n.z*s}return a},TerrainEncoding.prototype.decodeTextureCoordinates=function(t,e,a){return defined(a)||(a=new Cartesian2),e*=this.stride,this.quantization===TerrainQuantization.BITS12?AttributeCompression.decompressTextureCoordinates(t[e+2],a):Cartesian2.fromElements(t[e+4],t[e+5],a)},TerrainEncoding.prototype.decodeHeight=function(t,e){return e*=this.stride,this.quantization===TerrainQuantization.BITS12?AttributeCompression.decompressTextureCoordinates(t[e+1],cartesian2Scratch).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight:t[e+3]},TerrainEncoding.prototype.decodeWebMercatorT=function(t,e){return e*=this.stride,this.quantization===TerrainQuantization.BITS12?AttributeCompression.decompressTextureCoordinates(t[e+3],cartesian2Scratch).x:t[e+6]},TerrainEncoding.prototype.getOctEncodedNormal=function(t,e,a){var r=t[e=e*this.stride+this._offsetVertexNormal]/256,i=Math.floor(r),n=256*(r-i);return Cartesian2.fromElements(i,n,a)},TerrainEncoding.prototype.decodeGeodeticSurfaceNormal=function(t,e,a){return e=e*this.stride+this._offsetGeodeticSurfaceNormal,a.x=t[e],a.y=t[e+1],a.z=t[e+2],a},TerrainEncoding.prototype._calculateStrideAndOffsets=function(){var t=0;this.quantization===TerrainQuantization.BITS12?t+=3:t+=6,this.hasWebMercatorT&&(t+=1),this.hasVertexNormals&&(this._offsetVertexNormal=t,t+=1),this.hasGeodeticSurfaceNormals&&(this._offsetGeodeticSurfaceNormal=t,t+=3),this.stride=t};var attributesIndicesNone={position3DAndHeight:0,textureCoordAndEncodedNormals:1,geodeticSurfaceNormal:2},attributesIndicesBits12={compressed0:0,compressed1:1,geodeticSurfaceNormal:2};TerrainEncoding.prototype.getAttributes=function(t){var e=ComponentDatatype.FLOAT,a=ComponentDatatype.getSizeInBytes(e),r=this.stride*a,i=0,n=[];function o(o,s){n.push({index:o,vertexBuffer:t,componentDatatype:e,componentsPerAttribute:s,offsetInBytes:i,strideInBytes:r}),i+=s*a}if(this.quantization===TerrainQuantization.NONE){o(attributesIndicesNone.position3DAndHeight,4);var s=2;s+=this.hasWebMercatorT?1:0,s+=this.hasVertexNormals?1:0,o(attributesIndicesNone.textureCoordAndEncodedNormals,s),this.hasGeodeticSurfaceNormals&&o(attributesIndicesNone.geodeticSurfaceNormal,3)}else{var c=this.hasWebMercatorT||this.hasVertexNormals,m=this.hasWebMercatorT&&this.hasVertexNormals;o(attributesIndicesBits12.compressed0,c?4:3),m&&o(attributesIndicesBits12.compressed1,1),this.hasGeodeticSurfaceNormals&&o(attributesIndicesBits12.geodeticSurfaceNormal,3)}return n},TerrainEncoding.prototype.getAttributeLocations=function(){return this.quantization===TerrainQuantization.NONE?attributesIndicesNone:attributesIndicesBits12},TerrainEncoding.clone=function(t,e){if(defined(t))return defined(e)||(e=new TerrainEncoding),e.quantization=t.quantization,e.minimumHeight=t.minimumHeight,e.maximumHeight=t.maximumHeight,e.center=Cartesian3.clone(t.center),e.toScaledENU=Matrix4.clone(t.toScaledENU),e.fromScaledENU=Matrix4.clone(t.fromScaledENU),e.matrix=Matrix4.clone(t.matrix),e.hasVertexNormals=t.hasVertexNormals,e.hasWebMercatorT=t.hasWebMercatorT,e.hasGeodeticSurfaceNormals=t.hasGeodeticSurfaceNormals,e.exaggeration=t.exaggeration,e.exaggerationRelativeHeight=t.exaggerationRelativeHeight,e._calculateStrideAndOffsets(),e};export default TerrainEncoding;