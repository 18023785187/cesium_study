import when from"../ThirdParty/when.js";import Credit from"./Credit.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import Event from"./Event.js";import GeographicTilingScheme from"./GeographicTilingScheme.js";import GoogleEarthEnterpriseMetadata from"./GoogleEarthEnterpriseMetadata.js";import GoogleEarthEnterpriseTerrainData from"./GoogleEarthEnterpriseTerrainData.js";import HeightmapTerrainData from"./HeightmapTerrainData.js";import JulianDate from"./JulianDate.js";import CesiumMath from"./Math.js";import Rectangle from"./Rectangle.js";import Request from"./Request.js";import RequestState from"./RequestState.js";import RequestType from"./RequestType.js";import Resource from"./Resource.js";import RuntimeError from"./RuntimeError.js";import TaskProcessor from"./TaskProcessor.js";import TileProviderError from"./TileProviderError.js";var TerrainState={UNKNOWN:0,NONE:1,SELF:2,PARENT:3},julianDateScratch=new JulianDate;function TerrainCache(){this._terrainCache={},this._lastTidy=JulianDate.now()}function GoogleEarthEnterpriseTerrainProvider(e){if(e=defaultValue(e,defaultValue.EMPTY_OBJECT),!defined(e.url)&&!defined(e.metadata))throw new DeveloperError("options.url or options.metadata is required.");var r;if(defined(e.metadata))r=e.metadata;else{var t=Resource.createIfNeeded(e.url);r=new GoogleEarthEnterpriseMetadata(t)}this._metadata=r,this._tilingScheme=new GeographicTilingScheme({numberOfLevelZeroTilesX:2,numberOfLevelZeroTilesY:2,rectangle:new Rectangle(-CesiumMath.PI,-CesiumMath.PI,CesiumMath.PI,CesiumMath.PI),ellipsoid:e.ellipsoid});var i=e.credit;"string"==typeof i&&(i=new Credit(i)),this._credit=i,this._levelZeroMaximumGeometricError=40075.16,this._terrainCache=new TerrainCache,this._terrainPromises={},this._terrainRequests={},this._errorEvent=new Event,this._ready=!1;var a,n=this;this._readyPromise=r.readyPromise.then((function(e){if(!r.terrainPresent){var t=new RuntimeError("The server "+r.url+" doesn't have terrain");return a=TileProviderError.handleError(a,n,n._errorEvent,t.message,void 0,void 0,void 0,t),when.reject(t)}return TileProviderError.handleSuccess(a),n._ready=e,e})).otherwise((function(e){return a=TileProviderError.handleError(a,n,n._errorEvent,e.message,void 0,void 0,void 0,e),when.reject(e)}))}TerrainCache.prototype.add=function(e,r){this._terrainCache[e]={buffer:r,timestamp:JulianDate.now()}},TerrainCache.prototype.get=function(e){var r=this._terrainCache[e];if(defined(r))return delete this._terrainCache[e],r.buffer},TerrainCache.prototype.tidy=function(){if(JulianDate.now(julianDateScratch),JulianDate.secondsDifference(julianDateScratch,this._lastTidy)>10){for(var e=this._terrainCache,r=Object.keys(e),t=r.length,i=0;i<t;++i){var a=r[i],n=e[a];JulianDate.secondsDifference(julianDateScratch,n.timestamp)>10&&delete e[a]}JulianDate.clone(julianDateScratch,this._lastTidy)}},Object.defineProperties(GoogleEarthEnterpriseTerrainProvider.prototype,{url:{get:function(){return this._metadata.url}},proxy:{get:function(){return this._metadata.proxy}},tilingScheme:{get:function(){if(!this._ready)throw new DeveloperError("tilingScheme must not be called before the imagery provider is ready.");return this._tilingScheme}},errorEvent:{get:function(){return this._errorEvent}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise}},credit:{get:function(){return this._credit}},hasWaterMask:{get:function(){return!1}},hasVertexNormals:{get:function(){return!1}},availability:{get:function(){}}});var taskProcessor=new TaskProcessor("decodeGoogleEarthEnterprisePacket");function computeChildMask(e,r,t){var i=r.getChildBitmask();if(r.terrainState===TerrainState.PARENT){i=0;for(var a=0;a<4;++a){var n=t.getTileInformationFromQuadKey(e+a.toString());defined(n)&&n.hasTerrain()&&(i|=1<<a)}}return i}function buildTerrainResource(e,r,t,i){return t=defined(t)&&t>0?t:1,e._metadata.resource.getDerivedResource({url:"flatfile?f1c-0"+r+"-t."+t.toString(),request:i})}GoogleEarthEnterpriseTerrainProvider.prototype.requestTileGeometry=function(e,r,t,i){if(!this._ready)throw new DeveloperError("requestTileGeometry must not be called before the terrain provider is ready.");var a=GoogleEarthEnterpriseMetadata.tileXYToQuadKey(e,r,t),n=this._terrainCache,o=this._metadata,s=o.getTileInformationFromQuadKey(a);if(!defined(s))return when.reject(new RuntimeError("Terrain tile doesn't exist"));var d=s.terrainState;defined(d)||(d=s.terrainState=TerrainState.UNKNOWN);var u,l=n.get(a);if(defined(l)){var h=o.providers[s.terrainProvider];return when.resolve(new GoogleEarthEnterpriseTerrainData({buffer:l,childTileMask:computeChildMask(a,s,o),credits:defined(h)?[h]:void 0,negativeAltitudeExponentBias:o.negativeAltitudeExponentBias,negativeElevationThreshold:o.negativeAltitudeThreshold}))}if(n.tidy(),!s.ancestorHasTerrain)return when.resolve(new HeightmapTerrainData({buffer:new Uint8Array(256),width:16,height:16}));if(d===TerrainState.NONE)return when.reject(new RuntimeError("Terrain tile doesn't exist"));var f=a,c=-1;switch(d){case TerrainState.SELF:c=s.terrainVersion;break;case TerrainState.PARENT:f=f.substring(0,f.length-1),c=(u=o.getTileInformationFromQuadKey(f)).terrainVersion;break;case TerrainState.UNKNOWN:s.hasTerrain()?c=s.terrainVersion:(f=f.substring(0,f.length-1),u=o.getTileInformationFromQuadKey(f),defined(u)&&u.hasTerrain()&&(c=u.terrainVersion))}if(c<0)return when.reject(new RuntimeError("Terrain tile doesn't exist"));var m,v,T=this._terrainPromises,p=this._terrainRequests;if(defined(T[f]))m=T[f],v=p[f];else{var E=buildTerrainResource(this,f,c,v=i).fetchArrayBuffer();if(!defined(E))return;m=E.then((function(e){return defined(e)?taskProcessor.scheduleTask({buffer:e,type:"Terrain",key:o.key},[e]).then((function(e){var r=o.getTileInformationFromQuadKey(f);r.terrainState=TerrainState.SELF,n.add(f,e[0]);for(var t=r.terrainProvider,i=e.length-1,a=0;a<i;++a){var s=f+a.toString(),d=o.getTileInformationFromQuadKey(s);defined(d)&&(n.add(s,e[a+1]),d.terrainState=TerrainState.PARENT,0===d.terrainProvider&&(d.terrainProvider=t))}})):when.reject(new RuntimeError("Failed to load terrain."))})),T[f]=m,p[f]=v,m=m.always((function(){delete T[f],delete p[f]}))}return m.then((function(){var e=n.get(a);if(defined(e)){var r=o.providers[s.terrainProvider];return new GoogleEarthEnterpriseTerrainData({buffer:e,childTileMask:computeChildMask(a,s,o),credits:defined(r)?[r]:void 0,negativeAltitudeExponentBias:o.negativeAltitudeExponentBias,negativeElevationThreshold:o.negativeAltitudeThreshold})}return when.reject(new RuntimeError("Failed to load terrain."))})).otherwise((function(e){return v.state===RequestState.CANCELLED?(i.state=v.state,when.reject(e)):(s.terrainState=TerrainState.NONE,when.reject(e))}))},GoogleEarthEnterpriseTerrainProvider.prototype.getLevelMaximumGeometricError=function(e){return this._levelZeroMaximumGeometricError/(1<<e)},GoogleEarthEnterpriseTerrainProvider.prototype.getTileDataAvailable=function(e,r,t){var i=this._metadata,a=GoogleEarthEnterpriseMetadata.tileXYToQuadKey(e,r,t),n=i.getTileInformation(e,r,t);if(null===n)return!1;if(defined(n)){if(!n.ancestorHasTerrain)return!0;var o=n.terrainState;if(o===TerrainState.NONE)return!1;if(!(defined(o)&&o!==TerrainState.UNKNOWN||(n.terrainState=TerrainState.UNKNOWN,n.hasTerrain()))){a=a.substring(0,a.length-1);var s=i.getTileInformationFromQuadKey(a);if(!defined(s)||!s.hasTerrain())return!1}return!0}if(i.isValid(a)){var d=new Request({throttle:!1,throttleByServer:!0,type:RequestType.TERRAIN});i.populateSubtree(e,r,t,d)}return!1},GoogleEarthEnterpriseTerrainProvider.prototype.loadTileDataAvailability=function(e,r,t){};export default GoogleEarthEnterpriseTerrainProvider;