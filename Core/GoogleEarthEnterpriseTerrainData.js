import BoundingSphere from"./BoundingSphere.js";import Cartesian2 from"./Cartesian2.js";import Cartesian3 from"./Cartesian3.js";import Check from"./Check.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import IndexDatatype from"./IndexDatatype.js";import Intersections2D from"./Intersections2D.js";import CesiumMath from"./Math.js";import OrientedBoundingBox from"./OrientedBoundingBox.js";import QuantizedMeshTerrainData from"./QuantizedMeshTerrainData.js";import Rectangle from"./Rectangle.js";import TaskProcessor from"./TaskProcessor.js";import TerrainData from"./TerrainData.js";import TerrainEncoding from"./TerrainEncoding.js";import TerrainMesh from"./TerrainMesh.js";function GoogleEarthEnterpriseTerrainData(e){e=defaultValue(e,defaultValue.EMPTY_OBJECT),Check.typeOf.object("options.buffer",e.buffer),Check.typeOf.number("options.negativeAltitudeExponentBias",e.negativeAltitudeExponentBias),Check.typeOf.number("options.negativeElevationThreshold",e.negativeElevationThreshold),this._buffer=e.buffer,this._credits=e.credits,this._negativeAltitudeExponentBias=e.negativeAltitudeExponentBias,this._negativeElevationThreshold=e.negativeElevationThreshold;var t=defaultValue(e.childTileMask,15),i=3&t;i|=4&t?8:0,i|=8&t?4:0,this._childTileMask=i,this._createdByUpsampling=defaultValue(e.createdByUpsampling,!1),this._skirtHeight=void 0,this._bufferType=this._buffer.constructor,this._mesh=void 0,this._minimumHeight=void 0,this._maximumHeight=void 0}Object.defineProperties(GoogleEarthEnterpriseTerrainData.prototype,{credits:{get:function(){return this._credits}},waterMask:{get:function(){}}});var createMeshTaskName="createVerticesFromGoogleEarthEnterpriseBuffer",createMeshTaskProcessorNoThrottle=new TaskProcessor(createMeshTaskName),createMeshTaskProcessorThrottle=new TaskProcessor(createMeshTaskName,TerrainData.maximumAsynchronousTasks),nativeRectangleScratch=new Rectangle,rectangleScratch=new Rectangle;GoogleEarthEnterpriseTerrainData.prototype.createMesh=function(e){e=defaultValue(e,defaultValue.EMPTY_OBJECT),Check.typeOf.object("options.tilingScheme",e.tilingScheme),Check.typeOf.number("options.x",e.x),Check.typeOf.number("options.y",e.y),Check.typeOf.number("options.level",e.level);var t=e.tilingScheme,i=e.x,r=e.y,n=e.level,a=defaultValue(e.exaggeration,1),o=defaultValue(e.exaggerationRelativeHeight,0),s=defaultValue(e.throttle,!0),h=t.ellipsoid;t.tileXYToNativeRectangle(i,r,n,nativeRectangleScratch),t.tileXYToRectangle(i,r,n,rectangleScratch);var c=h.cartographicToCartesian(Rectangle.center(rectangleScratch)),d=40075.16/(1<<n);this._skirtHeight=Math.min(8*d,1e3);var l=(s?createMeshTaskProcessorThrottle:createMeshTaskProcessorNoThrottle).scheduleTask({buffer:this._buffer,nativeRectangle:nativeRectangleScratch,rectangle:rectangleScratch,relativeToCenter:c,ellipsoid:h,skirtHeight:this._skirtHeight,exaggeration:a,exaggerationRelativeHeight:o,includeWebMercatorT:!0,negativeAltitudeExponentBias:this._negativeAltitudeExponentBias,negativeElevationThreshold:this._negativeElevationThreshold});if(defined(l)){var u=this;return l.then((function(e){return u._mesh=new TerrainMesh(c,new Float32Array(e.vertices),new Uint16Array(e.indices),e.indexCountWithoutSkirts,e.vertexCountWithoutSkirts,e.minimumHeight,e.maximumHeight,BoundingSphere.clone(e.boundingSphere3D),Cartesian3.clone(e.occludeePointInScaledSpace),e.numberOfAttributes,OrientedBoundingBox.clone(e.orientedBoundingBox),TerrainEncoding.clone(e.encoding),e.westIndicesSouthToNorth,e.southIndicesEastToWest,e.eastIndicesNorthToSouth,e.northIndicesWestToEast),u._minimumHeight=e.minimumHeight,u._maximumHeight=e.maximumHeight,u._buffer=void 0,u._mesh}))}},GoogleEarthEnterpriseTerrainData.prototype.interpolateHeight=function(e,t,i){var r=CesiumMath.clamp((t-e.west)/e.width,0,1),n=CesiumMath.clamp((i-e.south)/e.height,0,1);return defined(this._mesh)?interpolateMeshHeight(this,r,n):interpolateHeight(this,r,n,e)};var upsampleTaskProcessor=new TaskProcessor("upsampleQuantizedTerrainMesh",TerrainData.maximumAsynchronousTasks);GoogleEarthEnterpriseTerrainData.prototype.upsample=function(e,t,i,r,n,a,o){if(Check.typeOf.object("tilingScheme",e),Check.typeOf.number("thisX",t),Check.typeOf.number("thisY",i),Check.typeOf.number("thisLevel",r),Check.typeOf.number("descendantX",n),Check.typeOf.number("descendantY",a),Check.typeOf.number("descendantLevel",o),o-r>1)throw new DeveloperError("Upsampling through more than one level at a time is not currently supported.");var s=this._mesh;if(defined(this._mesh)){var h=2*t!==n,c=2*i===a,d=e.ellipsoid,l=e.tileXYToRectangle(n,a,o),u=upsampleTaskProcessor.scheduleTask({vertices:s.vertices,indices:s.indices,indexCountWithoutSkirts:s.indexCountWithoutSkirts,vertexCountWithoutSkirts:s.vertexCountWithoutSkirts,encoding:s.encoding,minimumHeight:this._minimumHeight,maximumHeight:this._maximumHeight,isEastChild:h,isNorthChild:c,childRectangle:l,ellipsoid:d});if(defined(u)){var m=this;return u.then((function(e){var t=new Uint16Array(e.vertices),i=IndexDatatype.createTypedArray(t.length/3,e.indices),r=m._skirtHeight;return new QuantizedMeshTerrainData({quantizedVertices:t,indices:i,minimumHeight:e.minimumHeight,maximumHeight:e.maximumHeight,boundingSphere:BoundingSphere.clone(e.boundingSphere),orientedBoundingBox:OrientedBoundingBox.clone(e.orientedBoundingBox),horizonOcclusionPoint:Cartesian3.clone(e.horizonOcclusionPoint),westIndices:e.westIndices,southIndices:e.southIndices,eastIndices:e.eastIndices,northIndices:e.northIndices,westSkirtHeight:r,southSkirtHeight:r,eastSkirtHeight:r,northSkirtHeight:r,childTileMask:0,createdByUpsampling:!0,credits:m._credits})}))}}},GoogleEarthEnterpriseTerrainData.prototype.isChildAvailable=function(e,t,i,r){Check.typeOf.number("thisX",e),Check.typeOf.number("thisY",t),Check.typeOf.number("childX",i),Check.typeOf.number("childY",r);var n=2;return i!==2*e&&++n,r!==2*t&&(n-=2),0!=(this._childTileMask&1<<n)},GoogleEarthEnterpriseTerrainData.prototype.wasCreatedByUpsampling=function(){return this._createdByUpsampling};var texCoordScratch0=new Cartesian2,texCoordScratch1=new Cartesian2,texCoordScratch2=new Cartesian2,barycentricCoordinateScratch=new Cartesian3;function interpolateMeshHeight(e,t,i){for(var r=e._mesh,n=r.vertices,a=r.encoding,o=r.indices,s=0,h=o.length;s<h;s+=3){var c=o[s],d=o[s+1],l=o[s+2],u=a.decodeTextureCoordinates(n,c,texCoordScratch0),m=a.decodeTextureCoordinates(n,d,texCoordScratch1),g=a.decodeTextureCoordinates(n,l,texCoordScratch2),p=Intersections2D.computeBarycentricCoordinates(t,i,u.x,u.y,m.x,m.y,g.x,g.y,barycentricCoordinateScratch);if(p.x>=-1e-15&&p.y>=-1e-15&&p.z>=-1e-15){var f=a.decodeHeight(n,c),T=a.decodeHeight(n,d),v=a.decodeHeight(n,l);return p.x*f+p.y*T+p.z*v}}}var sizeOfUint16=Uint16Array.BYTES_PER_ELEMENT,sizeOfUint32=Uint32Array.BYTES_PER_ELEMENT,sizeOfInt32=Int32Array.BYTES_PER_ELEMENT,sizeOfFloat=Float32Array.BYTES_PER_ELEMENT,sizeOfDouble=Float64Array.BYTES_PER_ELEMENT;function interpolateHeight(e,t,i,r){var n=e._buffer,a=0,o=0,s=0;i>.5?(t>.5?(a=2,o=.5):a=3,s=.5):t>.5&&(a=1,o=.5);for(var h=new DataView(n),c=0,d=0;d<a;++d)c+=h.getUint32(c,!0),c+=sizeOfUint32;c+=sizeOfUint32,c+=2*sizeOfDouble;var l=CesiumMath.toRadians(180*h.getFloat64(c,!0));c+=sizeOfDouble;var u=CesiumMath.toRadians(180*h.getFloat64(c,!0));c+=sizeOfDouble;var m=r.width/l/2,g=r.height/u/2,p=h.getInt32(c,!0);c+=sizeOfInt32;var f=3*h.getInt32(c,!0);c+=sizeOfInt32,c+=sizeOfInt32;var T,v=new Array(p),E=new Array(p),y=new Array(p);for(T=0;T<p;++T)v[T]=o+h.getUint8(c++)*m,E[T]=s+h.getUint8(c++)*g,y[T]=6371010*h.getFloat32(c,!0),c+=sizeOfFloat;var C=new Array(f);for(T=0;T<f;++T)C[T]=h.getUint16(c,!0),c+=sizeOfUint16;for(T=0;T<f;T+=3){var k=C[T],x=C[T+1],S=C[T+2],_=v[k],b=v[x],O=v[S],B=E[k],M=E[x],H=E[S],w=Intersections2D.computeBarycentricCoordinates(t,i,_,B,b,M,O,H,barycentricCoordinateScratch);if(w.x>=-1e-15&&w.y>=-1e-15&&w.z>=-1e-15)return w.x*y[k]+w.y*y[x]+w.z*y[S]}}export default GoogleEarthEnterpriseTerrainData;