import Uri from"../ThirdParty/Uri.js";import when from"../ThirdParty/when.js";import buildModuleUrl from"./buildModuleUrl.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import destroyObject from"./destroyObject.js";import DeveloperError from"./DeveloperError.js";import Event from"./Event.js";import FeatureDetection from"./FeatureDetection.js";import isCrossOriginUrl from"./isCrossOriginUrl.js";import Resource from"./Resource.js";import RuntimeError from"./RuntimeError.js";function canTransferArrayBuffer(){if(!defined(TaskProcessor._canTransferArrayBuffer)){var r=new Worker(getWorkerUrl("Workers/transferTypedArrayTest.js"));r.postMessage=defaultValue(r.webkitPostMessage,r.postMessage);var e=new Int8Array([99]);try{r.postMessage({array:e},[e.buffer])}catch(r){return TaskProcessor._canTransferArrayBuffer=!1,TaskProcessor._canTransferArrayBuffer}var s=when.defer();r.onmessage=function(e){var o=e.data.array,t=defined(o)&&99===o[0];s.resolve(t),r.terminate(),TaskProcessor._canTransferArrayBuffer=t},TaskProcessor._canTransferArrayBuffer=s.promise}return TaskProcessor._canTransferArrayBuffer}var bootstrapperUrlResult,taskCompletedEvent=new Event;function completeTask(r,e){--r._activeTasks;var s=e.id;if(defined(s)){var o=r._deferreds,t=o[s];if(defined(e.error)){var a=e.error;"RuntimeError"===a.name?(a=new RuntimeError(e.error.message)).stack=e.error.stack:"DeveloperError"===a.name&&((a=new DeveloperError(e.error.message)).stack=e.error.stack),taskCompletedEvent.raiseEvent(a),t.reject(a)}else taskCompletedEvent.raiseEvent(),t.resolve(e.result);delete o[s]}}function getWorkerUrl(r){var e=buildModuleUrl(r);if(isCrossOriginUrl(e)){var s,o='importScripts("'+e+'");';try{s=new Blob([o],{type:"application/javascript"})}catch(r){var t=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder);t.append(o),s=t.getBlob("application/javascript")}e=(window.URL||window.webkitURL).createObjectURL(s)}return e}function getBootstrapperUrl(){return defined(bootstrapperUrlResult)||(bootstrapperUrlResult=getWorkerUrl("Workers/cesiumWorkerBootstrapper.js")),bootstrapperUrlResult}function createWorker(r){var e=new Worker(getBootstrapperUrl());e.postMessage=defaultValue(e.webkitPostMessage,e.postMessage);var s={loaderConfig:{paths:{Workers:buildModuleUrl("Workers")},baseUrl:buildModuleUrl.getCesiumBaseUrl().url},workerModule:r._workerPath};return e.postMessage(s),e.onmessage=function(e){completeTask(r,e.data)},e}function getWebAssemblyLoaderConfig(r,e){var s={modulePath:void 0,wasmBinaryFile:void 0,wasmBinary:void 0};if(!FeatureDetection.supportsWebAssembly()){if(!defined(e.fallbackModulePath))throw new RuntimeError("This browser does not support Web Assembly, and no backup module was provided for "+r._workerPath);return s.modulePath=buildModuleUrl(e.fallbackModulePath),when.resolve(s)}return s.modulePath=buildModuleUrl(e.modulePath),s.wasmBinaryFile=buildModuleUrl(e.wasmBinaryFile),Resource.fetchArrayBuffer({url:s.wasmBinaryFile}).then((function(r){return s.wasmBinary=r,s}))}function TaskProcessor(r,e){var s=new Uri(r);this._workerPath=0!==s.scheme().length&&0===s.fragment().length?r:TaskProcessor._workerModulePrefix+r,this._maximumActiveTasks=defaultValue(e,Number.POSITIVE_INFINITY),this._activeTasks=0,this._deferreds={},this._nextID=0}var emptyTransferableObjectArray=[];TaskProcessor.prototype.scheduleTask=function(r,e){if(defined(this._worker)||(this._worker=createWorker(this)),!(this._activeTasks>=this._maximumActiveTasks)){++this._activeTasks;var s=this;return when(canTransferArrayBuffer(),(function(o){defined(e)?o||(e.length=0):e=emptyTransferableObjectArray;var t=s._nextID++,a=when.defer();return s._deferreds[t]=a,s._worker.postMessage({id:t,parameters:r,canTransferArrayBuffer:o},e),a.promise}))}},TaskProcessor.prototype.initWebAssemblyModule=function(r){defined(this._worker)||(this._worker=createWorker(this));var e=when.defer(),s=this,o=this._worker;return getWebAssemblyLoaderConfig(this,r).then((function(r){return when(canTransferArrayBuffer(),(function(t){var a,i=r.wasmBinary;defined(i)&&t&&(a=[i]),o.onmessage=function(r){o.onmessage=function(r){completeTask(s,r.data)},e.resolve(r.data)},o.postMessage({webAssemblyConfig:r},a)}))})),e},TaskProcessor.prototype.isDestroyed=function(){return!1},TaskProcessor.prototype.destroy=function(){return defined(this._worker)&&this._worker.terminate(),destroyObject(this)},TaskProcessor.taskCompletedEvent=taskCompletedEvent,TaskProcessor._defaultWorkerModulePrefix="Workers/",TaskProcessor._workerModulePrefix=TaskProcessor._defaultWorkerModulePrefix,TaskProcessor._canTransferArrayBuffer=void 0;export default TaskProcessor;