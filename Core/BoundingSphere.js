import Cartesian3 from"./Cartesian3.js";import Cartographic from"./Cartographic.js";import Check from"./Check.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import Ellipsoid from"./Ellipsoid.js";import GeographicProjection from"./GeographicProjection.js";import Intersect from"./Intersect.js";import Interval from"./Interval.js";import CesiumMath from"./Math.js";import Matrix3 from"./Matrix3.js";import Matrix4 from"./Matrix4.js";import Rectangle from"./Rectangle.js";function BoundingSphere(e,r){this.center=Cartesian3.clone(defaultValue(e,Cartesian3.ZERO)),this.radius=defaultValue(r,0)}var fromPointsXMin=new Cartesian3,fromPointsYMin=new Cartesian3,fromPointsZMin=new Cartesian3,fromPointsXMax=new Cartesian3,fromPointsYMax=new Cartesian3,fromPointsZMax=new Cartesian3,fromPointsCurrentPos=new Cartesian3,fromPointsScratch=new Cartesian3,fromPointsRitterCenter=new Cartesian3,fromPointsMinBoxPt=new Cartesian3,fromPointsMaxBoxPt=new Cartesian3,fromPointsNaiveCenterScratch=new Cartesian3,volumeConstant=4/3*CesiumMath.PI;BoundingSphere.fromPoints=function(e,r){if(defined(r)||(r=new BoundingSphere),!defined(e)||0===e.length)return r.center=Cartesian3.clone(Cartesian3.ZERO,r.center),r.radius=0,r;var n,t=Cartesian3.clone(e[0],fromPointsCurrentPos),a=Cartesian3.clone(t,fromPointsXMin),i=Cartesian3.clone(t,fromPointsYMin),o=Cartesian3.clone(t,fromPointsZMin),s=Cartesian3.clone(t,fromPointsXMax),c=Cartesian3.clone(t,fromPointsYMax),u=Cartesian3.clone(t,fromPointsZMax),d=e.length;for(n=1;n<d;n++){Cartesian3.clone(e[n],t);var C=t.x,f=t.y,h=t.z;C<a.x&&Cartesian3.clone(t,a),C>s.x&&Cartesian3.clone(t,s),f<i.y&&Cartesian3.clone(t,i),f>c.y&&Cartesian3.clone(t,c),h<o.z&&Cartesian3.clone(t,o),h>u.z&&Cartesian3.clone(t,u)}var p=Cartesian3.magnitudeSquared(Cartesian3.subtract(s,a,fromPointsScratch)),l=Cartesian3.magnitudeSquared(Cartesian3.subtract(c,i,fromPointsScratch)),m=Cartesian3.magnitudeSquared(Cartesian3.subtract(u,o,fromPointsScratch)),S=a,g=s,x=p;l>x&&(x=l,S=i,g=c),m>x&&(x=m,S=o,g=u);var P=fromPointsRitterCenter;P.x=.5*(S.x+g.x),P.y=.5*(S.y+g.y),P.z=.5*(S.z+g.z);var y=Cartesian3.magnitudeSquared(Cartesian3.subtract(g,P,fromPointsScratch)),B=Math.sqrt(y),v=fromPointsMinBoxPt;v.x=a.x,v.y=i.y,v.z=o.z;var j=fromPointsMaxBoxPt;j.x=s.x,j.y=c.y,j.z=u.z;var w=Cartesian3.midpoint(v,j,fromPointsNaiveCenterScratch),z=0;for(n=0;n<d;n++){Cartesian3.clone(e[n],t);var M=Cartesian3.magnitude(Cartesian3.subtract(t,w,fromPointsScratch));M>z&&(z=M);var b=Cartesian3.magnitudeSquared(Cartesian3.subtract(t,P,fromPointsScratch));if(b>y){var O=Math.sqrt(b);y=(B=.5*(B+O))*B;var D=O-B;P.x=(B*P.x+D*t.x)/O,P.y=(B*P.y+D*t.y)/O,P.z=(B*P.z+D*t.z)/O}}return B<z?(Cartesian3.clone(P,r.center),r.radius=B):(Cartesian3.clone(w,r.center),r.radius=z),r};var defaultProjection=new GeographicProjection,fromRectangle2DLowerLeft=new Cartesian3,fromRectangle2DUpperRight=new Cartesian3,fromRectangle2DSouthwest=new Cartographic,fromRectangle2DNortheast=new Cartographic;BoundingSphere.fromRectangle2D=function(e,r,n){return BoundingSphere.fromRectangleWithHeights2D(e,r,0,0,n)},BoundingSphere.fromRectangleWithHeights2D=function(e,r,n,t,a){if(defined(a)||(a=new BoundingSphere),!defined(e))return a.center=Cartesian3.clone(Cartesian3.ZERO,a.center),a.radius=0,a;r=defaultValue(r,defaultProjection),Rectangle.southwest(e,fromRectangle2DSouthwest),fromRectangle2DSouthwest.height=n,Rectangle.northeast(e,fromRectangle2DNortheast),fromRectangle2DNortheast.height=t;var i=r.project(fromRectangle2DSouthwest,fromRectangle2DLowerLeft),o=r.project(fromRectangle2DNortheast,fromRectangle2DUpperRight),s=o.x-i.x,c=o.y-i.y,u=o.z-i.z;a.radius=.5*Math.sqrt(s*s+c*c+u*u);var d=a.center;return d.x=i.x+.5*s,d.y=i.y+.5*c,d.z=i.z+.5*u,a};var fromRectangle3DScratch=[];BoundingSphere.fromRectangle3D=function(e,r,n,t){if(r=defaultValue(r,Ellipsoid.WGS84),n=defaultValue(n,0),defined(t)||(t=new BoundingSphere),!defined(e))return t.center=Cartesian3.clone(Cartesian3.ZERO,t.center),t.radius=0,t;var a=Rectangle.subsample(e,r,n,fromRectangle3DScratch);return BoundingSphere.fromPoints(a,t)},BoundingSphere.fromVertices=function(e,r,n,t){if(defined(t)||(t=new BoundingSphere),!defined(e)||0===e.length)return t.center=Cartesian3.clone(Cartesian3.ZERO,t.center),t.radius=0,t;r=defaultValue(r,Cartesian3.ZERO),n=defaultValue(n,3),Check.typeOf.number.greaterThanOrEquals("stride",n,3);var a=fromPointsCurrentPos;a.x=e[0]+r.x,a.y=e[1]+r.y,a.z=e[2]+r.z;var i,o=Cartesian3.clone(a,fromPointsXMin),s=Cartesian3.clone(a,fromPointsYMin),c=Cartesian3.clone(a,fromPointsZMin),u=Cartesian3.clone(a,fromPointsXMax),d=Cartesian3.clone(a,fromPointsYMax),C=Cartesian3.clone(a,fromPointsZMax),f=e.length;for(i=0;i<f;i+=n){var h=e[i]+r.x,p=e[i+1]+r.y,l=e[i+2]+r.z;a.x=h,a.y=p,a.z=l,h<o.x&&Cartesian3.clone(a,o),h>u.x&&Cartesian3.clone(a,u),p<s.y&&Cartesian3.clone(a,s),p>d.y&&Cartesian3.clone(a,d),l<c.z&&Cartesian3.clone(a,c),l>C.z&&Cartesian3.clone(a,C)}var m=Cartesian3.magnitudeSquared(Cartesian3.subtract(u,o,fromPointsScratch)),S=Cartesian3.magnitudeSquared(Cartesian3.subtract(d,s,fromPointsScratch)),g=Cartesian3.magnitudeSquared(Cartesian3.subtract(C,c,fromPointsScratch)),x=o,P=u,y=m;S>y&&(y=S,x=s,P=d),g>y&&(y=g,x=c,P=C);var B=fromPointsRitterCenter;B.x=.5*(x.x+P.x),B.y=.5*(x.y+P.y),B.z=.5*(x.z+P.z);var v=Cartesian3.magnitudeSquared(Cartesian3.subtract(P,B,fromPointsScratch)),j=Math.sqrt(v),w=fromPointsMinBoxPt;w.x=o.x,w.y=s.y,w.z=c.z;var z=fromPointsMaxBoxPt;z.x=u.x,z.y=d.y,z.z=C.z;var M=Cartesian3.midpoint(w,z,fromPointsNaiveCenterScratch),b=0;for(i=0;i<f;i+=n){a.x=e[i]+r.x,a.y=e[i+1]+r.y,a.z=e[i+2]+r.z;var O=Cartesian3.magnitude(Cartesian3.subtract(a,M,fromPointsScratch));O>b&&(b=O);var D=Cartesian3.magnitudeSquared(Cartesian3.subtract(a,B,fromPointsScratch));if(D>v){var R=Math.sqrt(D);v=(j=.5*(j+R))*j;var q=R-j;B.x=(j*B.x+q*a.x)/R,B.y=(j*B.y+q*a.y)/R,B.z=(j*B.z+q*a.z)/R}}return j<b?(Cartesian3.clone(B,t.center),t.radius=j):(Cartesian3.clone(M,t.center),t.radius=b),t},BoundingSphere.fromEncodedCartesianVertices=function(e,r,n){if(defined(n)||(n=new BoundingSphere),!defined(e)||!defined(r)||e.length!==r.length||0===e.length)return n.center=Cartesian3.clone(Cartesian3.ZERO,n.center),n.radius=0,n;var t=fromPointsCurrentPos;t.x=e[0]+r[0],t.y=e[1]+r[1],t.z=e[2]+r[2];var a,i=Cartesian3.clone(t,fromPointsXMin),o=Cartesian3.clone(t,fromPointsYMin),s=Cartesian3.clone(t,fromPointsZMin),c=Cartesian3.clone(t,fromPointsXMax),u=Cartesian3.clone(t,fromPointsYMax),d=Cartesian3.clone(t,fromPointsZMax),C=e.length;for(a=0;a<C;a+=3){var f=e[a]+r[a],h=e[a+1]+r[a+1],p=e[a+2]+r[a+2];t.x=f,t.y=h,t.z=p,f<i.x&&Cartesian3.clone(t,i),f>c.x&&Cartesian3.clone(t,c),h<o.y&&Cartesian3.clone(t,o),h>u.y&&Cartesian3.clone(t,u),p<s.z&&Cartesian3.clone(t,s),p>d.z&&Cartesian3.clone(t,d)}var l=Cartesian3.magnitudeSquared(Cartesian3.subtract(c,i,fromPointsScratch)),m=Cartesian3.magnitudeSquared(Cartesian3.subtract(u,o,fromPointsScratch)),S=Cartesian3.magnitudeSquared(Cartesian3.subtract(d,s,fromPointsScratch)),g=i,x=c,P=l;m>P&&(P=m,g=o,x=u),S>P&&(P=S,g=s,x=d);var y=fromPointsRitterCenter;y.x=.5*(g.x+x.x),y.y=.5*(g.y+x.y),y.z=.5*(g.z+x.z);var B=Cartesian3.magnitudeSquared(Cartesian3.subtract(x,y,fromPointsScratch)),v=Math.sqrt(B),j=fromPointsMinBoxPt;j.x=i.x,j.y=o.y,j.z=s.z;var w=fromPointsMaxBoxPt;w.x=c.x,w.y=u.y,w.z=d.z;var z=Cartesian3.midpoint(j,w,fromPointsNaiveCenterScratch),M=0;for(a=0;a<C;a+=3){t.x=e[a]+r[a],t.y=e[a+1]+r[a+1],t.z=e[a+2]+r[a+2];var b=Cartesian3.magnitude(Cartesian3.subtract(t,z,fromPointsScratch));b>M&&(M=b);var O=Cartesian3.magnitudeSquared(Cartesian3.subtract(t,y,fromPointsScratch));if(O>B){var D=Math.sqrt(O);B=(v=.5*(v+D))*v;var R=D-v;y.x=(v*y.x+R*t.x)/D,y.y=(v*y.y+R*t.y)/D,y.z=(v*y.z+R*t.z)/D}}return v<M?(Cartesian3.clone(y,n.center),n.radius=v):(Cartesian3.clone(z,n.center),n.radius=M),n},BoundingSphere.fromCornerPoints=function(e,r,n){Check.typeOf.object("corner",e),Check.typeOf.object("oppositeCorner",r),defined(n)||(n=new BoundingSphere);var t=Cartesian3.midpoint(e,r,n.center);return n.radius=Cartesian3.distance(t,r),n},BoundingSphere.fromEllipsoid=function(e,r){return Check.typeOf.object("ellipsoid",e),defined(r)||(r=new BoundingSphere),Cartesian3.clone(Cartesian3.ZERO,r.center),r.radius=e.maximumRadius,r};var fromBoundingSpheresScratch=new Cartesian3;BoundingSphere.fromBoundingSpheres=function(e,r){if(defined(r)||(r=new BoundingSphere),!defined(e)||0===e.length)return r.center=Cartesian3.clone(Cartesian3.ZERO,r.center),r.radius=0,r;var n=e.length;if(1===n)return BoundingSphere.clone(e[0],r);if(2===n)return BoundingSphere.union(e[0],e[1],r);var t,a=[];for(t=0;t<n;t++)a.push(e[t].center);var i=(r=BoundingSphere.fromPoints(a,r)).center,o=r.radius;for(t=0;t<n;t++){var s=e[t];o=Math.max(o,Cartesian3.distance(i,s.center,fromBoundingSpheresScratch)+s.radius)}return r.radius=o,r};var fromOrientedBoundingBoxScratchU=new Cartesian3,fromOrientedBoundingBoxScratchV=new Cartesian3,fromOrientedBoundingBoxScratchW=new Cartesian3;BoundingSphere.fromOrientedBoundingBox=function(e,r){Check.defined("orientedBoundingBox",e),defined(r)||(r=new BoundingSphere);var n=e.halfAxes,t=Matrix3.getColumn(n,0,fromOrientedBoundingBoxScratchU),a=Matrix3.getColumn(n,1,fromOrientedBoundingBoxScratchV),i=Matrix3.getColumn(n,2,fromOrientedBoundingBoxScratchW);return Cartesian3.add(t,a,t),Cartesian3.add(t,i,t),r.center=Cartesian3.clone(e.center,r.center),r.radius=Cartesian3.magnitude(t),r},BoundingSphere.clone=function(e,r){if(defined(e))return defined(r)?(r.center=Cartesian3.clone(e.center,r.center),r.radius=e.radius,r):new BoundingSphere(e.center,e.radius)},BoundingSphere.packedLength=4,BoundingSphere.pack=function(e,r,n){Check.typeOf.object("value",e),Check.defined("array",r),n=defaultValue(n,0);var t=e.center;return r[n++]=t.x,r[n++]=t.y,r[n++]=t.z,r[n]=e.radius,r},BoundingSphere.unpack=function(e,r,n){Check.defined("array",e),r=defaultValue(r,0),defined(n)||(n=new BoundingSphere);var t=n.center;return t.x=e[r++],t.y=e[r++],t.z=e[r++],n.radius=e[r],n};var unionScratch=new Cartesian3,unionScratchCenter=new Cartesian3;BoundingSphere.union=function(e,r,n){Check.typeOf.object("left",e),Check.typeOf.object("right",r),defined(n)||(n=new BoundingSphere);var t=e.center,a=e.radius,i=r.center,o=r.radius,s=Cartesian3.subtract(i,t,unionScratch),c=Cartesian3.magnitude(s);if(a>=c+o)return e.clone(n),n;if(o>=c+a)return r.clone(n),n;var u=.5*(a+c+o),d=Cartesian3.multiplyByScalar(s,(-a+u)/c,unionScratchCenter);return Cartesian3.add(d,t,d),Cartesian3.clone(d,n.center),n.radius=u,n};var expandScratch=new Cartesian3;BoundingSphere.expand=function(e,r,n){Check.typeOf.object("sphere",e),Check.typeOf.object("point",r),n=BoundingSphere.clone(e,n);var t=Cartesian3.magnitude(Cartesian3.subtract(r,n.center,expandScratch));return t>n.radius&&(n.radius=t),n},BoundingSphere.intersectPlane=function(e,r){Check.typeOf.object("sphere",e),Check.typeOf.object("plane",r);var n=e.center,t=e.radius,a=r.normal,i=Cartesian3.dot(a,n)+r.distance;return i<-t?Intersect.OUTSIDE:i<t?Intersect.INTERSECTING:Intersect.INSIDE},BoundingSphere.transform=function(e,r,n){return Check.typeOf.object("sphere",e),Check.typeOf.object("transform",r),defined(n)||(n=new BoundingSphere),n.center=Matrix4.multiplyByPoint(r,e.center,n.center),n.radius=Matrix4.getMaximumScale(r)*e.radius,n};var distanceSquaredToScratch=new Cartesian3;BoundingSphere.distanceSquaredTo=function(e,r){Check.typeOf.object("sphere",e),Check.typeOf.object("cartesian",r);var n=Cartesian3.subtract(e.center,r,distanceSquaredToScratch),t=Cartesian3.magnitude(n)-e.radius;return t<=0?0:t*t},BoundingSphere.transformWithoutScale=function(e,r,n){return Check.typeOf.object("sphere",e),Check.typeOf.object("transform",r),defined(n)||(n=new BoundingSphere),n.center=Matrix4.multiplyByPoint(r,e.center,n.center),n.radius=e.radius,n};var scratchCartesian3=new Cartesian3;BoundingSphere.computePlaneDistances=function(e,r,n,t){Check.typeOf.object("sphere",e),Check.typeOf.object("position",r),Check.typeOf.object("direction",n),defined(t)||(t=new Interval);var a=Cartesian3.subtract(e.center,r,scratchCartesian3),i=Cartesian3.dot(n,a);return t.start=i-e.radius,t.stop=i+e.radius,t};for(var projectTo2DNormalScratch=new Cartesian3,projectTo2DEastScratch=new Cartesian3,projectTo2DNorthScratch=new Cartesian3,projectTo2DWestScratch=new Cartesian3,projectTo2DSouthScratch=new Cartesian3,projectTo2DCartographicScratch=new Cartographic,projectTo2DPositionsScratch=new Array(8),n=0;n<8;++n)projectTo2DPositionsScratch[n]=new Cartesian3;var projectTo2DProjection=new GeographicProjection;BoundingSphere.projectTo2D=function(e,r,n){Check.typeOf.object("sphere",e);var t,a=(r=defaultValue(r,projectTo2DProjection)).ellipsoid,i=e.center,o=e.radius;t=Cartesian3.equals(i,Cartesian3.ZERO)?Cartesian3.clone(Cartesian3.UNIT_X,projectTo2DNormalScratch):a.geodeticSurfaceNormal(i,projectTo2DNormalScratch);var s=Cartesian3.cross(Cartesian3.UNIT_Z,t,projectTo2DEastScratch);Cartesian3.normalize(s,s);var c=Cartesian3.cross(t,s,projectTo2DNorthScratch);Cartesian3.normalize(c,c),Cartesian3.multiplyByScalar(t,o,t),Cartesian3.multiplyByScalar(c,o,c),Cartesian3.multiplyByScalar(s,o,s);var u=Cartesian3.negate(c,projectTo2DSouthScratch),d=Cartesian3.negate(s,projectTo2DWestScratch),C=projectTo2DPositionsScratch,f=C[0];Cartesian3.add(t,c,f),Cartesian3.add(f,s,f),f=C[1],Cartesian3.add(t,c,f),Cartesian3.add(f,d,f),f=C[2],Cartesian3.add(t,u,f),Cartesian3.add(f,d,f),f=C[3],Cartesian3.add(t,u,f),Cartesian3.add(f,s,f),Cartesian3.negate(t,t),f=C[4],Cartesian3.add(t,c,f),Cartesian3.add(f,s,f),f=C[5],Cartesian3.add(t,c,f),Cartesian3.add(f,d,f),f=C[6],Cartesian3.add(t,u,f),Cartesian3.add(f,d,f),f=C[7],Cartesian3.add(t,u,f),Cartesian3.add(f,s,f);for(var h=C.length,p=0;p<h;++p){var l=C[p];Cartesian3.add(i,l,l);var m=a.cartesianToCartographic(l,projectTo2DCartographicScratch);r.project(m,l)}var S=(i=(n=BoundingSphere.fromPoints(C,n)).center).x,g=i.y,x=i.z;return i.x=x,i.y=S,i.z=g,n},BoundingSphere.isOccluded=function(e,r){return Check.typeOf.object("sphere",e),Check.typeOf.object("occluder",r),!r.isBoundingSphereVisible(e)},BoundingSphere.equals=function(e,r){return e===r||defined(e)&&defined(r)&&Cartesian3.equals(e.center,r.center)&&e.radius===r.radius},BoundingSphere.prototype.intersectPlane=function(e){return BoundingSphere.intersectPlane(this,e)},BoundingSphere.prototype.distanceSquaredTo=function(e){return BoundingSphere.distanceSquaredTo(this,e)},BoundingSphere.prototype.computePlaneDistances=function(e,r,n){return BoundingSphere.computePlaneDistances(this,e,r,n)},BoundingSphere.prototype.isOccluded=function(e){return BoundingSphere.isOccluded(this,e)},BoundingSphere.prototype.equals=function(e){return BoundingSphere.equals(this,e)},BoundingSphere.prototype.clone=function(e){return BoundingSphere.clone(this,e)},BoundingSphere.prototype.volume=function(){var e=this.radius;return volumeConstant*e*e*e};export default BoundingSphere;