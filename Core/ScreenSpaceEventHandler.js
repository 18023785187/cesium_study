import AssociativeArray from"./AssociativeArray.js";import Cartesian2 from"./Cartesian2.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import destroyObject from"./destroyObject.js";import DeveloperError from"./DeveloperError.js";import FeatureDetection from"./FeatureDetection.js";import getTimestamp from"./getTimestamp.js";import KeyboardEventModifier from"./KeyboardEventModifier.js";import ScreenSpaceEventType from"./ScreenSpaceEventType.js";function getPosition(e,t,n){var o=e._element;if(o===document)return n.x=t.clientX,n.y=t.clientY,n;var i=o.getBoundingClientRect();return n.x=t.clientX-i.left,n.y=t.clientY-i.top,n}function getInputEventKey(e,t){var n=e;return defined(t)&&(n+="+"+t),n}function getModifier(e){return e.shiftKey?KeyboardEventModifier.SHIFT:e.ctrlKey?KeyboardEventModifier.CTRL:e.altKey?KeyboardEventModifier.ALT:void 0}var MouseButton={LEFT:0,MIDDLE:1,RIGHT:2};function registerListener(e,t,n,o){function i(t){o(e,t)}FeatureDetection.isInternetExplorer()?n.addEventListener(t,i,!1):n.addEventListener(t,i,{capture:!1,passive:!1}),e._removalFunctions.push((function(){n.removeEventListener(t,i,!1)}))}function registerListeners(e){var t=e._element,n=defined(t.disableRootEvents)?t:document;FeatureDetection.supportsPointerEvents()?(registerListener(e,"pointerdown",t,handlePointerDown),registerListener(e,"pointerup",t,handlePointerUp),registerListener(e,"pointermove",t,handlePointerMove),registerListener(e,"pointercancel",t,handlePointerUp)):(registerListener(e,"mousedown",t,handleMouseDown),registerListener(e,"mouseup",n,handleMouseUp),registerListener(e,"mousemove",n,handleMouseMove),registerListener(e,"touchstart",t,handleTouchStart),registerListener(e,"touchend",n,handleTouchEnd),registerListener(e,"touchmove",n,handleTouchMove),registerListener(e,"touchcancel",n,handleTouchEnd)),registerListener(e,"dblclick",t,handleDblClick),registerListener(e,"onwheel"in t?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll",t,handleWheel)}function unregisterListeners(e){for(var t=e._removalFunctions,n=0;n<t.length;++n)t[n]()}var mouseDownEvent={position:new Cartesian2};function gotTouchEvent(e){e._lastSeenTouchEvent=getTimestamp()}function canProcessMouseEvent(e){return getTimestamp()-e._lastSeenTouchEvent>ScreenSpaceEventHandler.mouseEmulationIgnoreMilliseconds}function checkPixelTolerance(e,t,n){var o=e.x-t.x,i=e.y-t.y;return Math.sqrt(o*o+i*i)<n}function handleMouseDown(e,t){if(canProcessMouseEvent(e)){var n,o=t.button;if(e._buttonDown[o]=!0,o===MouseButton.LEFT)n=ScreenSpaceEventType.LEFT_DOWN;else if(o===MouseButton.MIDDLE)n=ScreenSpaceEventType.MIDDLE_DOWN;else{if(o!==MouseButton.RIGHT)return;n=ScreenSpaceEventType.RIGHT_DOWN}var i=getPosition(e,t,e._primaryPosition);Cartesian2.clone(i,e._primaryStartPosition),Cartesian2.clone(i,e._primaryPreviousPosition);var r=getModifier(t),s=e.getInputAction(n,r);defined(s)&&(Cartesian2.clone(i,mouseDownEvent.position),s(mouseDownEvent),t.preventDefault())}}var mouseUpEvent={position:new Cartesian2},mouseClickEvent={position:new Cartesian2};function cancelMouseEvent(e,t,n,o){var i=getModifier(o),r=e.getInputAction(t,i),s=e.getInputAction(n,i);if(defined(r)||defined(s)){var a=getPosition(e,o,e._primaryPosition);defined(r)&&(Cartesian2.clone(a,mouseUpEvent.position),r(mouseUpEvent)),defined(s)&&checkPixelTolerance(e._primaryStartPosition,a,e._clickPixelTolerance)&&(Cartesian2.clone(a,mouseClickEvent.position),s(mouseClickEvent))}}function handleMouseUp(e,t){if(canProcessMouseEvent(e)){var n=t.button;n!==MouseButton.LEFT&&n!==MouseButton.MIDDLE&&n!==MouseButton.RIGHT||(e._buttonDown[MouseButton.LEFT]&&(cancelMouseEvent(e,ScreenSpaceEventType.LEFT_UP,ScreenSpaceEventType.LEFT_CLICK,t),e._buttonDown[MouseButton.LEFT]=!1),e._buttonDown[MouseButton.MIDDLE]&&(cancelMouseEvent(e,ScreenSpaceEventType.MIDDLE_UP,ScreenSpaceEventType.MIDDLE_CLICK,t),e._buttonDown[MouseButton.MIDDLE]=!1),e._buttonDown[MouseButton.RIGHT]&&(cancelMouseEvent(e,ScreenSpaceEventType.RIGHT_UP,ScreenSpaceEventType.RIGHT_CLICK,t),e._buttonDown[MouseButton.RIGHT]=!1))}}var mouseMoveEvent={startPosition:new Cartesian2,endPosition:new Cartesian2};function handleMouseMove(e,t){if(canProcessMouseEvent(e)){var n=getModifier(t),o=getPosition(e,t,e._primaryPosition),i=e._primaryPreviousPosition,r=e.getInputAction(ScreenSpaceEventType.MOUSE_MOVE,n);defined(r)&&(Cartesian2.clone(i,mouseMoveEvent.startPosition),Cartesian2.clone(o,mouseMoveEvent.endPosition),r(mouseMoveEvent)),Cartesian2.clone(o,i),(e._buttonDown[MouseButton.LEFT]||e._buttonDown[MouseButton.MIDDLE]||e._buttonDown[MouseButton.RIGHT])&&t.preventDefault()}}var mouseDblClickEvent={position:new Cartesian2};function handleDblClick(e,t){var n;if(t.button===MouseButton.LEFT){n=ScreenSpaceEventType.LEFT_DOUBLE_CLICK;var o=getModifier(t),i=e.getInputAction(n,o);defined(i)&&(getPosition(e,t,mouseDblClickEvent.position),i(mouseDblClickEvent))}}function handleWheel(e,t){var n;if(defined(t.deltaY)){var o=t.deltaMode;n=o===t.DOM_DELTA_PIXEL?-t.deltaY:o===t.DOM_DELTA_LINE?40*-t.deltaY:120*-t.deltaY}else n=t.detail>0?-120*t.detail:t.wheelDelta;if(defined(n)){var i=getModifier(t),r=e.getInputAction(ScreenSpaceEventType.WHEEL,i);defined(r)&&(r(n),t.preventDefault())}}function handleTouchStart(e,t){gotTouchEvent(e);var n,o,i,r=t.changedTouches,s=r.length,a=e._positions;for(n=0;n<s;++n)i=(o=r[n]).identifier,a.set(i,getPosition(e,o,new Cartesian2));fireTouchEvents(e,t);var c=e._previousPositions;for(n=0;n<s;++n)i=(o=r[n]).identifier,c.set(i,Cartesian2.clone(a.get(i)))}function handleTouchEnd(e,t){gotTouchEvent(e);var n,o,i=t.changedTouches,r=i.length,s=e._positions;for(n=0;n<r;++n)o=i[n].identifier,s.remove(o);fireTouchEvents(e,t);var a=e._previousPositions;for(n=0;n<r;++n)o=i[n].identifier,a.remove(o)}var touchStartEvent={position:new Cartesian2},touch2StartEvent={position1:new Cartesian2,position2:new Cartesian2},touchEndEvent={position:new Cartesian2},touchClickEvent={position:new Cartesian2},touchHoldEvent={position:new Cartesian2};function fireTouchEvents(e,t){var n,o,i=getModifier(t),r=e._positions,s=r.length,a=e._isPinching;if(1!==s&&e._buttonDown[MouseButton.LEFT]&&(e._buttonDown[MouseButton.LEFT]=!1,defined(e._touchHoldTimer)&&(clearTimeout(e._touchHoldTimer),e._touchHoldTimer=void 0),n=e.getInputAction(ScreenSpaceEventType.LEFT_UP,i),defined(n)&&(Cartesian2.clone(e._primaryPosition,touchEndEvent.position),n(touchEndEvent)),0!==s||e._isTouchHolding||(o=e.getInputAction(ScreenSpaceEventType.LEFT_CLICK,i),defined(o)&&checkPixelTolerance(e._primaryStartPosition,e._previousPositions.values[0],e._clickPixelTolerance)&&(Cartesian2.clone(e._primaryPosition,touchClickEvent.position),o(touchClickEvent))),e._isTouchHolding=!1),0===s&&a&&(e._isPinching=!1,n=e.getInputAction(ScreenSpaceEventType.PINCH_END,i),defined(n)&&n()),1===s&&!a){var c=r.values[0];Cartesian2.clone(c,e._primaryPosition),Cartesian2.clone(c,e._primaryStartPosition),Cartesian2.clone(c,e._primaryPreviousPosition),e._buttonDown[MouseButton.LEFT]=!0,n=e.getInputAction(ScreenSpaceEventType.LEFT_DOWN,i),defined(n)&&(Cartesian2.clone(c,touchStartEvent.position),n(touchStartEvent)),e._touchHoldTimer=setTimeout((function(){e.isDestroyed()||(e._touchHoldTimer=void 0,e._isTouchHolding=!0,o=e.getInputAction(ScreenSpaceEventType.RIGHT_CLICK,i),defined(o)&&checkPixelTolerance(e._primaryStartPosition,e._previousPositions.values[0],e._holdPixelTolerance)&&(Cartesian2.clone(e._primaryPosition,touchHoldEvent.position),o(touchHoldEvent)))}),ScreenSpaceEventHandler.touchHoldDelayMilliseconds),t.preventDefault()}2!==s||a||(e._isPinching=!0,n=e.getInputAction(ScreenSpaceEventType.PINCH_START,i),defined(n)&&(Cartesian2.clone(r.values[0],touch2StartEvent.position1),Cartesian2.clone(r.values[1],touch2StartEvent.position2),n(touch2StartEvent),t.preventDefault()))}function handleTouchMove(e,t){gotTouchEvent(e);var n,o,i,r=t.changedTouches,s=r.length,a=e._positions;for(n=0;n<s;++n){i=(o=r[n]).identifier;var c=a.get(i);defined(c)&&getPosition(e,o,c)}fireTouchMoveEvents(e,t);var u=e._previousPositions;for(n=0;n<s;++n)i=(o=r[n]).identifier,Cartesian2.clone(a.get(i),u.get(i))}var touchMoveEvent={startPosition:new Cartesian2,endPosition:new Cartesian2},touchPinchMovementEvent={distance:{startPosition:new Cartesian2,endPosition:new Cartesian2},angleAndHeight:{startPosition:new Cartesian2,endPosition:new Cartesian2}};function fireTouchMoveEvents(e,t){var n,o=getModifier(t),i=e._positions,r=e._previousPositions,s=i.length;if(1===s&&e._buttonDown[MouseButton.LEFT]){var a=i.values[0];Cartesian2.clone(a,e._primaryPosition);var c=e._primaryPreviousPosition;n=e.getInputAction(ScreenSpaceEventType.MOUSE_MOVE,o),defined(n)&&(Cartesian2.clone(c,touchMoveEvent.startPosition),Cartesian2.clone(a,touchMoveEvent.endPosition),n(touchMoveEvent)),Cartesian2.clone(a,c),t.preventDefault()}else if(2===s&&e._isPinching&&(n=e.getInputAction(ScreenSpaceEventType.PINCH_MOVE,o),defined(n))){var u=i.values[0],v=i.values[1],l=r.values[0],p=r.values[1],d=v.x-u.x,E=v.y-u.y,h=.25*Math.sqrt(d*d+E*E),f=p.x-l.x,m=p.y-l.y,T=.25*Math.sqrt(f*f+m*m),_=.125*(v.y+u.y),M=.125*(p.y+l.y),P=Math.atan2(E,d),g=Math.atan2(m,f);Cartesian2.fromElements(0,T,touchPinchMovementEvent.distance.startPosition),Cartesian2.fromElements(0,h,touchPinchMovementEvent.distance.endPosition),Cartesian2.fromElements(g,M,touchPinchMovementEvent.angleAndHeight.startPosition),Cartesian2.fromElements(P,_,touchPinchMovementEvent.angleAndHeight.endPosition),n(touchPinchMovementEvent)}}function handlePointerDown(e,t){if(t.target.setPointerCapture(t.pointerId),"touch"===t.pointerType){var n=e._positions,o=t.pointerId;n.set(o,getPosition(e,t,new Cartesian2)),fireTouchEvents(e,t),e._previousPositions.set(o,Cartesian2.clone(n.get(o)))}else handleMouseDown(e,t)}function handlePointerUp(e,t){if("touch"===t.pointerType){var n=e._positions,o=t.pointerId;n.remove(o),fireTouchEvents(e,t),e._previousPositions.remove(o)}else handleMouseUp(e,t)}function handlePointerMove(e,t){if("touch"===t.pointerType){var n=e._positions,o=t.pointerId,i=n.get(o);if(!defined(i))return;getPosition(e,t,i),fireTouchMoveEvents(e,t);var r=e._previousPositions;Cartesian2.clone(n.get(o),r.get(o))}else handleMouseMove(e,t)}function ScreenSpaceEventHandler(e){this._inputEvents={},this._buttonDown={LEFT:!1,MIDDLE:!1,RIGHT:!1},this._isPinching=!1,this._isTouchHolding=!1,this._lastSeenTouchEvent=-ScreenSpaceEventHandler.mouseEmulationIgnoreMilliseconds,this._primaryStartPosition=new Cartesian2,this._primaryPosition=new Cartesian2,this._primaryPreviousPosition=new Cartesian2,this._positions=new AssociativeArray,this._previousPositions=new AssociativeArray,this._removalFunctions=[],this._touchHoldTimer=void 0,this._clickPixelTolerance=5,this._holdPixelTolerance=25,this._element=defaultValue(e,document),registerListeners(this)}ScreenSpaceEventHandler.prototype.setInputAction=function(e,t,n){if(!defined(e))throw new DeveloperError("action is required.");if(!defined(t))throw new DeveloperError("type is required.");var o=getInputEventKey(t,n);this._inputEvents[o]=e},ScreenSpaceEventHandler.prototype.getInputAction=function(e,t){if(!defined(e))throw new DeveloperError("type is required.");var n=getInputEventKey(e,t);return this._inputEvents[n]},ScreenSpaceEventHandler.prototype.removeInputAction=function(e,t){if(!defined(e))throw new DeveloperError("type is required.");var n=getInputEventKey(e,t);delete this._inputEvents[n]},ScreenSpaceEventHandler.prototype.isDestroyed=function(){return!1},ScreenSpaceEventHandler.prototype.destroy=function(){return unregisterListeners(this),destroyObject(this)},ScreenSpaceEventHandler.mouseEmulationIgnoreMilliseconds=800,ScreenSpaceEventHandler.touchHoldDelayMilliseconds=1500;export default ScreenSpaceEventHandler;