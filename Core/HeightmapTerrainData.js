import when from"../ThirdParty/when.js";import BoundingSphere from"./BoundingSphere.js";import Cartesian3 from"./Cartesian3.js";import Check from"./Check.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import GeographicProjection from"./GeographicProjection.js";import HeightmapEncoding from"./HeightmapEncoding.js";import HeightmapTessellator from"./HeightmapTessellator.js";import CesiumMath from"./Math.js";import OrientedBoundingBox from"./OrientedBoundingBox.js";import Rectangle from"./Rectangle.js";import TaskProcessor from"./TaskProcessor.js";import TerrainData from"./TerrainData.js";import TerrainEncoding from"./TerrainEncoding.js";import TerrainMesh from"./TerrainMesh.js";import TerrainProvider from"./TerrainProvider.js";function HeightmapTerrainData(e){if(!defined(e)||!defined(e.buffer))throw new DeveloperError("options.buffer is required.");if(!defined(e.width))throw new DeveloperError("options.width is required.");if(!defined(e.height))throw new DeveloperError("options.height is required.");this._buffer=e.buffer,this._width=e.width,this._height=e.height,this._childTileMask=defaultValue(e.childTileMask,15),this._encoding=defaultValue(e.encoding,HeightmapEncoding.NONE);var t=HeightmapTessellator.DEFAULT_STRUCTURE,i=e.structure;defined(i)?i!==t&&(i.heightScale=defaultValue(i.heightScale,t.heightScale),i.heightOffset=defaultValue(i.heightOffset,t.heightOffset),i.elementsPerHeight=defaultValue(i.elementsPerHeight,t.elementsPerHeight),i.stride=defaultValue(i.stride,t.stride),i.elementMultiplier=defaultValue(i.elementMultiplier,t.elementMultiplier),i.isBigEndian=defaultValue(i.isBigEndian,t.isBigEndian)):i=t,this._structure=i,this._createdByUpsampling=defaultValue(e.createdByUpsampling,!1),this._waterMask=e.waterMask,this._skirtHeight=void 0,this._bufferType=this._encoding===HeightmapEncoding.LERC?Float32Array:this._buffer.constructor,this._mesh=void 0}Object.defineProperties(HeightmapTerrainData.prototype,{credits:{get:function(){}},waterMask:{get:function(){return this._waterMask}},childTileMask:{get:function(){return this._childTileMask}}});var createMeshTaskName="createVerticesFromHeightmap",createMeshTaskProcessorNoThrottle=new TaskProcessor(createMeshTaskName),createMeshTaskProcessorThrottle=new TaskProcessor(createMeshTaskName,TerrainData.maximumAsynchronousTasks);function interpolateHeight(e,t,i,r,n,o,h,a,s,d){var g=(s-o.west)*(h-1)/(o.east-o.west),l=(d-o.south)*(a-1)/(o.north-o.south),c=0|g,u=c+1;u>=h&&(u=h-1,c=h-2);var p=0|l,f=p+1;return f>=a&&(f=a-1,p=a-2),f=a-1-f,triangleInterpolateHeight(g-c,l-p,getHeight(e,t,i,r,n,(p=a-1-p)*h+c),getHeight(e,t,i,r,n,p*h+u),getHeight(e,t,i,r,n,f*h+c),getHeight(e,t,i,r,n,f*h+u))}function interpolateMeshHeight(e,t,i,r,n,o,h,a,s){var d=(a-n.west)*(o-1)/(n.east-n.west),g=(s-n.south)*(h-1)/(n.north-n.south),l=0|d,c=l+1;c>=o&&(c=o-1,l=o-2);var u=0|g,p=u+1;p>=h&&(p=h-1,u=h-2);var f=g-u;return u=h-1-u,p=h-1-p,triangleInterpolateHeight(d-l,f,(t.decodeHeight(e,u*o+l)-i)/r,(t.decodeHeight(e,u*o+c)-i)/r,(t.decodeHeight(e,p*o+l)-i)/r,(t.decodeHeight(e,p*o+c)-i)/r)}function triangleInterpolateHeight(e,t,i,r,n,o){return t<e?i+e*(r-i)+t*(o-r):i+e*(o-n)+t*(n-i)}function getHeight(e,t,i,r,n,o){o*=r;var h,a=0;if(n)for(h=0;h<t;++h)a=a*i+e[o+h];else for(h=t-1;h>=0;--h)a=a*i+e[o+h];return a}function setHeight(e,t,i,r,n,o,h,a){var s;if(h*=n,o)for(s=0;s<t-1;++s)e[h+s]=a/r|0,a-=e[h+s]*r,r/=i;else for(s=t-1;s>0;--s)e[h+s]=a/r|0,a-=e[h+s]*r,r/=i;e[h+s]=a}HeightmapTerrainData.prototype.createMesh=function(e){e=defaultValue(e,defaultValue.EMPTY_OBJECT),Check.typeOf.object("options.tilingScheme",e.tilingScheme),Check.typeOf.number("options.x",e.x),Check.typeOf.number("options.y",e.y),Check.typeOf.number("options.level",e.level);var t=e.tilingScheme,i=e.x,r=e.y,n=e.level,o=defaultValue(e.exaggeration,1),h=defaultValue(e.exaggerationRelativeHeight,0),a=defaultValue(e.throttle,!0),s=t.ellipsoid,d=t.tileXYToNativeRectangle(i,r,n),g=t.tileXYToRectangle(i,r,n),l=s.cartographicToCartesian(Rectangle.center(g)),c=this._structure,u=TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(s,this._width,t.getNumberOfXTilesAtLevel(0))/(1<<n);this._skirtHeight=Math.min(4*u,1e3);var p=(a?createMeshTaskProcessorThrottle:createMeshTaskProcessorNoThrottle).scheduleTask({heightmap:this._buffer,structure:c,includeWebMercatorT:!0,width:this._width,height:this._height,nativeRectangle:d,rectangle:g,relativeToCenter:l,ellipsoid:s,skirtHeight:this._skirtHeight,isGeographic:t.projection instanceof GeographicProjection,exaggeration:o,exaggerationRelativeHeight:h,encoding:this._encoding});if(defined(p)){var f=this;return when(p,(function(e){var t;t=f._skirtHeight>0?TerrainProvider.getRegularGridAndSkirtIndicesAndEdgeIndices(e.gridWidth,e.gridHeight):TerrainProvider.getRegularGridIndicesAndEdgeIndices(e.gridWidth,e.gridHeight);var i=e.gridWidth*e.gridHeight;return f._mesh=new TerrainMesh(l,new Float32Array(e.vertices),t.indices,t.indexCountWithoutSkirts,i,e.minimumHeight,e.maximumHeight,BoundingSphere.clone(e.boundingSphere3D),Cartesian3.clone(e.occludeePointInScaledSpace),e.numberOfAttributes,OrientedBoundingBox.clone(e.orientedBoundingBox),TerrainEncoding.clone(e.encoding),t.westIndicesSouthToNorth,t.southIndicesEastToWest,t.eastIndicesNorthToSouth,t.northIndicesWestToEast),f._buffer=void 0,f._mesh}))}},HeightmapTerrainData.prototype._createMeshSync=function(e){Check.typeOf.object("options.tilingScheme",e.tilingScheme),Check.typeOf.number("options.x",e.x),Check.typeOf.number("options.y",e.y),Check.typeOf.number("options.level",e.level);var t=e.tilingScheme,i=e.x,r=e.y,n=e.level,o=defaultValue(e.exaggeration,1),h=defaultValue(e.exaggerationRelativeHeight,0),a=t.ellipsoid,s=t.tileXYToNativeRectangle(i,r,n),d=t.tileXYToRectangle(i,r,n),g=a.cartographicToCartesian(Rectangle.center(d)),l=this._structure,c=TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(a,this._width,t.getNumberOfXTilesAtLevel(0))/(1<<n);this._skirtHeight=Math.min(4*c,1e3);var u,p=HeightmapTessellator.computeVertices({heightmap:this._buffer,structure:l,includeWebMercatorT:!0,width:this._width,height:this._height,nativeRectangle:s,rectangle:d,relativeToCenter:g,ellipsoid:a,skirtHeight:this._skirtHeight,isGeographic:t.projection instanceof GeographicProjection,exaggeration:o,exaggerationRelativeHeight:h});this._buffer=void 0,u=this._skirtHeight>0?TerrainProvider.getRegularGridAndSkirtIndicesAndEdgeIndices(this._width,this._height):TerrainProvider.getRegularGridIndicesAndEdgeIndices(this._width,this._height);var f=p.gridWidth*p.gridHeight;return this._mesh=new TerrainMesh(g,p.vertices,u.indices,u.indexCountWithoutSkirts,f,p.minimumHeight,p.maximumHeight,p.boundingSphere3D,p.occludeePointInScaledSpace,p.encoding.stride,p.orientedBoundingBox,p.encoding,u.westIndicesSouthToNorth,u.southIndicesEastToWest,u.eastIndicesNorthToSouth,u.northIndicesWestToEast),this._mesh},HeightmapTerrainData.prototype.interpolateHeight=function(e,t,i){var r=this._width,n=this._height,o=this._structure,h=o.stride,a=o.elementsPerHeight,s=o.elementMultiplier,d=o.isBigEndian,g=o.heightOffset,l=o.heightScale,c=defined(this._mesh),u=this._encoding===HeightmapEncoding.LERC;if(c||!u)return c?interpolateMeshHeight(this._mesh.vertices,this._mesh.encoding,g,l,e,r,n,t,i):interpolateHeight(this._buffer,a,s,h,d,e,r,n,t,i)*l+g},HeightmapTerrainData.prototype.upsample=function(e,t,i,r,n,o,h){if(!defined(e))throw new DeveloperError("tilingScheme is required.");if(!defined(t))throw new DeveloperError("thisX is required.");if(!defined(i))throw new DeveloperError("thisY is required.");if(!defined(r))throw new DeveloperError("thisLevel is required.");if(!defined(n))throw new DeveloperError("descendantX is required.");if(!defined(o))throw new DeveloperError("descendantY is required.");if(!defined(h))throw new DeveloperError("descendantLevel is required.");if(h-r>1)throw new DeveloperError("Upsampling through more than one level at a time is not currently supported.");var a=this._mesh;if(defined(a)){for(var s=this._width,d=this._height,g=this._structure,l=g.stride,c=new this._bufferType(s*d*l),u=a.vertices,p=a.encoding,f=e.tileXYToRectangle(t,i,r),m=e.tileXYToRectangle(n,o,h),T=g.heightOffset,v=g.heightScale,H=g.elementsPerHeight,w=g.elementMultiplier,_=g.isBigEndian,E=Math.pow(w,H-1),k=0;k<d;++k)for(var M=CesiumMath.lerp(m.north,m.south,k/(d-1)),y=0;y<s;++y){var D=interpolateMeshHeight(u,p,T,v,f,s,d,CesiumMath.lerp(m.west,m.east,y/(s-1)),M);setHeight(c,H,w,E,l,_,k*s+y,D=(D=D<g.lowestEncodedHeight?g.lowestEncodedHeight:D)>g.highestEncodedHeight?g.highestEncodedHeight:D)}return new HeightmapTerrainData({buffer:c,width:s,height:d,childTileMask:0,structure:this._structure,createdByUpsampling:!0})}},HeightmapTerrainData.prototype.isChildAvailable=function(e,t,i,r){if(!defined(e))throw new DeveloperError("thisX is required.");if(!defined(t))throw new DeveloperError("thisY is required.");if(!defined(i))throw new DeveloperError("childX is required.");if(!defined(r))throw new DeveloperError("childY is required.");var n=2;return i!==2*e&&++n,r!==2*t&&(n-=2),0!=(this._childTileMask&1<<n)},HeightmapTerrainData.prototype.wasCreatedByUpsampling=function(){return this._createdByUpsampling};export default HeightmapTerrainData;