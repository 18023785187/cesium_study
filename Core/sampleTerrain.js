import when from"../ThirdParty/when.js";import Check from"./Check.js";function sampleTerrain(e,t,n){return Check.typeOf.object("terrainProvider",e),Check.typeOf.number("level",t),Check.defined("positions",n),e.readyPromise.then((function(){return doSampling(e,t,n)}))}function doSampling(e,t,n){var r,i=e.tilingScheme,o=[],l={};for(r=0;r<n.length;++r){var a=i.positionToTileXY(n[r],t),h=a.toString();if(!l.hasOwnProperty(h)){var c={x:a.x,y:a.y,level:t,tilingScheme:i,terrainProvider:e,positions:[]};l[h]=c,o.push(c)}l[h].positions.push(n[r])}var s=[];for(r=0;r<o.length;++r){var u=o[r],p=u.terrainProvider.requestTileGeometry(u.x,u.y,u.level).then(createInterpolateFunction(u)).otherwise(createMarkFailedFunction(u));s.push(p)}return when.all(s,(function(){return n}))}function interpolateAndAssignHeight(e,t,n){var r=t.interpolateHeight(n,e.longitude,e.latitude);return void 0!==r&&(e.height=r,!0)}function createInterpolateFunction(e){var t=e.positions,n=e.tilingScheme.tileXYToRectangle(e.x,e.y,e.level);return function(r){for(var i=!1,o=0;o<t.length;++o)if(!interpolateAndAssignHeight(t[o],r,n)){i=!0;break}return i?r.createMesh({tilingScheme:e.tilingScheme,x:e.x,y:e.y,level:e.level,throttle:!1}).then((function(){for(var e=0;e<t.length;++e)interpolateAndAssignHeight(t[e],r,n)})):when.resolve()}}function createMarkFailedFunction(e){var t=e.positions;return function(){for(var e=0;e<t.length;++e)t[e].height=void 0}}export default sampleTerrain;