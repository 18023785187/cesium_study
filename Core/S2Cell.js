import Cartesian3 from"./Cartesian3.js";import Cartographic from"./Cartographic.js";import Check from"./Check.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import Ellipsoid from"./Ellipsoid.js";import FeatureDetection from"./FeatureDetection.js";import RuntimeError from"./RuntimeError.js";var S2_MAX_LEVEL=30,S2_LIMIT_IJ=1<<S2_MAX_LEVEL,S2_MAX_SITI=1<<S2_MAX_LEVEL+1>>>0,S2_POSITION_BITS=2*S2_MAX_LEVEL+1,S2_LOOKUP_BITS=4,S2_LOOKUP_POSITIONS=[],S2_LOOKUP_IJ=[],S2_POSITION_TO_IJ=[[0,1,3,2],[0,2,3,1],[3,2,0,1],[3,1,0,2]],S2_SWAP_MASK=1,S2_INVERT_MASK=2,S2_POSITION_TO_ORIENTATION_MASK=[S2_SWAP_MASK,0,0,S2_SWAP_MASK|S2_INVERT_MASK];function S2Cell(e){if(!FeatureDetection.supportsBigInt())throw new RuntimeError("S2 required BigInt support");if(!defined(e))throw new DeveloperError("cell ID is required.");if(!S2Cell.isValidId(e))throw new DeveloperError("cell ID is invalid.");this._cellId=e,this._level=S2Cell.getLevel(e)}function getS2Center(e,t){var r=convertCellIdToFaceSiTi(e,t);return convertFaceSiTitoXYZ(r[0],r[1],r[2])}function getS2Vertex(e,t,r){var n=convertCellIdToFaceIJ(e,t),o=convertIJLeveltoBoundUV([n[1],n[2]],t),i=r>>1&1;return convertFaceUVtoXYZ(n[0],o[0][i^1&r],o[1][i])}function convertCellIdToFaceSiTi(e,t){var r=convertCellIdToFaceIJ(e),n=r[0],o=r[1],i=r[2],l=30===t,S=!l&&(BigInt(o)^e>>BigInt(2))&BigInt(1),a=l?1:S?2:0;return[n,(o<<1)+a,(i<<1)+a]}function convertCellIdToFaceIJ(e){0===S2_LOOKUP_POSITIONS.length&&generateLookupTable();for(var t=Number(e>>BigInt(S2_POSITION_BITS)),r=t&S2_SWAP_MASK,n=(1<<S2_LOOKUP_BITS)-1,o=0,i=0,l=7;l>=0;l--){var S=(1<<2*(7===l?S2_MAX_LEVEL-7*S2_LOOKUP_BITS:S2_LOOKUP_BITS))-1;r+=Number(e>>BigInt(2*l*S2_LOOKUP_BITS+1)&BigInt(S))<<2,r=S2_LOOKUP_IJ[r];var a=l*S2_LOOKUP_BITS;o+=r>>S2_LOOKUP_BITS+2<<a,i+=(r>>2&n)<<a,r&=S2_SWAP_MASK|S2_INVERT_MASK}return[t,o,i]}function convertFaceSiTitoXYZ(e,t,r){var n=convertSiTitoST(t),o=convertSiTitoST(r);return convertFaceUVtoXYZ(e,convertSTtoUV(n),convertSTtoUV(o))}function convertFaceUVtoXYZ(e,t,r){switch(e){case 0:return new Cartesian3(1,t,r);case 1:return new Cartesian3(-t,1,r);case 2:return new Cartesian3(-t,-r,1);case 3:return new Cartesian3(-1,-r,-t);case 4:return new Cartesian3(r,-1,-t);default:return new Cartesian3(r,t,-1)}}function convertSTtoUV(e){return e>=.5?1/3*(4*e*e-1):1/3*(1-4*(1-e)*(1-e))}function convertSiTitoST(e){return 1/S2_MAX_SITI*e}function convertIJLeveltoBoundUV(e,t){for(var r=[[],[]],n=getSizeIJ(t),o=0;o<2;++o){var i=e[o]&-n,l=i+n;r[o][0]=convertSTtoUV(convertIJtoSTMinimum(i)),r[o][1]=convertSTtoUV(convertIJtoSTMinimum(l))}return r}function getSizeIJ(e){return 1<<S2_MAX_LEVEL-e>>>0}function convertIJtoSTMinimum(e){return 1/S2_LIMIT_IJ*e}function generateLookupCell(e,t,r,n,o,i){if(e===S2_LOOKUP_BITS){var l=(t<<S2_LOOKUP_BITS)+r;S2_LOOKUP_POSITIONS[(l<<2)+n]=(o<<2)+i,S2_LOOKUP_IJ[(o<<2)+n]=(l<<2)+i}else{e++,t<<=1,r<<=1,o<<=2;var S=S2_POSITION_TO_IJ[i];generateLookupCell(e,t+(S[0]>>1),r+(1&S[0]),n,o,i^S2_POSITION_TO_ORIENTATION_MASK[0]),generateLookupCell(e,t+(S[1]>>1),r+(1&S[1]),n,o+1,i^S2_POSITION_TO_ORIENTATION_MASK[1]),generateLookupCell(e,t+(S[2]>>1),r+(1&S[2]),n,o+2,i^S2_POSITION_TO_ORIENTATION_MASK[2]),generateLookupCell(e,t+(S[3]>>1),r+(1&S[3]),n,o+3,i^S2_POSITION_TO_ORIENTATION_MASK[3])}}function generateLookupTable(){generateLookupCell(0,0,0,0,0,0),generateLookupCell(0,0,0,S2_SWAP_MASK,0,S2_SWAP_MASK),generateLookupCell(0,0,0,S2_INVERT_MASK,0,S2_INVERT_MASK),generateLookupCell(0,0,0,S2_SWAP_MASK|S2_INVERT_MASK,0,S2_SWAP_MASK|S2_INVERT_MASK)}function lsb(e){return e&~e+BigInt(1)}function lsbForLevel(e){return BigInt(1)<<BigInt(2*(S2_MAX_LEVEL-e))}S2Cell.fromToken=function(e){if(Check.typeOf.string("token",e),!S2Cell.isValidToken(e))throw new DeveloperError("token is invalid.");return new S2Cell(S2Cell.getIdFromToken(e))},S2Cell.isValidId=function(e){return Check.typeOf.bigint("cellId",e),!(e<=0||e>>BigInt(S2_POSITION_BITS)>5||!(e&~e+BigInt(1)&BigInt("0x1555555555555555")))},S2Cell.isValidToken=function(e){return Check.typeOf.string("token",e),!!/^[0-9a-fA-F]{1,16}$/.test(e)&&S2Cell.isValidId(S2Cell.getIdFromToken(e))},S2Cell.getIdFromToken=function(e){return Check.typeOf.string("token",e),BigInt("0x"+e+"0".repeat(16-e.length))},S2Cell.getTokenFromId=function(e){Check.typeOf.bigint("cellId",e);var t=Math.floor(countTrailingZeroBits(e)/4),r=e.toString(16).replace(/0*$/,"");return Array(17-t-r.length).join("0")+r},S2Cell.getLevel=function(e){if(Check.typeOf.bigint("cellId",e),!S2Cell.isValidId(e))throw new DeveloperError;for(var t=0;e!==BigInt(0)&&!(e&BigInt(1));)t++,e>>=BigInt(1);return S2_MAX_LEVEL-(t>>1)},S2Cell.prototype.getChild=function(e){if(Check.typeOf.number("index",e),e<0||e>3)throw new DeveloperError("child index must be in the range [0-3].");if(30===this._level)throw new DeveloperError("cannot get child of leaf cell.");var t=lsb(this._cellId)>>BigInt(2);return new S2Cell(this._cellId+BigInt(2*e+1-4)*t)},S2Cell.prototype.getParent=function(){if(0===this._level)throw new DeveloperError("cannot get parent of root cell.");var e=lsb(this._cellId)<<BigInt(2);return new S2Cell(this._cellId&~e+BigInt(1)|e)},S2Cell.prototype.getParentAtLevel=function(e){if(0===this._level||e<0||this._level<e)throw new DeveloperError("cannot get parent at invalid level.");var t=lsbForLevel(e);return new S2Cell(this._cellId&-t|t)},S2Cell.prototype.getCenter=function(e){e=defaultValue(e,Ellipsoid.WGS84);var t=getS2Center(this._cellId,this._level);t=Cartesian3.normalize(t,t);var r=new Cartographic.fromCartesian(t,Ellipsoid.UNIT_SPHERE);return Cartographic.toCartesian(r,e,new Cartesian3)},S2Cell.prototype.getVertex=function(e,t){if(Check.typeOf.number("index",e),e<0||e>3)throw new DeveloperError("vertex index must be in the range [0-3].");t=defaultValue(t,Ellipsoid.WGS84);var r=getS2Vertex(this._cellId,this._level,e);r=Cartesian3.normalize(r,r);var n=new Cartographic.fromCartesian(r,Ellipsoid.UNIT_SPHERE);return Cartographic.toCartesian(n,t,new Cartesian3)},S2Cell.fromFacePositionLevel=function(e,t,r){if(Check.typeOf.bigint("position",t),e<0||e>5)throw new DeveloperError("Invalid S2 Face (must be within 0-5)");if(r<0||r>S2_MAX_LEVEL)throw new DeveloperError("Invalid level (must be within 0-30)");if(t<0||t>=Math.pow(4,r))throw new DeveloperError("Invalid Hilbert position for level");var n=(e<4?"0":"")+(e<2?"0":"")+e.toString(2),o=t.toString(2),i=Array(2*r-o.length+1).join("0"),l=Array(S2_POSITION_BITS-2*r).join("0");return new S2Cell(BigInt("0b"+n+i+o+"1"+l))};var Mod67BitPosition=[64,0,1,39,2,15,40,23,3,12,16,59,41,19,24,54,4,64,13,10,17,62,60,28,42,30,20,51,25,44,55,47,5,32,65,38,14,22,11,58,18,53,63,9,61,27,29,50,43,46,31,37,21,57,52,8,26,49,45,36,56,7,48,35,6,34,33,0];function countTrailingZeroBits(e){return Mod67BitPosition[(-e&e)%BigInt(67)]}export default S2Cell;