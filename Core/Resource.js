import Uri from"../ThirdParty/Uri.js";import when from"../ThirdParty/when.js";import appendForwardSlash from"./appendForwardSlash.js";import Check from"./Check.js";import clone from"./clone.js";import combine from"./combine.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import getAbsoluteUri from"./getAbsoluteUri.js";import getBaseUri from"./getBaseUri.js";import getExtensionFromUri from"./getExtensionFromUri.js";import isBlobUri from"./isBlobUri.js";import isCrossOriginUrl from"./isCrossOriginUrl.js";import isDataUri from"./isDataUri.js";import loadAndExecuteScript from"./loadAndExecuteScript.js";import CesiumMath from"./Math.js";import objectToQuery from"./objectToQuery.js";import queryToObject from"./queryToObject.js";import Request from"./Request.js";import RequestErrorEvent from"./RequestErrorEvent.js";import RequestScheduler from"./RequestScheduler.js";import RequestState from"./RequestState.js";import RuntimeError from"./RuntimeError.js";import TrustedServers from"./TrustedServers.js";var supportsImageBitmapOptionsPromise,xhrBlobSupported=function(){try{var e=new XMLHttpRequest;return e.open("GET","#",!0),e.responseType="blob","blob"===e.responseType}catch(e){return!1}}();function parseQuery(e,r,t,o){var n,s=e.query();if(0===s.length)return{};if(-1===s.indexOf("=")){var i={};i[s]=void 0,n=i}else n=queryToObject(s);r._queryParameters=t?combineQueryParameters(n,r._queryParameters,o):n,e.search("")}function stringifyQuery(e,r){var t=r._queryParameters,o=Object.keys(t);1!==o.length||defined(t[o[0]])?e.search(objectToQuery(t)):e.search(o[0])}function defaultClone(e,r){return defined(e)?defined(e.clone)?e.clone():clone(e):r}function checkAndResetRequest(e){if(e.state===RequestState.ISSUED||e.state===RequestState.ACTIVE)throw new RuntimeError("The Resource is already being fetched.");e.state=RequestState.UNISSUED,e.deferred=void 0}function combineQueryParameters(e,r,t){if(!t)return combine(e,r);var o=clone(e,!0);for(var n in r)if(r.hasOwnProperty(n)){var s=o[n],i=r[n];defined(s)?(Array.isArray(s)||(s=o[n]=[s]),o[n]=s.concat(i)):o[n]=Array.isArray(i)?i.slice():i}return o}function Resource(e){"string"==typeof(e=defaultValue(e,defaultValue.EMPTY_OBJECT))&&(e={url:e}),Check.typeOf.string("options.url",e.url),this._url=void 0,this._templateValues=defaultClone(e.templateValues,{}),this._queryParameters=defaultClone(e.queryParameters,{}),this.headers=defaultClone(e.headers,{}),this.request=defaultValue(e.request,new Request),this.proxy=e.proxy,this.retryCallback=e.retryCallback,this.retryAttempts=defaultValue(e.retryAttempts,0),this._retryCount=0;var r=new Uri(e.url);parseQuery(r,this,!0,!0),r.fragment(""),this._url=r.toString()}function fetchImage(e){var r=e.resource,t=e.flipY,o=e.skipColorSpaceConversion,n=e.preferImageBitmap,s=r.request;s.url=r.url,s.requestFunction=function(){var e=!1;r.isDataUri||r.isBlobUri||(e=r.isCrossOriginUrl);var i=when.defer();return Resource._Implementations.createImage(s,e,i,t,o,n),i.promise};var i=RequestScheduler.request(s);if(defined(i))return i.otherwise((function(e){return s.state!==RequestState.FAILED?when.reject(e):r.retryOnError(e).then((function(i){return i?(s.state=RequestState.UNISSUED,s.deferred=void 0,fetchImage({resource:r,flipY:t,skipColorSpaceConversion:o,preferImageBitmap:n})):when.reject(e)}))}))}function fetchJsonp(e,r,t){var o={};o[r]=t,e.setQueryParameters(o);var n=e.request;n.url=e.url,n.requestFunction=function(){var r=when.defer();return window[t]=function(e){r.resolve(e);try{delete window[t]}catch(e){window[t]=void 0}},Resource._Implementations.loadAndExecuteScript(e.url,t,r),r.promise};var s=RequestScheduler.request(n);if(defined(s))return s.otherwise((function(o){return n.state!==RequestState.FAILED?when.reject(o):e.retryOnError(o).then((function(s){return s?(n.state=RequestState.UNISSUED,n.deferred=void 0,fetchJsonp(e,r,t)):when.reject(o)}))}))}Resource.createIfNeeded=function(e){return e instanceof Resource?e.getDerivedResource({request:e.request}):"string"!=typeof e?e:new Resource({url:e})},Resource.supportsImageBitmapOptions=function(){return defined(supportsImageBitmapOptionsPromise)?supportsImageBitmapOptionsPromise:supportsImageBitmapOptionsPromise="function"!=typeof createImageBitmap?when.resolve(!1):Resource.fetchBlob({url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWP4////fwAJ+wP9CNHoHgAAAABJRU5ErkJggg=="}).then((function(e){return createImageBitmap(e,{imageOrientation:"flipY",premultiplyAlpha:"none",colorSpaceConversion:"none"})})).then((function(e){return!0})).otherwise((function(){return!1}))},Object.defineProperties(Resource,{isBlobSupported:{get:function(){return xhrBlobSupported}}}),Object.defineProperties(Resource.prototype,{queryParameters:{get:function(){return this._queryParameters}},templateValues:{get:function(){return this._templateValues}},url:{get:function(){return this.getUrlComponent(!0,!0)},set:function(e){var r=new Uri(e);parseQuery(r,this,!1),r.fragment(""),this._url=r.toString()}},extension:{get:function(){return getExtensionFromUri(this._url)}},isDataUri:{get:function(){return isDataUri(this._url)}},isBlobUri:{get:function(){return isBlobUri(this._url)}},isCrossOriginUrl:{get:function(){return isCrossOriginUrl(this._url)}},hasHeaders:{get:function(){return Object.keys(this.headers).length>0}}}),Resource.prototype.toString=function(){return this.getUrlComponent(!0,!0)},Resource.prototype.getUrlComponent=function(e,r){if(this.isDataUri)return this._url;var t=new Uri(this._url);e&&stringifyQuery(t,this);var o=t.toString().replace(/%7B/g,"{").replace(/%7D/g,"}"),n=this._templateValues;return o=o.replace(/{(.*?)}/g,(function(e,r){var t=n[r];return defined(t)?encodeURIComponent(t):e})),r&&defined(this.proxy)&&(o=this.proxy.getURL(o)),o},Resource.prototype.setQueryParameters=function(e,r){this._queryParameters=r?combineQueryParameters(this._queryParameters,e,!1):combineQueryParameters(e,this._queryParameters,!1)},Resource.prototype.appendQueryParameters=function(e){this._queryParameters=combineQueryParameters(e,this._queryParameters,!0)},Resource.prototype.setTemplateValues=function(e,r){this._templateValues=r?combine(this._templateValues,e):combine(e,this._templateValues)},Resource.prototype.getDerivedResource=function(e){var r=this.clone();if(r._retryCount=0,defined(e.url)){var t=new Uri(e.url);parseQuery(t,r,!0,defaultValue(e.preserveQueryParameters,!1)),t.fragment(""),""!==t.scheme()?r._url=t.toString():r._url=t.absoluteTo(new Uri(getAbsoluteUri(this._url))).toString()}return defined(e.queryParameters)&&(r._queryParameters=combine(e.queryParameters,r._queryParameters)),defined(e.templateValues)&&(r._templateValues=combine(e.templateValues,r.templateValues)),defined(e.headers)&&(r.headers=combine(e.headers,r.headers)),defined(e.proxy)&&(r.proxy=e.proxy),defined(e.request)&&(r.request=e.request),defined(e.retryCallback)&&(r.retryCallback=e.retryCallback),defined(e.retryAttempts)&&(r.retryAttempts=e.retryAttempts),r},Resource.prototype.retryOnError=function(e){var r=this.retryCallback;if("function"!=typeof r||this._retryCount>=this.retryAttempts)return when(!1);var t=this;return when(r(this,e)).then((function(e){return++t._retryCount,e}))},Resource.prototype.clone=function(e){return defined(e)||(e=new Resource({url:this._url})),e._url=this._url,e._queryParameters=clone(this._queryParameters),e._templateValues=clone(this._templateValues),e.headers=clone(this.headers),e.proxy=this.proxy,e.retryCallback=this.retryCallback,e.retryAttempts=this.retryAttempts,e._retryCount=0,e.request=this.request.clone(),e},Resource.prototype.getBaseUri=function(e){return getBaseUri(this.getUrlComponent(e),e)},Resource.prototype.appendForwardSlash=function(){this._url=appendForwardSlash(this._url)},Resource.prototype.fetchArrayBuffer=function(){return this.fetch({responseType:"arraybuffer"})},Resource.fetchArrayBuffer=function(e){return new Resource(e).fetchArrayBuffer()},Resource.prototype.fetchBlob=function(){return this.fetch({responseType:"blob"})},Resource.fetchBlob=function(e){return new Resource(e).fetchBlob()},Resource.prototype.fetchImage=function(e){e=defaultValue(e,defaultValue.EMPTY_OBJECT);var r=defaultValue(e.preferImageBitmap,!1),t=defaultValue(e.preferBlob,!1),o=defaultValue(e.flipY,!1),n=defaultValue(e.skipColorSpaceConversion,!1);if(checkAndResetRequest(this.request),!xhrBlobSupported||this.isDataUri||this.isBlobUri||!this.hasHeaders&&!t)return fetchImage({resource:this,flipY:o,skipColorSpaceConversion:n,preferImageBitmap:r});var s,i,u,a=this.fetchBlob();return defined(a)?Resource.supportsImageBitmapOptions().then((function(e){return s=e&&r,a})).then((function(e){if(defined(e)){if(u=e,s)return Resource.createImageBitmapFromBlob(e,{flipY:o,premultiplyAlpha:!1,skipColorSpaceConversion:n});var r=window.URL.createObjectURL(e);return fetchImage({resource:i=new Resource({url:r}),flipY:o,skipColorSpaceConversion:n,preferImageBitmap:!1})}})).then((function(e){if(defined(e))return e.blob=u,s||window.URL.revokeObjectURL(i.url),e})).otherwise((function(e){return defined(i)&&window.URL.revokeObjectURL(i.url),e.blob=u,when.reject(e)})):void 0},Resource.fetchImage=function(e){return new Resource(e).fetchImage({flipY:e.flipY,skipColorSpaceConversion:e.skipColorSpaceConversion,preferBlob:e.preferBlob,preferImageBitmap:e.preferImageBitmap})},Resource.prototype.fetchText=function(){return this.fetch({responseType:"text"})},Resource.fetchText=function(e){return new Resource(e).fetchText()},Resource.prototype.fetchJson=function(){var e=this.fetch({responseType:"text",headers:{Accept:"application/json,*/*;q=0.01"}});if(defined(e))return e.then((function(e){if(defined(e))return JSON.parse(e)}))},Resource.fetchJson=function(e){return new Resource(e).fetchJson()},Resource.prototype.fetchXML=function(){return this.fetch({responseType:"document",overrideMimeType:"text/xml"})},Resource.fetchXML=function(e){return new Resource(e).fetchXML()},Resource.prototype.fetchJsonp=function(e){var r;e=defaultValue(e,"callback"),checkAndResetRequest(this.request);do{r="loadJsonp"+CesiumMath.nextRandomNumber().toString().substring(2,8)}while(defined(window[r]));return fetchJsonp(this,e,r)},Resource.fetchJsonp=function(e){return new Resource(e).fetchJsonp(e.callbackParameterName)},Resource.prototype._makeRequest=function(e){var r=this;checkAndResetRequest(r.request);var t=r.request;t.url=r.url,t.requestFunction=function(){var o=e.responseType,n=combine(e.headers,r.headers),s=e.overrideMimeType,i=e.method,u=e.data,a=when.defer(),c=Resource._Implementations.loadWithXhr(r.url,o,i,u,n,a,s);return defined(c)&&defined(c.abort)&&(t.cancelFunction=function(){c.abort()}),a.promise};var o=RequestScheduler.request(t);if(defined(o))return o.then((function(e){return t.cancelFunction=void 0,e})).otherwise((function(o){return t.cancelFunction=void 0,t.state!==RequestState.FAILED?when.reject(o):r.retryOnError(o).then((function(n){return n?(t.state=RequestState.UNISSUED,t.deferred=void 0,r.fetch(e)):when.reject(o)}))}))};var dataUriRegex=/^data:(.*?)(;base64)?,(.*)$/;function decodeDataUriText(e,r){var t=decodeURIComponent(r);return e?atob(t):t}function decodeDataUriArrayBuffer(e,r){for(var t=decodeDataUriText(e,r),o=new ArrayBuffer(t.length),n=new Uint8Array(o),s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return o}function decodeDataUri(e,r){r=defaultValue(r,"");var t=e[1],o=!!e[2],n=e[3];switch(r){case"":case"text":return decodeDataUriText(o,n);case"arraybuffer":return decodeDataUriArrayBuffer(o,n);case"blob":var s=decodeDataUriArrayBuffer(o,n);return new Blob([s],{type:t});case"document":return(new DOMParser).parseFromString(decodeDataUriText(o,n),t);case"json":return JSON.parse(decodeDataUriText(o,n));default:throw new DeveloperError("Unhandled responseType: "+r)}}function loadImageElement(e,r,t){var o=new Image;o.onload=function(){t.resolve(o)},o.onerror=function(e){t.reject(e)},r&&(TrustedServers.contains(e)?o.crossOrigin="use-credentials":o.crossOrigin=""),o.src=e}function decodeResponse(e,r){switch(r){case"text":return e.toString("utf8");case"json":return JSON.parse(e.toString("utf8"));default:return new Uint8Array(e).buffer}}function loadWithHttpRequest(e,r,t,o,n,s,i){var u=require("url").parse(e),a="https:"===u.protocol?require("https"):require("http"),c=require("zlib"),p={protocol:u.protocol,hostname:u.hostname,port:u.port,path:u.path,query:u.query,method:t,headers:n};a.request(p).on("response",(function(e){if(e.statusCode<200||e.statusCode>=300)s.reject(new RequestErrorEvent(e.statusCode,e,e.headers));else{var t=[];e.on("data",(function(e){t.push(e)})),e.on("end",(function(){var o=Buffer.concat(t);"gzip"===e.headers["content-encoding"]?c.gunzip(o,(function(e,t){e?s.reject(new RuntimeError("Error decompressing response.")):s.resolve(decodeResponse(t,r))})):s.resolve(decodeResponse(o,r))}))}})).on("error",(function(e){s.reject(new RequestErrorEvent)})).end()}Resource.prototype.fetch=function(e){return(e=defaultClone(e,{})).method="GET",this._makeRequest(e)},Resource.fetch=function(e){return new Resource(e).fetch({responseType:e.responseType,overrideMimeType:e.overrideMimeType})},Resource.prototype.delete=function(e){return(e=defaultClone(e,{})).method="DELETE",this._makeRequest(e)},Resource.delete=function(e){return new Resource(e).delete({responseType:e.responseType,overrideMimeType:e.overrideMimeType,data:e.data})},Resource.prototype.head=function(e){return(e=defaultClone(e,{})).method="HEAD",this._makeRequest(e)},Resource.head=function(e){return new Resource(e).head({responseType:e.responseType,overrideMimeType:e.overrideMimeType})},Resource.prototype.options=function(e){return(e=defaultClone(e,{})).method="OPTIONS",this._makeRequest(e)},Resource.options=function(e){return new Resource(e).options({responseType:e.responseType,overrideMimeType:e.overrideMimeType})},Resource.prototype.post=function(e,r){return Check.defined("data",e),(r=defaultClone(r,{})).method="POST",r.data=e,this._makeRequest(r)},Resource.post=function(e){return new Resource(e).post(e.data,{responseType:e.responseType,overrideMimeType:e.overrideMimeType})},Resource.prototype.put=function(e,r){return Check.defined("data",e),(r=defaultClone(r,{})).method="PUT",r.data=e,this._makeRequest(r)},Resource.put=function(e){return new Resource(e).put(e.data,{responseType:e.responseType,overrideMimeType:e.overrideMimeType})},Resource.prototype.patch=function(e,r){return Check.defined("data",e),(r=defaultClone(r,{})).method="PATCH",r.data=e,this._makeRequest(r)},Resource.patch=function(e){return new Resource(e).patch(e.data,{responseType:e.responseType,overrideMimeType:e.overrideMimeType})},Resource._Implementations={},Resource._Implementations.createImage=function(e,r,t,o,n,s){var i=e.url;Resource.supportsImageBitmapOptions().then((function(u){if(u&&s){var a=when.defer(),c=Resource._Implementations.loadWithXhr(i,"blob","GET",void 0,void 0,a,void 0,void 0,void 0);return defined(c)&&defined(c.abort)&&(e.cancelFunction=function(){c.abort()}),a.promise.then((function(e){if(defined(e))return Resource.createImageBitmapFromBlob(e,{flipY:o,premultiplyAlpha:!1,skipColorSpaceConversion:n});t.reject(new RuntimeError("Successfully retrieved "+i+" but it contained no content."))})).then(t.resolve)}loadImageElement(i,r,t)})).otherwise(t.reject)},Resource.createImageBitmapFromBlob=function(e,r){return Check.defined("options",r),Check.typeOf.bool("options.flipY",r.flipY),Check.typeOf.bool("options.premultiplyAlpha",r.premultiplyAlpha),Check.typeOf.bool("options.skipColorSpaceConversion",r.skipColorSpaceConversion),createImageBitmap(e,{imageOrientation:r.flipY?"flipY":"none",premultiplyAlpha:r.premultiplyAlpha?"premultiply":"none",colorSpaceConversion:r.skipColorSpaceConversion?"none":"default"})};var noXMLHttpRequest="undefined"==typeof XMLHttpRequest;Resource._Implementations.loadWithXhr=function(e,r,t,o,n,s,i){var u=dataUriRegex.exec(e);if(null===u){if(!noXMLHttpRequest){var a=new XMLHttpRequest;if(TrustedServers.contains(e)&&(a.withCredentials=!0),a.open(t,e,!0),defined(i)&&defined(a.overrideMimeType)&&a.overrideMimeType(i),defined(n))for(var c in n)n.hasOwnProperty(c)&&a.setRequestHeader(c,n[c]);defined(r)&&(a.responseType=r);var p=!1;return"string"==typeof e&&(p=0===e.indexOf("file://")||"undefined"!=typeof window&&"file://"===window.location.origin),a.onload=function(){if(!(a.status<200||a.status>=300)||p&&0===a.status){var e=a.response,o=a.responseType;if("HEAD"===t||"OPTIONS"===t){var n=a.getAllResponseHeaders().trim().split(/[\r\n]+/),i={};return n.forEach((function(e){var r=e.split(": "),t=r.shift();i[t]=r.join(": ")})),void s.resolve(i)}if(204===a.status)s.resolve();else if(!defined(e)||defined(r)&&o!==r)if("json"===r&&"string"==typeof e)try{s.resolve(JSON.parse(e))}catch(e){s.reject(e)}else(""===o||"document"===o)&&defined(a.responseXML)&&a.responseXML.hasChildNodes()?s.resolve(a.responseXML):""!==o&&"text"!==o||!defined(a.responseText)?s.reject(new RuntimeError("Invalid XMLHttpRequest response type.")):s.resolve(a.responseText);else s.resolve(e)}else s.reject(new RequestErrorEvent(a.status,a.response,a.getAllResponseHeaders()))},a.onerror=function(e){s.reject(new RequestErrorEvent)},a.send(o),a}loadWithHttpRequest(e,r,t,o,n,s,i)}else s.resolve(decodeDataUri(u,r))},Resource._Implementations.loadAndExecuteScript=function(e,r,t){return loadAndExecuteScript(e,r).otherwise(t.reject)},Resource._DefaultImplementations={},Resource._DefaultImplementations.createImage=Resource._Implementations.createImage,Resource._DefaultImplementations.loadWithXhr=Resource._Implementations.loadWithXhr,Resource._DefaultImplementations.loadAndExecuteScript=Resource._Implementations.loadAndExecuteScript,Resource.DEFAULT=Object.freeze(new Resource({url:"undefined"==typeof document?"":document.location.href.split("?")[0]}));export default Resource;