import binarySearch from"./binarySearch.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import Event from"./Event.js";import GregorianDate from"./GregorianDate.js";import isLeapYear from"./isLeapYear.js";import Iso8601 from"./Iso8601.js";import JulianDate from"./JulianDate.js";import TimeInterval from"./TimeInterval.js";function compareIntervalStartTimes(t,e){return JulianDate.compare(t.start,e.start)}function TimeIntervalCollection(t){if(this._intervals=[],this._changedEvent=new Event,defined(t))for(var e=t.length,a=0;a<e;a++)this.addInterval(t[a])}Object.defineProperties(TimeIntervalCollection.prototype,{changedEvent:{get:function(){return this._changedEvent}},start:{get:function(){var t=this._intervals;return 0===t.length?void 0:t[0].start}},isStartIncluded:{get:function(){var t=this._intervals;return 0!==t.length&&t[0].isStartIncluded}},stop:{get:function(){var t=this._intervals,e=t.length;return 0===e?void 0:t[e-1].stop}},isStopIncluded:{get:function(){var t=this._intervals,e=t.length;return 0!==e&&t[e-1].isStopIncluded}},length:{get:function(){return this._intervals.length}},isEmpty:{get:function(){return 0===this._intervals.length}}}),TimeIntervalCollection.prototype.equals=function(t,e){if(this===t)return!0;if(!(t instanceof TimeIntervalCollection))return!1;var a=this._intervals,r=t._intervals,n=a.length;if(n!==r.length)return!1;for(var i=0;i<n;i++)if(!TimeInterval.equals(a[i],r[i],e))return!1;return!0},TimeIntervalCollection.prototype.get=function(t){if(!defined(t))throw new DeveloperError("index is required.");return this._intervals[t]},TimeIntervalCollection.prototype.removeAll=function(){this._intervals.length>0&&(this._intervals.length=0,this._changedEvent.raiseEvent(this))},TimeIntervalCollection.prototype.findIntervalContainingDate=function(t){var e=this.indexOf(t);return e>=0?this._intervals[e]:void 0},TimeIntervalCollection.prototype.findDataForIntervalContainingDate=function(t){var e=this.indexOf(t);return e>=0?this._intervals[e].data:void 0},TimeIntervalCollection.prototype.contains=function(t){return this.indexOf(t)>=0};var indexOfScratch=new TimeInterval;TimeIntervalCollection.prototype.indexOf=function(t){if(!defined(t))throw new DeveloperError("date is required");var e=this._intervals;indexOfScratch.start=t,indexOfScratch.stop=t;var a=binarySearch(e,indexOfScratch,compareIntervalStartTimes);return a>=0?e[a].isStartIncluded?a:a>0&&e[a-1].stop.equals(t)&&e[a-1].isStopIncluded?a-1:~a:(a=~a)>0&&a-1<e.length&&TimeInterval.contains(e[a-1],t)?a-1:~a},TimeIntervalCollection.prototype.findInterval=function(t){for(var e=(t=defaultValue(t,defaultValue.EMPTY_OBJECT)).start,a=t.stop,r=t.isStartIncluded,n=t.isStopIncluded,i=this._intervals,o=0,l=i.length;o<l;o++){var s=i[o];if((!defined(e)||s.start.equals(e))&&(!defined(a)||s.stop.equals(a))&&(!defined(r)||s.isStartIncluded===r)&&(!defined(n)||s.isStopIncluded===n))return i[o]}},TimeIntervalCollection.prototype.addInterval=function(t,e){if(!defined(t))throw new DeveloperError("interval is required");if(!t.isEmpty){var a=this._intervals;if(0===a.length||JulianDate.greaterThan(t.start,a[a.length-1].stop))return a.push(t),void this._changedEvent.raiseEvent(this);var r,n=binarySearch(a,t,compareIntervalStartTimes);for(n<0?n=~n:n>0&&t.isStartIncluded&&a[n-1].isStartIncluded&&a[n-1].start.equals(t.start)?--n:n<a.length&&!t.isStartIncluded&&a[n].isStartIncluded&&a[n].start.equals(t.start)&&++n,n>0&&((r=JulianDate.compare(a[n-1].stop,t.start))>0||0===r&&(a[n-1].isStopIncluded||t.isStartIncluded))&&((defined(e)?e(a[n-1].data,t.data):a[n-1].data===t.data)?(t=JulianDate.greaterThan(t.stop,a[n-1].stop)?new TimeInterval({start:a[n-1].start,stop:t.stop,isStartIncluded:a[n-1].isStartIncluded,isStopIncluded:t.isStopIncluded,data:t.data}):new TimeInterval({start:a[n-1].start,stop:a[n-1].stop,isStartIncluded:a[n-1].isStartIncluded,isStopIncluded:a[n-1].isStopIncluded||t.stop.equals(a[n-1].stop)&&t.isStopIncluded,data:t.data}),a.splice(n-1,1),--n):(((r=JulianDate.compare(a[n-1].stop,t.stop))>0||0===r&&a[n-1].isStopIncluded&&!t.isStopIncluded)&&a.splice(n,0,new TimeInterval({start:t.stop,stop:a[n-1].stop,isStartIncluded:!t.isStopIncluded,isStopIncluded:a[n-1].isStopIncluded,data:a[n-1].data})),a[n-1]=new TimeInterval({start:a[n-1].start,stop:t.start,isStartIncluded:a[n-1].isStartIncluded,isStopIncluded:!t.isStartIncluded,data:a[n-1].data})));n<a.length&&((r=JulianDate.compare(t.stop,a[n].start))>0||0===r&&(t.isStopIncluded||a[n].isStartIncluded));)if(defined(e)?e(a[n].data,t.data):a[n].data===t.data)t=new TimeInterval({start:t.start,stop:JulianDate.greaterThan(a[n].stop,t.stop)?a[n].stop:t.stop,isStartIncluded:t.isStartIncluded,isStopIncluded:JulianDate.greaterThan(a[n].stop,t.stop)?a[n].isStopIncluded:t.isStopIncluded,data:t.data}),a.splice(n,1);else{if(a[n]=new TimeInterval({start:t.stop,stop:a[n].stop,isStartIncluded:!t.isStopIncluded,isStopIncluded:a[n].isStopIncluded,data:a[n].data}),!a[n].isEmpty)break;a.splice(n,1)}a.splice(n,0,t),this._changedEvent.raiseEvent(this)}},TimeIntervalCollection.prototype.removeInterval=function(t){if(!defined(t))throw new DeveloperError("interval is required");if(t.isEmpty)return!1;var e=this._intervals,a=binarySearch(e,t,compareIntervalStartTimes);a<0&&(a=~a);var r=!1;for(a>0&&(JulianDate.greaterThan(e[a-1].stop,t.start)||e[a-1].stop.equals(t.start)&&e[a-1].isStopIncluded&&t.isStartIncluded)&&(r=!0,(JulianDate.greaterThan(e[a-1].stop,t.stop)||e[a-1].isStopIncluded&&!t.isStopIncluded&&e[a-1].stop.equals(t.stop))&&e.splice(a,0,new TimeInterval({start:t.stop,stop:e[a-1].stop,isStartIncluded:!t.isStopIncluded,isStopIncluded:e[a-1].isStopIncluded,data:e[a-1].data})),e[a-1]=new TimeInterval({start:e[a-1].start,stop:t.start,isStartIncluded:e[a-1].isStartIncluded,isStopIncluded:!t.isStartIncluded,data:e[a-1].data})),a<e.length&&!t.isStartIncluded&&e[a].isStartIncluded&&t.start.equals(e[a].start)&&(r=!0,e.splice(a,0,new TimeInterval({start:e[a].start,stop:e[a].start,isStartIncluded:!0,isStopIncluded:!0,data:e[a].data})),++a);a<e.length&&JulianDate.greaterThan(t.stop,e[a].stop);)r=!0,e.splice(a,1);return a<e.length&&t.stop.equals(e[a].stop)&&(r=!0,!t.isStopIncluded&&e[a].isStopIncluded?a+1<e.length&&e[a+1].start.equals(t.stop)&&e[a].data===e[a+1].data?(e.splice(a,1),e[a]=new TimeInterval({start:e[a].start,stop:e[a].stop,isStartIncluded:!0,isStopIncluded:e[a].isStopIncluded,data:e[a].data})):e[a]=new TimeInterval({start:t.stop,stop:t.stop,isStartIncluded:!0,isStopIncluded:!0,data:e[a].data}):e.splice(a,1)),a<e.length&&(JulianDate.greaterThan(t.stop,e[a].start)||t.stop.equals(e[a].start)&&t.isStopIncluded&&e[a].isStartIncluded)&&(r=!0,e[a]=new TimeInterval({start:t.stop,stop:e[a].stop,isStartIncluded:!t.isStopIncluded,isStopIncluded:e[a].isStopIncluded,data:e[a].data})),r&&this._changedEvent.raiseEvent(this),r},TimeIntervalCollection.prototype.intersect=function(t,e,a){if(!defined(t))throw new DeveloperError("other is required.");for(var r=new TimeIntervalCollection,n=0,i=0,o=this._intervals,l=t._intervals;n<o.length&&i<l.length;){var s=o[n],d=l[i];if(JulianDate.lessThan(s.stop,d.start))++n;else if(JulianDate.lessThan(d.stop,s.start))++i;else{if(defined(a)||defined(e)&&e(s.data,d.data)||!defined(e)&&d.data===s.data){var u=TimeInterval.intersect(s,d,new TimeInterval,a);u.isEmpty||r.addInterval(u,e)}JulianDate.lessThan(s.stop,d.stop)||s.stop.equals(d.stop)&&!s.isStopIncluded&&d.isStopIncluded?++n:++i}}return r},TimeIntervalCollection.fromJulianDateArray=function(t,e){if(!defined(t))throw new DeveloperError("options is required.");if(!defined(t.julianDates))throw new DeveloperError("options.iso8601Array is required.");defined(e)||(e=new TimeIntervalCollection);var a,r=t.julianDates,n=r.length,i=t.dataCallback,o=defaultValue(t.isStartIncluded,!0),l=defaultValue(t.isStopIncluded,!0),s=defaultValue(t.leadingInterval,!1),d=defaultValue(t.trailingInterval,!1),u=0;s&&(++u,(a=new TimeInterval({start:Iso8601.MINIMUM_VALUE,stop:r[0],isStartIncluded:!0,isStopIncluded:!o})).data=defined(i)?i(a,e.length):e.length,e.addInterval(a));for(var c=0;c<n-1;++c){var p=r[c],I=r[c+1];(a=new TimeInterval({start:p,stop:I,isStartIncluded:e.length!==u||o,isStopIncluded:c===n-2&&l})).data=defined(i)?i(a,e.length):e.length,e.addInterval(a),p=I}return d&&((a=new TimeInterval({start:r[n-1],stop:Iso8601.MAXIMUM_VALUE,isStartIncluded:!l,isStopIncluded:!0})).data=defined(i)?i(a,e.length):e.length,e.addInterval(a)),e};var scratchGregorianDate=new GregorianDate,monthLengths=[0,31,28,31,30,31,30,31,31,30,31,30,31];function addToDate(t,e,a){defined(a)||(a=new JulianDate),JulianDate.toGregorianDate(t,scratchGregorianDate);var r=scratchGregorianDate.millisecond+e.millisecond,n=scratchGregorianDate.second+e.second,i=scratchGregorianDate.minute+e.minute,o=scratchGregorianDate.hour+e.hour,l=scratchGregorianDate.day+e.day,s=scratchGregorianDate.month+e.month,d=scratchGregorianDate.year+e.year;for(r>=1e3&&(n+=Math.floor(r/1e3),r%=1e3),n>=60&&(i+=Math.floor(n/60),n%=60),i>=60&&(o+=Math.floor(i/60),i%=60),o>=24&&(l+=Math.floor(o/24),o%=24),monthLengths[2]=isLeapYear(d)?29:28;l>monthLengths[s]||s>=13;)l>monthLengths[s]&&(l-=monthLengths[s],++s),s>=13&&(--s,d+=Math.floor(s/12),s%=12,++s),monthLengths[2]=isLeapYear(d)?29:28;return scratchGregorianDate.millisecond=r,scratchGregorianDate.second=n,scratchGregorianDate.minute=i,scratchGregorianDate.hour=o,scratchGregorianDate.day=l,scratchGregorianDate.month=s,scratchGregorianDate.year=d,JulianDate.fromGregorianDate(scratchGregorianDate,a)}var scratchJulianDate=new JulianDate,durationRegex=/P(?:([\d.,]+)Y)?(?:([\d.,]+)M)?(?:([\d.,]+)W)?(?:([\d.,]+)D)?(?:T(?:([\d.,]+)H)?(?:([\d.,]+)M)?(?:([\d.,]+)S)?)?/;function parseDuration(t,e){if(!defined(t)||0===t.length)return!1;if(e.year=0,e.month=0,e.day=0,e.hour=0,e.minute=0,e.second=0,e.millisecond=0,"P"===t[0]){var a=t.match(durationRegex);if(!defined(a))return!1;if(defined(a[1])&&(e.year=Number(a[1].replace(",","."))),defined(a[2])&&(e.month=Number(a[2].replace(",","."))),defined(a[3])&&(e.day=7*Number(a[3].replace(",","."))),defined(a[4])&&(e.day+=Number(a[4].replace(",","."))),defined(a[5])&&(e.hour=Number(a[5].replace(",","."))),defined(a[6])&&(e.minute=Number(a[6].replace(",","."))),defined(a[7])){var r=Number(a[7].replace(",","."));e.second=Math.floor(r),e.millisecond=r%1*1e3}}else"Z"!==t[t.length-1]&&(t+="Z"),JulianDate.toGregorianDate(JulianDate.fromIso8601(t,scratchJulianDate),e);return e.year||e.month||e.day||e.hour||e.minute||e.second||e.millisecond}var scratchDuration=new GregorianDate;TimeIntervalCollection.fromIso8601=function(t,e){if(!defined(t))throw new DeveloperError("options is required.");if(!defined(t.iso8601))throw new DeveloperError("options.iso8601 is required.");var a=t.iso8601.split("/"),r=JulianDate.fromIso8601(a[0]),n=JulianDate.fromIso8601(a[1]),i=[];if(parseDuration(a[2],scratchDuration)){var o=JulianDate.clone(r);for(i.push(o);JulianDate.compare(o,n)<0;)o=addToDate(o,scratchDuration),JulianDate.compare(n,o)<=0&&JulianDate.clone(n,o),i.push(o)}else i.push(r,n);return TimeIntervalCollection.fromJulianDateArray({julianDates:i,isStartIncluded:t.isStartIncluded,isStopIncluded:t.isStopIncluded,leadingInterval:t.leadingInterval,trailingInterval:t.trailingInterval,dataCallback:t.dataCallback},e)},TimeIntervalCollection.fromIso8601DateArray=function(t,e){if(!defined(t))throw new DeveloperError("options is required.");if(!defined(t.iso8601Dates))throw new DeveloperError("options.iso8601Dates is required.");return TimeIntervalCollection.fromJulianDateArray({julianDates:t.iso8601Dates.map((function(t){return JulianDate.fromIso8601(t)})),isStartIncluded:t.isStartIncluded,isStopIncluded:t.isStopIncluded,leadingInterval:t.leadingInterval,trailingInterval:t.trailingInterval,dataCallback:t.dataCallback},e)},TimeIntervalCollection.fromIso8601DurationArray=function(t,e){if(!defined(t))throw new DeveloperError("options is required.");if(!defined(t.epoch))throw new DeveloperError("options.epoch is required.");if(!defined(t.iso8601Durations))throw new DeveloperError("options.iso8601Durations is required.");for(var a,r,n=t.epoch,i=t.iso8601Durations,o=defaultValue(t.relativeToPrevious,!1),l=[],s=i.length,d=0;d<s;++d)(parseDuration(i[d],scratchDuration)||0===d)&&(a=o&&defined(r)?addToDate(r,scratchDuration):addToDate(n,scratchDuration),l.push(a),r=a);return TimeIntervalCollection.fromJulianDateArray({julianDates:l,isStartIncluded:t.isStartIncluded,isStopIncluded:t.isStopIncluded,leadingInterval:t.leadingInterval,trailingInterval:t.trailingInterval,dataCallback:t.dataCallback},e)};export default TimeIntervalCollection;