import when from"../ThirdParty/when.js";import buildModuleUrl from"./buildModuleUrl.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import Iau2006XysSample from"./Iau2006XysSample.js";import JulianDate from"./JulianDate.js";import Resource from"./Resource.js";import TimeStandard from"./TimeStandard.js";function Iau2006XysData(e){e=defaultValue(e,defaultValue.EMPTY_OBJECT),this._xysFileUrlTemplate=Resource.createIfNeeded(e.xysFileUrlTemplate),this._interpolationOrder=defaultValue(e.interpolationOrder,9),this._sampleZeroJulianEphemerisDate=defaultValue(e.sampleZeroJulianEphemerisDate,2442396.5),this._sampleZeroDateTT=new JulianDate(this._sampleZeroJulianEphemerisDate,0,TimeStandard.TAI),this._stepSizeDays=defaultValue(e.stepSizeDays,1),this._samplesPerXysFile=defaultValue(e.samplesPerXysFile,1e3),this._totalSamples=defaultValue(e.totalSamples,27426),this._samples=new Array(3*this._totalSamples),this._chunkDownloadsInProgress=[];for(var s=this._interpolationOrder,a=this._denominators=new Array(s+1),t=this._xTable=new Array(s+1),r=Math.pow(this._stepSizeDays,s),i=0;i<=s;++i){a[i]=r,t[i]=i*this._stepSizeDays;for(var l=0;l<=s;++l)l!==i&&(a[i]*=i-l);a[i]=1/a[i]}this._work=new Array(s+1),this._coef=new Array(s+1)}var julianDateScratch=new JulianDate(0,0,TimeStandard.TAI);function getDaysSinceEpoch(e,s,a){var t=julianDateScratch;return t.dayNumber=s,t.secondsOfDay=a,JulianDate.daysDifference(t,e._sampleZeroDateTT)}function requestXysChunk(e,s){if(e._chunkDownloadsInProgress[s])return e._chunkDownloadsInProgress[s];var a,t=when.defer();e._chunkDownloadsInProgress[s]=t;var r=e._xysFileUrlTemplate;return a=defined(r)?r.getDerivedResource({templateValues:{0:s}}):new Resource({url:buildModuleUrl("Assets/IAU2006_XYS/IAU2006_XYS_"+s+".json")}),when(a.fetchJson(),(function(a){e._chunkDownloadsInProgress[s]=!1;for(var r=e._samples,i=a.samples,l=s*e._samplesPerXysFile*3,o=0,n=i.length;o<n;++o)r[l+o]=i[o];t.resolve()})),t.promise}Iau2006XysData.prototype.preload=function(e,s,a,t){var r=getDaysSinceEpoch(this,e,s),i=getDaysSinceEpoch(this,a,t),l=r/this._stepSizeDays-this._interpolationOrder/2|0;l<0&&(l=0);var o=i/this._stepSizeDays-this._interpolationOrder/2|0+this._interpolationOrder;o>=this._totalSamples&&(o=this._totalSamples-1);for(var n=l/this._samplesPerXysFile|0,u=o/this._samplesPerXysFile|0,h=[],p=n;p<=u;++p)h.push(requestXysChunk(this,p));return when.all(h)},Iau2006XysData.prototype.computeXysRadians=function(e,s,a){var t=getDaysSinceEpoch(this,e,s);if(!(t<0)){var r=t/this._stepSizeDays|0;if(!(r>=this._totalSamples)){var i=this._interpolationOrder,l=r-(i/2|0);l<0&&(l=0);var o=l+i;o>=this._totalSamples&&(l=(o=this._totalSamples-1)-i)<0&&(l=0);var n=!1,u=this._samples;if(defined(u[3*l])||(requestXysChunk(this,l/this._samplesPerXysFile|0),n=!0),defined(u[3*o])||(requestXysChunk(this,o/this._samplesPerXysFile|0),n=!0),!n){defined(a)?(a.x=0,a.y=0,a.s=0):a=new Iau2006XysSample(0,0,0);var h,p,d=t-l*this._stepSizeDays,m=this._work,_=this._denominators,f=this._coef,y=this._xTable;for(h=0;h<=i;++h)m[h]=d-y[h];for(h=0;h<=i;++h){for(f[h]=1,p=0;p<=i;++p)p!==h&&(f[h]*=m[p]);f[h]*=_[h];var D=3*(l+h);a.x+=f[h]*u[D++],a.y+=f[h]*u[D++],a.s+=f[h]*u[D]}return a}}}};export default Iau2006XysData;