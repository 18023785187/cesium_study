import when from"../ThirdParty/when.js";import Cartesian2 from"./Cartesian2.js";import Credit from"./Credit.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import Ellipsoid from"./Ellipsoid.js";import Event from"./Event.js";import GeographicTilingScheme from"./GeographicTilingScheme.js";import HeightmapEncoding from"./HeightmapEncoding.js";import HeightmapTerrainData from"./HeightmapTerrainData.js";import Rectangle from"./Rectangle.js";import Request from"./Request.js";import RequestState from"./RequestState.js";import RequestType from"./RequestType.js";import Resource from"./Resource.js";import RuntimeError from"./RuntimeError.js";import TerrainProvider from"./TerrainProvider.js";import TileAvailability from"./TileAvailability.js";import TileProviderError from"./TileProviderError.js";import WebMercatorTilingScheme from"./WebMercatorTilingScheme.js";var ALL_CHILDREN=15;function ArcGISTiledElevationTerrainProvider(e){if(!defined(e)||!defined(e.url))throw new DeveloperError("options.url is required.");this._resource=void 0,this._credit=void 0,this._tilingScheme=void 0,this._levelZeroMaximumGeometricError=void 0,this._maxLevel=void 0,this._terrainDataStructure=void 0,this._ready=!1,this._width=void 0,this._height=void 0,this._encoding=void 0;var r=e.token;this._hasAvailability=!1,this._tilesAvailable=void 0,this._tilesAvailablityLoaded=void 0,this._availableCache={};var i=this,t=defaultValue(e.ellipsoid,Ellipsoid.WGS84);this._readyPromise=when(e.url).then((function(e){var t=Resource.createIfNeeded(e);return t.appendForwardSlash(),defined(r)&&(t=t.getDerivedResource({queryParameters:{token:r}})),i._resource=t,t.getDerivedResource({queryParameters:{f:"pjson"}}).fetchJson()})).then((function(e){var r=e.copyrightText;defined(r)&&(i._credit=new Credit(r));var a=e.spatialReference,n=defaultValue(a.latestWkid,a.wkid),o=e.extent,l={ellipsoid:t};if(4326===n)l.rectangle=Rectangle.fromDegrees(o.xmin,o.ymin,o.xmax,o.ymax),i._tilingScheme=new GeographicTilingScheme(l);else{if(3857!==n)return when.reject(new RuntimeError("Invalid spatial reference"));l.rectangleSouthwestInMeters=new Cartesian2(o.xmin,o.ymin),l.rectangleNortheastInMeters=new Cartesian2(o.xmax,o.ymax),i._tilingScheme=new WebMercatorTilingScheme(l)}var s=e.tileInfo;return defined(s)?(i._width=s.rows+1,i._height=s.cols+1,i._encoding="LERC"===s.format?HeightmapEncoding.LERC:HeightmapEncoding.NONE,i._lodCount=s.lods.length-1,(i._hasAvailability=-1!==e.capabilities.indexOf("Tilemap"))&&(i._tilesAvailable=new TileAvailability(i._tilingScheme,i._lodCount),i._tilesAvailable.addAvailableTileRange(0,0,0,i._tilingScheme.getNumberOfXTilesAtLevel(0),i._tilingScheme.getNumberOfYTilesAtLevel(0)),i._tilesAvailablityLoaded=new TileAvailability(i._tilingScheme,i._lodCount)),i._levelZeroMaximumGeometricError=TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(i._tilingScheme.ellipsoid,i._width,i._tilingScheme.getNumberOfXTilesAtLevel(0)),e.bandCount>1&&console.log("ArcGISTiledElevationTerrainProvider: Terrain data has more than 1 band. Using the first one."),i._terrainDataStructure={elementMultiplier:1,lowestEncodedHeight:e.minValues[0],highestEncodedHeight:e.maxValues[0]},i._ready=!0,!0):when.reject(new RuntimeError("tileInfo is required"))})).otherwise((function(e){var r="An error occurred while accessing "+i._resource.url+".";return TileProviderError.handleError(void 0,i,i._errorEvent,r),when.reject(e)})),this._errorEvent=new Event}function isTileAvailable(e,r,i,t){if(e._hasAvailability){var a=e._tilesAvailablityLoaded,n=e._tilesAvailable;return!(r>e._lodCount)&&(!!n.isTileAvailable(r,i,t)||!a.isTileAvailable(r,i,t)&&void 0)}}function findRange(e,r,i,t){for(var a=r-1,n=i-1,o=t[e.y*r+e.x],l=[],s={startX:e.x,startY:e.y,endX:0,endY:0},d=new Cartesian2(e.x+1,e.y+1),u=!1,h=!1;!u||!h;){var v=d.x,c=h?d.y+1:d.y;if(!u){for(var m=e.y;m<c;++m)if(t[m*r+d.x]!==o){u=!0;break}u?(l.push(new Cartesian2(d.x,e.y)),--d.x,--v,s.endX=d.x):d.x===a?(s.endX=d.x,u=!0):++d.x}if(!h){for(var f=d.y*r,p=e.x;p<=v;++p)if(t[f+p]!==o){h=!0;break}h?(l.push(new Cartesian2(e.x,d.y)),--d.y,s.endY=d.y):d.y===n?(s.endY=d.y,h=!0):++d.y}}return{endingIndices:l,range:s,value:o}}function computeAvailability(e,r,i,t,a){var n=[];if(a.every((function(e){return e===a[0]})))return 1===a[0]&&n.push({startX:e,startY:r,endX:e+i-1,endY:r+t-1}),n;for(var o=[new Cartesian2(0,0)];o.length>0;){var l=findRange(o.pop(),i,t,a);if(1===l.value){var s=l.range;s.startX+=e,s.endX+=e,s.startY+=r,s.endY+=r,n.push(s)}var d=l.endingIndices;d.length>0&&(o=o.concat(d))}return n}function requestAvailability(e,r,i,t){if(!e._hasAvailability)return{};var a=128*Math.floor(i/128),n=128*Math.floor(t/128),o=Math.min(1<<r,128),l="tilemap/"+r+"/"+n+"/"+a+"/"+o+"/"+o,s=e._availableCache;if(defined(s[l]))return s[l];var d=new Request({throttle:!1,throttleByServer:!0,type:RequestType.TERRAIN}),u=e._resource.getDerivedResource({url:l,request:d}).fetchJson();return defined(u)?(u=u.then((function(l){var s=computeAvailability(a,n,o,o,l.data);e._tilesAvailablityLoaded.addAvailableTileRange(r,a,n,a+o,n+o);for(var d=e._tilesAvailable,u=0;u<s.length;++u){var h=s[u];d.addAvailableTileRange(r,h.startX,h.startY,h.endX,h.endY)}return isTileAvailable(e,r,i,t)})),s[l]={promise:u,request:d},{promise:u=u.always((function(e){return delete s[l],e})),request:d}):{}}Object.defineProperties(ArcGISTiledElevationTerrainProvider.prototype,{errorEvent:{get:function(){return this._errorEvent}},credit:{get:function(){if(!this.ready)throw new DeveloperError("credit must not be called before ready returns true.");return this._credit}},tilingScheme:{get:function(){if(!this.ready)throw new DeveloperError("tilingScheme must not be called before ready returns true.");return this._tilingScheme}},ready:{get:function(){return this._ready}},readyPromise:{get:function(){return this._readyPromise}},hasWaterMask:{get:function(){return!1}},hasVertexNormals:{get:function(){return!1}},availability:{get:function(){if(!this._ready)throw new DeveloperError("availability must not be called before the terrain provider is ready.");return this._tilesAvailable}}}),ArcGISTiledElevationTerrainProvider.prototype.requestTileGeometry=function(e,r,i,t){if(!this._ready)throw new DeveloperError("requestTileGeometry must not be called before the terrain provider is ready.");var a,n=this._resource.getDerivedResource({url:"tile/"+i+"/"+r+"/"+e,request:t}),o=this._hasAvailability,l=when.resolve(!0);if(o&&!defined(isTileAvailable(this,i+1,2*e,2*r))){var s=requestAvailability(this,i+1,2*e,2*r);l=s.promise,a=s.request}var d=n.fetchArrayBuffer();if(defined(d)&&defined(l)){var u=this,h=this._tilesAvailable;return when.join(d,l).then((function(t){return new HeightmapTerrainData({buffer:t[0],width:u._width,height:u._height,childTileMask:o?h.computeChildMaskForTile(i,e,r):ALL_CHILDREN,structure:u._terrainDataStructure,encoding:u._encoding})})).otherwise((function(e){return defined(a)&&a.state===RequestState.CANCELLED?(t.cancel(),t.deferred.promise.always((function(){return t.state=RequestState.CANCELLED,when.reject(e)}))):when.reject(e)}))}},ArcGISTiledElevationTerrainProvider.prototype.getLevelMaximumGeometricError=function(e){if(!this.ready)throw new DeveloperError("getLevelMaximumGeometricError must not be called before ready returns true.");return this._levelZeroMaximumGeometricError/(1<<e)},ArcGISTiledElevationTerrainProvider.prototype.getTileDataAvailable=function(e,r,i){if(this._hasAvailability){var t=isTileAvailable(this,i,e,r);if(defined(t))return t;requestAvailability(this,i,e,r)}},ArcGISTiledElevationTerrainProvider.prototype.loadTileDataAvailability=function(e,r,i){};export default ArcGISTiledElevationTerrainProvider;