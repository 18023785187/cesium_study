import Uri from"../ThirdParty/Uri.js";import when from"../ThirdParty/when.js";import Check from"./Check.js";import Credit from"./Credit.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import Ion from"./Ion.js";import Resource from"./Resource.js";import RuntimeError from"./RuntimeError.js";function IonResource(e,t){var o;Check.defined("endpoint",e),Check.defined("endpointResource",t);var r=e.externalType,n=defined(r);if(n){if("3DTILES"!==r&&"STK_TERRAIN_SERVER"!==r)throw new RuntimeError("Ion.createResource does not support external imagery assets; use IonImageryProvider instead.");o={url:e.options.url}}else o={url:e.url,retryAttempts:1,retryCallback:retryCallback};Resource.call(this,o),this._ionEndpoint=e,this._ionEndpointDomain=n?void 0:new Uri(e.url).authority(),this._ionEndpointResource=t,this._ionRoot=void 0,this._pendingPromise=void 0,this._credits=void 0,this._isExternal=n}function retryCallback(e,t){var o=defaultValue(e._ionRoot,e),r=o._ionEndpointResource,n="undefined"!=typeof Image;return defined(t)&&(401===t.statusCode||n&&t.target instanceof Image)?(defined(o._pendingPromise)||(o._pendingPromise=r.fetchJson().then((function(e){return o._ionEndpoint=e,e})).always((function(e){return o._pendingPromise=void 0,e}))),o._pendingPromise.then((function(t){return e._ionEndpoint=t,!0}))):when.resolve(!1)}defined(Object.create)&&(IonResource.prototype=Object.create(Resource.prototype),IonResource.prototype.constructor=IonResource),IonResource.fromAssetId=function(e,t){var o=IonResource._createEndpointResource(e,t);return o.fetchJson().then((function(e){return new IonResource(e,o)}))},Object.defineProperties(IonResource.prototype,{credits:{get:function(){return defined(this._ionRoot)?this._ionRoot.credits:(defined(this._credits)||(this._credits=IonResource.getCreditsFromEndpoint(this._ionEndpoint,this._ionEndpointResource)),this._credits)}}}),IonResource.getCreditsFromEndpoint=function(e,t){var o=e.attributions.map(Credit.getIonCredit),r=Ion.getDefaultTokenCredit(t.queryParameters.access_token);return defined(r)&&o.push(Credit.clone(r)),o},IonResource.prototype.clone=function(e){var t=defaultValue(this._ionRoot,this);return defined(e)||(e=new IonResource(t._ionEndpoint,t._ionEndpointResource)),(e=Resource.prototype.clone.call(this,e))._ionRoot=t,e._isExternal=this._isExternal,e},IonResource.prototype.fetchImage=function(e){if(!this._isExternal){var t=e;e={preferBlob:!0},defined(t)&&(e.flipY=t.flipY,e.preferImageBitmap=t.preferImageBitmap)}return Resource.prototype.fetchImage.call(this,e)},IonResource.prototype._makeRequest=function(e){return this._isExternal||new Uri(this.url).authority()!==this._ionEndpointDomain||(defined(e.headers)||(e.headers={}),e.headers.Authorization="Bearer "+this._ionEndpoint.accessToken),Resource.prototype._makeRequest.call(this,e)},IonResource._createEndpointResource=function(e,t){Check.defined("assetId",e),t=defaultValue(t,defaultValue.EMPTY_OBJECT);var o=defaultValue(t.server,Ion.defaultServer),r=defaultValue(t.accessToken,Ion.defaultAccessToken);o=Resource.createIfNeeded(o);var n={url:"v1/assets/"+e+"/endpoint"};return defined(r)&&(n.queryParameters={access_token:r}),o.getDerivedResource(n)};export default IonResource;