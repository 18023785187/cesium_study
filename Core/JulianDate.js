import binarySearch from"./binarySearch.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import GregorianDate from"./GregorianDate.js";import isLeapYear from"./isLeapYear.js";import LeapSecond from"./LeapSecond.js";import TimeConstants from"./TimeConstants.js";import TimeStandard from"./TimeStandard.js";var gregorianDateScratch=new GregorianDate,daysInMonth=[31,28,31,30,31,30,31,31,30,31,30,31],daysInLeapFeburary=29;function compareLeapSecondDates(e,a){return JulianDate.compare(e.julianDate,a.julianDate)}var binarySearchScratchLeapSecond=new LeapSecond;function convertUtcToTai(e){binarySearchScratchLeapSecond.julianDate=e;var a=JulianDate.leapSeconds,n=binarySearch(a,binarySearchScratchLeapSecond,compareLeapSecondDates);n<0&&(n=~n),n>=a.length&&(n=a.length-1);var r=a[n].offset;n>0&&JulianDate.secondsDifference(a[n].julianDate,e)>r&&(r=a[--n].offset),JulianDate.addSeconds(e,r,e)}function convertTaiToUtc(e,a){binarySearchScratchLeapSecond.julianDate=e;var n=JulianDate.leapSeconds,r=binarySearch(n,binarySearchScratchLeapSecond,compareLeapSecondDates);if(r<0&&(r=~r),0===r)return JulianDate.addSeconds(e,-n[0].offset,a);if(r>=n.length)return JulianDate.addSeconds(e,-n[r-1].offset,a);var t=JulianDate.secondsDifference(n[r].julianDate,e);return 0===t?JulianDate.addSeconds(e,-n[r].offset,a):t<=1?void 0:JulianDate.addSeconds(e,-n[--r].offset,a)}function setComponents(e,a,n){var r=a/TimeConstants.SECONDS_PER_DAY|0;return e+=r,(a-=TimeConstants.SECONDS_PER_DAY*r)<0&&(e--,a+=TimeConstants.SECONDS_PER_DAY),n.dayNumber=e,n.secondsOfDay=a,n}function computeJulianDateComponents(e,a,n,r,t,o,i){var d=(a-14)/12|0,s=e+4800+d,u=(1461*s/4|0)+(367*(a-2-12*d)/12|0)-(3*((s+100)/100|0)/4|0)+n-32075;(r-=12)<0&&(r+=24);var c=o+(r*TimeConstants.SECONDS_PER_HOUR+t*TimeConstants.SECONDS_PER_MINUTE+i*TimeConstants.SECONDS_PER_MILLISECOND);return c>=43200&&(u-=1),[u,c]}var matchCalendarYear=/^(\d{4})$/,matchCalendarMonth=/^(\d{4})-(\d{2})$/,matchOrdinalDate=/^(\d{4})-?(\d{3})$/,matchWeekDate=/^(\d{4})-?W(\d{2})-?(\d{1})?$/,matchCalendarDate=/^(\d{4})-?(\d{2})-?(\d{2})$/,utcOffset=/([Z+\-])?(\d{2})?:?(\d{2})?$/,matchHours=/^(\d{2})(\.\d+)?/.source+utcOffset.source,matchHoursMinutes=/^(\d{2}):?(\d{2})(\.\d+)?/.source+utcOffset.source,matchHoursMinutesSeconds=/^(\d{2}):?(\d{2}):?(\d{2})(\.\d+)?/.source+utcOffset.source,iso8601ErrorMessage="Invalid ISO 8601 date.";function JulianDate(e,a,n){this.dayNumber=void 0,this.secondsOfDay=void 0,e=defaultValue(e,0),a=defaultValue(a,0),n=defaultValue(n,TimeStandard.UTC);var r=0|e;setComponents(r,a+=(e-r)*TimeConstants.SECONDS_PER_DAY,this),n===TimeStandard.UTC&&convertUtcToTai(this)}JulianDate.fromGregorianDate=function(e,a){if(!(e instanceof GregorianDate))throw new DeveloperError("date must be a valid GregorianDate.");var n=computeJulianDateComponents(e.year,e.month,e.day,e.hour,e.minute,e.second,e.millisecond);return defined(a)?(setComponents(n[0],n[1],a),convertUtcToTai(a),a):new JulianDate(n[0],n[1],TimeStandard.UTC)},JulianDate.fromDate=function(e,a){if(!(e instanceof Date)||isNaN(e.getTime()))throw new DeveloperError("date must be a valid JavaScript Date.");var n=computeJulianDateComponents(e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds());return defined(a)?(setComponents(n[0],n[1],a),convertUtcToTai(a),a):new JulianDate(n[0],n[1],TimeStandard.UTC)},JulianDate.fromIso8601=function(e,a){if("string"!=typeof e)throw new DeveloperError(iso8601ErrorMessage);var n,r,t,o,i,d=(e=e.replace(",",".")).split("T"),s=1,u=1,c=0,l=0,D=0,f=0,S=d[0],p=d[1];if(!defined(S))throw new DeveloperError(iso8601ErrorMessage);if(null!==(d=S.match(matchCalendarDate))){if((o=S.split("-").length-1)>0&&2!==o)throw new DeveloperError(iso8601ErrorMessage);n=+d[1],s=+d[2],u=+d[3]}else if(null!==(d=S.match(matchCalendarMonth)))n=+d[1],s=+d[2];else if(null!==(d=S.match(matchCalendarYear)))n=+d[1];else{var m;if(null!==(d=S.match(matchOrdinalDate))){if(n=+d[1],m=+d[2],t=isLeapYear(n),m<1||t&&m>366||!t&&m>365)throw new DeveloperError(iso8601ErrorMessage)}else{if(null===(d=S.match(matchWeekDate)))throw new DeveloperError(iso8601ErrorMessage);n=+d[1];var w=+d[2],T=+d[3]||0;if((o=S.split("-").length-1)>0&&(!defined(d[3])&&1!==o||defined(d[3])&&2!==o))throw new DeveloperError(iso8601ErrorMessage);m=7*w+T-new Date(Date.UTC(n,0,4)).getUTCDay()-3}(r=new Date(Date.UTC(n,0,1))).setUTCDate(m),s=r.getUTCMonth()+1,u=r.getUTCDate()}if(t=isLeapYear(n),s<1||s>12||u<1||(2!==s||!t)&&u>daysInMonth[s-1]||t&&2===s&&u>daysInLeapFeburary)throw new DeveloperError(iso8601ErrorMessage);if(defined(p)){if(null!==(d=p.match(matchHoursMinutesSeconds))){if((o=p.split(":").length-1)>0&&2!==o&&3!==o)throw new DeveloperError(iso8601ErrorMessage);c=+d[1],l=+d[2],D=+d[3],f=1e3*+(d[4]||0),i=5}else if(null!==(d=p.match(matchHoursMinutes))){if((o=p.split(":").length-1)>2)throw new DeveloperError(iso8601ErrorMessage);c=+d[1],l=+d[2],D=60*+(d[3]||0),i=4}else{if(null===(d=p.match(matchHours)))throw new DeveloperError(iso8601ErrorMessage);c=+d[1],l=60*+(d[2]||0),i=3}if(l>=60||D>=61||c>24||24===c&&(l>0||D>0||f>0))throw new DeveloperError(iso8601ErrorMessage);var h=d[i],E=+d[i+1],J=+(d[i+2]||0);switch(h){case"+":c-=E,l-=J;break;case"-":c+=E,l+=J;break;case"Z":break;default:l+=new Date(Date.UTC(n,s-1,u,c,l)).getTimezoneOffset()}}var y=60===D;for(y&&D--;l>=60;)l-=60,c++;for(;c>=24;)c-=24,u++;for(r=t&&2===s?daysInLeapFeburary:daysInMonth[s-1];u>r;)u-=r,++s>12&&(s-=12,n++),r=t&&2===s?daysInLeapFeburary:daysInMonth[s-1];for(;l<0;)l+=60,c--;for(;c<0;)c+=24,u--;for(;u<1;)--s<1&&(s+=12,n--),u+=r=t&&2===s?daysInLeapFeburary:daysInMonth[s-1];var v=computeJulianDateComponents(n,s,u,c,l,D,f);return defined(a)?(setComponents(v[0],v[1],a),convertUtcToTai(a)):a=new JulianDate(v[0],v[1],TimeStandard.UTC),y&&JulianDate.addSeconds(a,1,a),a},JulianDate.now=function(e){return JulianDate.fromDate(new Date,e)};var toGregorianDateScratch=new JulianDate(0,0,TimeStandard.TAI);JulianDate.toGregorianDate=function(e,a){if(!defined(e))throw new DeveloperError("julianDate is required.");var n=!1,r=convertTaiToUtc(e,toGregorianDateScratch);defined(r)||(JulianDate.addSeconds(e,-1,toGregorianDateScratch),r=convertTaiToUtc(toGregorianDateScratch,toGregorianDateScratch),n=!0);var t=r.dayNumber,o=r.secondsOfDay;o>=43200&&(t+=1);var i=t+68569|0,d=4*i/146097|0,s=4e3*(1+(i=i-((146097*d+3)/4|0)|0))/1461001|0,u=80*(i=i-(1461*s/4|0)+31|0)/2447|0,c=i-(2447*u/80|0)|0,l=u+2-12*(i=u/11|0)|0,D=100*(d-49)+s+i|0,f=o/TimeConstants.SECONDS_PER_HOUR|0,S=o-f*TimeConstants.SECONDS_PER_HOUR,p=S/TimeConstants.SECONDS_PER_MINUTE|0,m=0|(S-=p*TimeConstants.SECONDS_PER_MINUTE),w=(S-m)/TimeConstants.SECONDS_PER_MILLISECOND;return(f+=12)>23&&(f-=24),n&&(m+=1),defined(a)?(a.year=D,a.month=l,a.day=c,a.hour=f,a.minute=p,a.second=m,a.millisecond=w,a.isLeapSecond=n,a):new GregorianDate(D,l,c,f,p,m,w,n)},JulianDate.toDate=function(e){if(!defined(e))throw new DeveloperError("julianDate is required.");var a=JulianDate.toGregorianDate(e,gregorianDateScratch),n=a.second;return a.isLeapSecond&&(n-=1),new Date(Date.UTC(a.year,a.month-1,a.day,a.hour,a.minute,n,a.millisecond))},JulianDate.toIso8601=function(e,a){if(!defined(e))throw new DeveloperError("julianDate is required.");var n,r=JulianDate.toGregorianDate(e,gregorianDateScratch),t=r.year,o=r.month,i=r.day,d=r.hour,s=r.minute,u=r.second,c=r.millisecond;return 1e4===t&&1===o&&1===i&&0===d&&0===s&&0===u&&0===c&&(t=9999,o=12,i=31,d=24),defined(a)||0===c?defined(a)&&0!==a?(n=(.01*c).toFixed(a).replace(".","").slice(0,a),t.toString().padStart(4,"0")+"-"+o.toString().padStart(2,"0")+"-"+i.toString().padStart(2,"0")+"T"+d.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")+":"+u.toString().padStart(2,"0")+"."+n+"Z"):t.toString().padStart(4,"0")+"-"+o.toString().padStart(2,"0")+"-"+i.toString().padStart(2,"0")+"T"+d.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")+":"+u.toString().padStart(2,"0")+"Z":(n=(.01*c).toString().replace(".",""),t.toString().padStart(4,"0")+"-"+o.toString().padStart(2,"0")+"-"+i.toString().padStart(2,"0")+"T"+d.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")+":"+u.toString().padStart(2,"0")+"."+n+"Z")},JulianDate.clone=function(e,a){if(defined(e))return defined(a)?(a.dayNumber=e.dayNumber,a.secondsOfDay=e.secondsOfDay,a):new JulianDate(e.dayNumber,e.secondsOfDay,TimeStandard.TAI)},JulianDate.compare=function(e,a){if(!defined(e))throw new DeveloperError("left is required.");if(!defined(a))throw new DeveloperError("right is required.");var n=e.dayNumber-a.dayNumber;return 0!==n?n:e.secondsOfDay-a.secondsOfDay},JulianDate.equals=function(e,a){return e===a||defined(e)&&defined(a)&&e.dayNumber===a.dayNumber&&e.secondsOfDay===a.secondsOfDay},JulianDate.equalsEpsilon=function(e,a,n){return n=defaultValue(n,0),e===a||defined(e)&&defined(a)&&Math.abs(JulianDate.secondsDifference(e,a))<=n},JulianDate.totalDays=function(e){if(!defined(e))throw new DeveloperError("julianDate is required.");return e.dayNumber+e.secondsOfDay/TimeConstants.SECONDS_PER_DAY},JulianDate.secondsDifference=function(e,a){if(!defined(e))throw new DeveloperError("left is required.");if(!defined(a))throw new DeveloperError("right is required.");return(e.dayNumber-a.dayNumber)*TimeConstants.SECONDS_PER_DAY+(e.secondsOfDay-a.secondsOfDay)},JulianDate.daysDifference=function(e,a){if(!defined(e))throw new DeveloperError("left is required.");if(!defined(a))throw new DeveloperError("right is required.");return e.dayNumber-a.dayNumber+(e.secondsOfDay-a.secondsOfDay)/TimeConstants.SECONDS_PER_DAY},JulianDate.computeTaiMinusUtc=function(e){binarySearchScratchLeapSecond.julianDate=e;var a=JulianDate.leapSeconds,n=binarySearch(a,binarySearchScratchLeapSecond,compareLeapSecondDates);return n<0&&(n=~n,--n<0&&(n=0)),a[n].offset},JulianDate.addSeconds=function(e,a,n){if(!defined(e))throw new DeveloperError("julianDate is required.");if(!defined(a))throw new DeveloperError("seconds is required.");if(!defined(n))throw new DeveloperError("result is required.");return setComponents(e.dayNumber,e.secondsOfDay+a,n)},JulianDate.addMinutes=function(e,a,n){if(!defined(e))throw new DeveloperError("julianDate is required.");if(!defined(a))throw new DeveloperError("minutes is required.");if(!defined(n))throw new DeveloperError("result is required.");var r=e.secondsOfDay+a*TimeConstants.SECONDS_PER_MINUTE;return setComponents(e.dayNumber,r,n)},JulianDate.addHours=function(e,a,n){if(!defined(e))throw new DeveloperError("julianDate is required.");if(!defined(a))throw new DeveloperError("hours is required.");if(!defined(n))throw new DeveloperError("result is required.");var r=e.secondsOfDay+a*TimeConstants.SECONDS_PER_HOUR;return setComponents(e.dayNumber,r,n)},JulianDate.addDays=function(e,a,n){if(!defined(e))throw new DeveloperError("julianDate is required.");if(!defined(a))throw new DeveloperError("days is required.");if(!defined(n))throw new DeveloperError("result is required.");return setComponents(e.dayNumber+a,e.secondsOfDay,n)},JulianDate.lessThan=function(e,a){return JulianDate.compare(e,a)<0},JulianDate.lessThanOrEquals=function(e,a){return JulianDate.compare(e,a)<=0},JulianDate.greaterThan=function(e,a){return JulianDate.compare(e,a)>0},JulianDate.greaterThanOrEquals=function(e,a){return JulianDate.compare(e,a)>=0},JulianDate.prototype.clone=function(e){return JulianDate.clone(this,e)},JulianDate.prototype.equals=function(e){return JulianDate.equals(this,e)},JulianDate.prototype.equalsEpsilon=function(e,a){return JulianDate.equalsEpsilon(this,e,a)},JulianDate.prototype.toString=function(){return JulianDate.toIso8601(this)},JulianDate.leapSeconds=[new LeapSecond(new JulianDate(2441317,43210,TimeStandard.TAI),10),new LeapSecond(new JulianDate(2441499,43211,TimeStandard.TAI),11),new LeapSecond(new JulianDate(2441683,43212,TimeStandard.TAI),12),new LeapSecond(new JulianDate(2442048,43213,TimeStandard.TAI),13),new LeapSecond(new JulianDate(2442413,43214,TimeStandard.TAI),14),new LeapSecond(new JulianDate(2442778,43215,TimeStandard.TAI),15),new LeapSecond(new JulianDate(2443144,43216,TimeStandard.TAI),16),new LeapSecond(new JulianDate(2443509,43217,TimeStandard.TAI),17),new LeapSecond(new JulianDate(2443874,43218,TimeStandard.TAI),18),new LeapSecond(new JulianDate(2444239,43219,TimeStandard.TAI),19),new LeapSecond(new JulianDate(2444786,43220,TimeStandard.TAI),20),new LeapSecond(new JulianDate(2445151,43221,TimeStandard.TAI),21),new LeapSecond(new JulianDate(2445516,43222,TimeStandard.TAI),22),new LeapSecond(new JulianDate(2446247,43223,TimeStandard.TAI),23),new LeapSecond(new JulianDate(2447161,43224,TimeStandard.TAI),24),new LeapSecond(new JulianDate(2447892,43225,TimeStandard.TAI),25),new LeapSecond(new JulianDate(2448257,43226,TimeStandard.TAI),26),new LeapSecond(new JulianDate(2448804,43227,TimeStandard.TAI),27),new LeapSecond(new JulianDate(2449169,43228,TimeStandard.TAI),28),new LeapSecond(new JulianDate(2449534,43229,TimeStandard.TAI),29),new LeapSecond(new JulianDate(2450083,43230,TimeStandard.TAI),30),new LeapSecond(new JulianDate(2450630,43231,TimeStandard.TAI),31),new LeapSecond(new JulianDate(2451179,43232,TimeStandard.TAI),32),new LeapSecond(new JulianDate(2453736,43233,TimeStandard.TAI),33),new LeapSecond(new JulianDate(2454832,43234,TimeStandard.TAI),34),new LeapSecond(new JulianDate(2456109,43235,TimeStandard.TAI),35),new LeapSecond(new JulianDate(2457204,43236,TimeStandard.TAI),36),new LeapSecond(new JulianDate(2457754,43237,TimeStandard.TAI),37)];export default JulianDate;