import when from"../ThirdParty/when.js";import Cartesian2 from"./Cartesian2.js";import Cartesian3 from"./Cartesian3.js";import Cartesian4 from"./Cartesian4.js";import Cartographic from"./Cartographic.js";import Check from"./Check.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import EarthOrientationParameters from"./EarthOrientationParameters.js";import EarthOrientationParametersSample from"./EarthOrientationParametersSample.js";import Ellipsoid from"./Ellipsoid.js";import HeadingPitchRoll from"./HeadingPitchRoll.js";import Iau2006XysData from"./Iau2006XysData.js";import Iau2006XysSample from"./Iau2006XysSample.js";import JulianDate from"./JulianDate.js";import CesiumMath from"./Math.js";import Matrix3 from"./Matrix3.js";import Matrix4 from"./Matrix4.js";import Quaternion from"./Quaternion.js";import TimeConstants from"./TimeConstants.js";var Transforms={},vectorProductLocalFrame={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},degeneratePositionLocalFrame={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},localFrameToFixedFrameCache={},scratchCalculateCartesian={east:new Cartesian3,north:new Cartesian3,up:new Cartesian3,west:new Cartesian3,south:new Cartesian3,down:new Cartesian3},scratchFirstCartesian=new Cartesian3,scratchSecondCartesian=new Cartesian3,scratchThirdCartesian=new Cartesian3;Transforms.localFrameToFixedFrameGenerator=function(a,r){if(!vectorProductLocalFrame.hasOwnProperty(a)||!vectorProductLocalFrame[a].hasOwnProperty(r))throw new DeveloperError("firstAxis and secondAxis must be east, north, up, west, south or down.");var t,e=vectorProductLocalFrame[a][r],i=a+r;return defined(localFrameToFixedFrameCache[i])?t=localFrameToFixedFrameCache[i]:(t=function(t,i,n){if(!defined(t))throw new DeveloperError("origin is required.");if(defined(n)||(n=new Matrix4),Cartesian3.equalsEpsilon(t,Cartesian3.ZERO,CesiumMath.EPSILON14))Cartesian3.unpack(degeneratePositionLocalFrame[a],0,scratchFirstCartesian),Cartesian3.unpack(degeneratePositionLocalFrame[r],0,scratchSecondCartesian),Cartesian3.unpack(degeneratePositionLocalFrame[e],0,scratchThirdCartesian);else if(CesiumMath.equalsEpsilon(t.x,0,CesiumMath.EPSILON14)&&CesiumMath.equalsEpsilon(t.y,0,CesiumMath.EPSILON14)){var s=CesiumMath.sign(t.z);Cartesian3.unpack(degeneratePositionLocalFrame[a],0,scratchFirstCartesian),"east"!==a&&"west"!==a&&Cartesian3.multiplyByScalar(scratchFirstCartesian,s,scratchFirstCartesian),Cartesian3.unpack(degeneratePositionLocalFrame[r],0,scratchSecondCartesian),"east"!==r&&"west"!==r&&Cartesian3.multiplyByScalar(scratchSecondCartesian,s,scratchSecondCartesian),Cartesian3.unpack(degeneratePositionLocalFrame[e],0,scratchThirdCartesian),"east"!==e&&"west"!==e&&Cartesian3.multiplyByScalar(scratchThirdCartesian,s,scratchThirdCartesian)}else{(i=defaultValue(i,Ellipsoid.WGS84)).geodeticSurfaceNormal(t,scratchCalculateCartesian.up);var o=scratchCalculateCartesian.up,c=scratchCalculateCartesian.east;c.x=-t.y,c.y=t.x,c.z=0,Cartesian3.normalize(c,scratchCalculateCartesian.east),Cartesian3.cross(o,c,scratchCalculateCartesian.north),Cartesian3.multiplyByScalar(scratchCalculateCartesian.up,-1,scratchCalculateCartesian.down),Cartesian3.multiplyByScalar(scratchCalculateCartesian.east,-1,scratchCalculateCartesian.west),Cartesian3.multiplyByScalar(scratchCalculateCartesian.north,-1,scratchCalculateCartesian.south),scratchFirstCartesian=scratchCalculateCartesian[a],scratchSecondCartesian=scratchCalculateCartesian[r],scratchThirdCartesian=scratchCalculateCartesian[e]}return n[0]=scratchFirstCartesian.x,n[1]=scratchFirstCartesian.y,n[2]=scratchFirstCartesian.z,n[3]=0,n[4]=scratchSecondCartesian.x,n[5]=scratchSecondCartesian.y,n[6]=scratchSecondCartesian.z,n[7]=0,n[8]=scratchThirdCartesian.x,n[9]=scratchThirdCartesian.y,n[10]=scratchThirdCartesian.z,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,n},localFrameToFixedFrameCache[i]=t),t},Transforms.eastNorthUpToFixedFrame=Transforms.localFrameToFixedFrameGenerator("east","north"),Transforms.northEastDownToFixedFrame=Transforms.localFrameToFixedFrameGenerator("north","east"),Transforms.northUpEastToFixedFrame=Transforms.localFrameToFixedFrameGenerator("north","up"),Transforms.northWestUpToFixedFrame=Transforms.localFrameToFixedFrameGenerator("north","west");var scratchHPRQuaternion=new Quaternion,scratchScale=new Cartesian3(1,1,1),scratchHPRMatrix4=new Matrix4;Transforms.headingPitchRollToFixedFrame=function(a,r,t,e,i){Check.typeOf.object("HeadingPitchRoll",r),e=defaultValue(e,Transforms.eastNorthUpToFixedFrame);var n=Quaternion.fromHeadingPitchRoll(r,scratchHPRQuaternion),s=Matrix4.fromTranslationQuaternionRotationScale(Cartesian3.ZERO,n,scratchScale,scratchHPRMatrix4);return i=e(a,t,i),Matrix4.multiply(i,s,i)};var scratchENUMatrix4=new Matrix4,scratchHPRMatrix3=new Matrix3;Transforms.headingPitchRollQuaternion=function(a,r,t,e,i){Check.typeOf.object("HeadingPitchRoll",r);var n=Transforms.headingPitchRollToFixedFrame(a,r,t,e,scratchENUMatrix4),s=Matrix4.getMatrix3(n,scratchHPRMatrix3);return Quaternion.fromRotationMatrix(s,i)};var noScale=new Cartesian3(1,1,1),hprCenterScratch=new Cartesian3,ffScratch=new Matrix4,hprTransformScratch=new Matrix4,hprRotationScratch=new Matrix3,hprQuaternionScratch=new Quaternion;Transforms.fixedFrameToHeadingPitchRoll=function(a,r,t,e){Check.defined("transform",a),r=defaultValue(r,Ellipsoid.WGS84),t=defaultValue(t,Transforms.eastNorthUpToFixedFrame),defined(e)||(e=new HeadingPitchRoll);var i=Matrix4.getTranslation(a,hprCenterScratch);if(Cartesian3.equals(i,Cartesian3.ZERO))return e.heading=0,e.pitch=0,e.roll=0,e;var n=Matrix4.inverseTransformation(t(i,r,ffScratch),ffScratch),s=Matrix4.setScale(a,noScale,hprTransformScratch);s=Matrix4.setTranslation(s,Cartesian3.ZERO,s),n=Matrix4.multiply(n,s,n);var o=Quaternion.fromRotationMatrix(Matrix4.getMatrix3(n,hprRotationScratch),hprQuaternionScratch);return o=Quaternion.normalize(o,o),HeadingPitchRoll.fromQuaternion(o,e)};var gmstConstant0=24110.54841,gmstConstant1=8640184.812866,gmstConstant2=.093104,gmstConstant3=-62e-7,rateCoef=11772758384668e-32,wgs84WRPrecessing=72921158553e-15,twoPiOverSecondsInDay=CesiumMath.TWO_PI/86400,dateInUtc=new JulianDate;Transforms.computeTemeToPseudoFixedMatrix=function(a,r){if(!defined(a))throw new DeveloperError("date is required.");var t,e=(dateInUtc=JulianDate.addSeconds(a,-JulianDate.computeTaiMinusUtc(a),dateInUtc)).dayNumber,i=dateInUtc.secondsOfDay,n=e-2451545;t=i>=43200?(n+.5)/TimeConstants.DAYS_PER_JULIAN_CENTURY:(n-.5)/TimeConstants.DAYS_PER_JULIAN_CENTURY;var s=(gmstConstant0+t*(gmstConstant1+t*(gmstConstant2+t*gmstConstant3)))*twoPiOverSecondsInDay%CesiumMath.TWO_PI+(wgs84WRPrecessing+rateCoef*(e-2451545.5))*((i+.5*TimeConstants.SECONDS_PER_DAY)%TimeConstants.SECONDS_PER_DAY),o=Math.cos(s),c=Math.sin(s);return defined(r)?(r[0]=o,r[1]=-c,r[2]=0,r[3]=c,r[4]=o,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r):new Matrix3(o,c,0,-c,o,0,0,0,1)},Transforms.iau2006XysData=new Iau2006XysData,Transforms.earthOrientationParameters=EarthOrientationParameters.NONE;var ttMinusTai=32.184,j2000ttDays=2451545;Transforms.preloadIcrfFixed=function(a){var r=a.start.dayNumber,t=a.start.secondsOfDay+ttMinusTai,e=a.stop.dayNumber,i=a.stop.secondsOfDay+ttMinusTai,n=Transforms.iau2006XysData.preload(r,t,e,i),s=Transforms.earthOrientationParameters.getPromiseToLoad();return when.all([n,s])},Transforms.computeIcrfToFixedMatrix=function(a,r){if(!defined(a))throw new DeveloperError("date is required.");defined(r)||(r=new Matrix3);var t=Transforms.computeFixedToIcrfMatrix(a,r);if(defined(t))return Matrix3.transpose(t,r)};var xysScratch=new Iau2006XysSample(0,0,0),eopScratch=new EarthOrientationParametersSample(0,0,0,0,0,0),rotation1Scratch=new Matrix3,rotation2Scratch=new Matrix3;Transforms.computeFixedToIcrfMatrix=function(a,r){if(!defined(a))throw new DeveloperError("date is required.");defined(r)||(r=new Matrix3);var t=Transforms.earthOrientationParameters.compute(a,eopScratch);if(defined(t)){var e=a.dayNumber,i=a.secondsOfDay+ttMinusTai,n=Transforms.iau2006XysData.computeXysRadians(e,i,xysScratch);if(defined(n)){var s=n.x+t.xPoleOffset,o=n.y+t.yPoleOffset,c=1/(1+Math.sqrt(1-s*s-o*o)),h=rotation1Scratch;h[0]=1-c*s*s,h[3]=-c*s*o,h[6]=s,h[1]=-c*s*o,h[4]=1-c*o*o,h[7]=o,h[2]=-s,h[5]=-o,h[8]=1-c*(s*s+o*o);var l=Matrix3.fromRotationZ(-n.s,rotation2Scratch),m=Matrix3.multiply(h,l,rotation1Scratch),d=a.dayNumber-2451545,u=(a.secondsOfDay-JulianDate.computeTaiMinusUtc(a)+t.ut1MinusUtc)/TimeConstants.SECONDS_PER_DAY,C=.779057273264+u+.00273781191135448*(d+u);C=C%1*CesiumMath.TWO_PI;var f=Matrix3.fromRotationZ(C,rotation2Scratch),p=Matrix3.multiply(m,f,rotation1Scratch),w=Math.cos(t.xPoleWander),x=Math.cos(t.yPoleWander),T=Math.sin(t.xPoleWander),M=Math.sin(t.yPoleWander),y=e-j2000ttDays+i/TimeConstants.SECONDS_PER_DAY,S=-47e-6*(y/=36525)*CesiumMath.RADIANS_PER_DEGREE/3600,F=Math.cos(S),E=Math.sin(S),P=rotation2Scratch;return P[0]=w*F,P[1]=w*E,P[2]=T,P[3]=-x*E+M*T*F,P[4]=x*F+M*T*E,P[5]=-M*w,P[6]=-M*E-x*T*F,P[7]=M*F-x*T*E,P[8]=x*w,Matrix3.multiply(p,P,r)}}};var pointToWindowCoordinatesTemp=new Cartesian4;Transforms.pointToWindowCoordinates=function(a,r,t,e){return(e=Transforms.pointToGLWindowCoordinates(a,r,t,e)).y=2*r[5]-e.y,e},Transforms.pointToGLWindowCoordinates=function(a,r,t,e){if(!defined(a))throw new DeveloperError("modelViewProjectionMatrix is required.");if(!defined(r))throw new DeveloperError("viewportTransformation is required.");if(!defined(t))throw new DeveloperError("point is required.");defined(e)||(e=new Cartesian2);var i=pointToWindowCoordinatesTemp;return Matrix4.multiplyByVector(a,Cartesian4.fromElements(t.x,t.y,t.z,1,i),i),Cartesian4.multiplyByScalar(i,1/i.w,i),Matrix4.multiplyByVector(r,i,i),Cartesian2.fromCartesian4(i,e)};var normalScratch=new Cartesian3,rightScratch=new Cartesian3,upScratch=new Cartesian3;Transforms.rotationMatrixFromPositionVelocity=function(a,r,t,e){if(!defined(a))throw new DeveloperError("position is required.");if(!defined(r))throw new DeveloperError("velocity is required.");var i=defaultValue(t,Ellipsoid.WGS84).geodeticSurfaceNormal(a,normalScratch),n=Cartesian3.cross(r,i,rightScratch);Cartesian3.equalsEpsilon(n,Cartesian3.ZERO,CesiumMath.EPSILON6)&&(n=Cartesian3.clone(Cartesian3.UNIT_X,n));var s=Cartesian3.cross(n,r,upScratch);return Cartesian3.normalize(s,s),Cartesian3.cross(r,s,n),Cartesian3.negate(n,n),Cartesian3.normalize(n,n),defined(e)||(e=new Matrix3),e[0]=r.x,e[1]=r.y,e[2]=r.z,e[3]=n.x,e[4]=n.y,e[5]=n.z,e[6]=s.x,e[7]=s.y,e[8]=s.z,e};var swizzleMatrix=new Matrix4(0,0,1,0,1,0,0,0,0,1,0,0,0,0,0,1),scratchCartographic=new Cartographic,scratchCartesian3Projection=new Cartesian3,scratchCenter=new Cartesian3,scratchRotation=new Matrix3,scratchFromENU=new Matrix4,scratchToENU=new Matrix4;Transforms.basisTo2D=function(a,r,t){if(!defined(a))throw new DeveloperError("projection is required.");if(!defined(r))throw new DeveloperError("matrix is required.");if(!defined(t))throw new DeveloperError("result is required.");var e=Matrix4.getTranslation(r,scratchCenter),i=a.ellipsoid,n=i.cartesianToCartographic(e,scratchCartographic),s=a.project(n,scratchCartesian3Projection);Cartesian3.fromElements(s.z,s.x,s.y,s);var o=Transforms.eastNorthUpToFixedFrame(e,i,scratchFromENU),c=Matrix4.inverseTransformation(o,scratchToENU),h=Matrix4.getMatrix3(r,scratchRotation),l=Matrix4.multiplyByMatrix3(c,h,t);return Matrix4.multiply(swizzleMatrix,l,t),Matrix4.setTranslation(t,s,t),t},Transforms.wgs84To2DModelMatrix=function(a,r,t){if(!defined(a))throw new DeveloperError("projection is required.");if(!defined(r))throw new DeveloperError("center is required.");if(!defined(t))throw new DeveloperError("result is required.");var e=a.ellipsoid,i=Transforms.eastNorthUpToFixedFrame(r,e,scratchFromENU),n=Matrix4.inverseTransformation(i,scratchToENU),s=e.cartesianToCartographic(r,scratchCartographic),o=a.project(s,scratchCartesian3Projection);Cartesian3.fromElements(o.z,o.x,o.y,o);var c=Matrix4.fromTranslation(o,scratchFromENU);return Matrix4.multiply(swizzleMatrix,n,t),Matrix4.multiply(c,t,t),t};export default Transforms;