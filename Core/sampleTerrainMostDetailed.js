import when from"../ThirdParty/when.js";import Cartesian2 from"./Cartesian2.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import sampleTerrain from"./sampleTerrain.js";var scratchCartesian2=new Cartesian2;function sampleTerrainMostDetailed(e,r){if(!defined(e))throw new DeveloperError("terrainProvider is required.");if(!defined(r))throw new DeveloperError("positions is required.");return e.readyPromise.then((function(){var i=[],a=[],t=e.availability;if(!defined(t))throw new DeveloperError("sampleTerrainMostDetailed requires a terrain provider that has tile availability.");for(var n=[],o=0;o<r.length;++o){var s=r[o],l=t.computeMaximumLevelAtPosition(s);if(a[o]=l,0===l){e.tilingScheme.positionToTileXY(s,1,scratchCartesian2);var d=e.loadTileDataAvailability(scratchCartesian2.x,scratchCartesian2.y,1);defined(d)&&n.push(d)}var f=i[l];defined(f)||(i[l]=f=[]),f.push(s)}return when.all(n).then((function(){return when.all(i.map((function(r,i){if(defined(r))return sampleTerrain(e,i,r)})))})).then((function(){for(var i=[],n=0;n<r.length;++n){var o=r[n];t.computeMaximumLevelAtPosition(o)!==a[n]&&i.push(o)}if(i.length>0)return sampleTerrainMostDetailed(e,i)})).then((function(){return r}))}))}export default sampleTerrainMostDetailed;