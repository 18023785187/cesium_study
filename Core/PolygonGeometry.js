import ArcType from"./ArcType.js";import arrayFill from"./arrayFill.js";import BoundingRectangle from"./BoundingRectangle.js";import BoundingSphere from"./BoundingSphere.js";import Cartesian2 from"./Cartesian2.js";import Cartesian3 from"./Cartesian3.js";import Cartographic from"./Cartographic.js";import Check from"./Check.js";import ComponentDatatype from"./ComponentDatatype.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import Ellipsoid from"./Ellipsoid.js";import EllipsoidGeodesic from"./EllipsoidGeodesic.js";import EllipsoidTangentPlane from"./EllipsoidTangentPlane.js";import Geometry from"./Geometry.js";import GeometryAttribute from"./GeometryAttribute.js";import GeometryInstance from"./GeometryInstance.js";import GeometryOffsetAttribute from"./GeometryOffsetAttribute.js";import GeometryPipeline from"./GeometryPipeline.js";import IndexDatatype from"./IndexDatatype.js";import CesiumMath from"./Math.js";import Matrix3 from"./Matrix3.js";import PolygonGeometryLibrary from"./PolygonGeometryLibrary.js";import PolygonPipeline from"./PolygonPipeline.js";import Quaternion from"./Quaternion.js";import Rectangle from"./Rectangle.js";import VertexFormat from"./VertexFormat.js";import WindingOrder from"./WindingOrder.js";var scratchCarto1=new Cartographic,scratchCarto2=new Cartographic;function adjustPosHeightsForNormal(e,t,r,o){var a=o.cartesianToCartographic(e,scratchCarto1).height,i=o.cartesianToCartographic(t,scratchCarto2);i.height=a,o.cartographicToCartesian(i,t);var n=o.cartesianToCartographic(r,scratchCarto2);n.height=a-100,o.cartographicToCartesian(n,r)}var scratchBoundingRectangle=new BoundingRectangle,scratchPosition=new Cartesian3,scratchNormal=new Cartesian3,scratchTangent=new Cartesian3,scratchBitangent=new Cartesian3,p1Scratch=new Cartesian3,p2Scratch=new Cartesian3,scratchPerPosNormal=new Cartesian3,scratchPerPosTangent=new Cartesian3,scratchPerPosBitangent=new Cartesian3,appendTextureCoordinatesOrigin=new Cartesian2,appendTextureCoordinatesCartesian2=new Cartesian2,appendTextureCoordinatesCartesian3=new Cartesian3,appendTextureCoordinatesQuaternion=new Quaternion,appendTextureCoordinatesMatrix3=new Matrix3,tangentMatrixScratch=new Matrix3;function computeAttributes(e){var t=e.vertexFormat,r=e.geometry,o=e.shadowVolume,a=r.attributes.position.values,i=a.length,n=e.wall,s=e.top||n,l=e.bottom||n;if(t.st||t.normal||t.tangent||t.bitangent||o){var c=e.boundingRectangle,p=e.tangentPlane,m=e.ellipsoid,u=e.stRotation,d=e.perPositionHeight,y=appendTextureCoordinatesOrigin;y.x=c.x,y.y=c.y;var g,h=t.st?new Float32Array(i/3*2):void 0;t.normal&&(g=d&&s&&!n?r.attributes.normal.values:new Float32Array(i));var f=t.tangent?new Float32Array(i):void 0,P=t.bitangent?new Float32Array(i):void 0,C=o?new Float32Array(i):void 0,v=0,T=0,b=scratchNormal,x=scratchTangent,_=scratchBitangent,G=!0,w=appendTextureCoordinatesMatrix3,A=tangentMatrixScratch;if(0!==u){var E=Quaternion.fromAxisAngle(p._plane.normal,u,appendTextureCoordinatesQuaternion);w=Matrix3.fromQuaternion(E,w),E=Quaternion.fromAxisAngle(p._plane.normal,-u,appendTextureCoordinatesQuaternion),A=Matrix3.fromQuaternion(E,A)}else w=Matrix3.clone(Matrix3.IDENTITY,w),A=Matrix3.clone(Matrix3.IDENTITY,A);var I=0,O=0;s&&l&&(I=i/2,O=i/3,i/=2);for(var F=0;F<i;F+=3){var H=Cartesian3.fromArray(a,F,appendTextureCoordinatesCartesian3);if(t.st){var D=Matrix3.multiplyByVector(w,H,scratchPosition);D=m.scaleToGeodeticSurface(D,D);var V=p.projectPointOntoPlane(D,appendTextureCoordinatesCartesian2);Cartesian2.subtract(V,y,V);var N=CesiumMath.clamp(V.x/c.width,0,1),R=CesiumMath.clamp(V.y/c.height,0,1);l&&(h[v+O]=N,h[v+1+O]=R),s&&(h[v]=N,h[v+1]=R),v+=2}if(t.normal||t.tangent||t.bitangent||o){var L=T+1,M=T+2;if(n){if(F+3<i){var S=Cartesian3.fromArray(a,F+3,p1Scratch);if(G){var j=Cartesian3.fromArray(a,F+i,p2Scratch);d&&adjustPosHeightsForNormal(H,S,j,m),Cartesian3.subtract(S,H,S),Cartesian3.subtract(j,H,j),b=Cartesian3.normalize(Cartesian3.cross(j,S,b),b),G=!1}Cartesian3.equalsEpsilon(S,H,CesiumMath.EPSILON10)&&(G=!0)}(t.tangent||t.bitangent)&&(_=m.geodeticSurfaceNormal(H,_),t.tangent&&(x=Cartesian3.normalize(Cartesian3.cross(_,b,x),x)))}else b=m.geodeticSurfaceNormal(H,b),(t.tangent||t.bitangent)&&(d&&(scratchPerPosNormal=Cartesian3.fromArray(g,T,scratchPerPosNormal),scratchPerPosTangent=Cartesian3.cross(Cartesian3.UNIT_Z,scratchPerPosNormal,scratchPerPosTangent),scratchPerPosTangent=Cartesian3.normalize(Matrix3.multiplyByVector(A,scratchPerPosTangent,scratchPerPosTangent),scratchPerPosTangent),t.bitangent&&(scratchPerPosBitangent=Cartesian3.normalize(Cartesian3.cross(scratchPerPosNormal,scratchPerPosTangent,scratchPerPosBitangent),scratchPerPosBitangent))),x=Cartesian3.cross(Cartesian3.UNIT_Z,b,x),x=Cartesian3.normalize(Matrix3.multiplyByVector(A,x,x),x),t.bitangent&&(_=Cartesian3.normalize(Cartesian3.cross(b,x,_),_)));t.normal&&(e.wall?(g[T+I]=b.x,g[L+I]=b.y,g[M+I]=b.z):l&&(g[T+I]=-b.x,g[L+I]=-b.y,g[M+I]=-b.z),(s&&!d||n)&&(g[T]=b.x,g[L]=b.y,g[M]=b.z)),o&&(n&&(b=m.geodeticSurfaceNormal(H,b)),C[T+I]=-b.x,C[L+I]=-b.y,C[M+I]=-b.z),t.tangent&&(e.wall?(f[T+I]=x.x,f[L+I]=x.y,f[M+I]=x.z):l&&(f[T+I]=-x.x,f[L+I]=-x.y,f[M+I]=-x.z),s&&(d?(f[T]=scratchPerPosTangent.x,f[L]=scratchPerPosTangent.y,f[M]=scratchPerPosTangent.z):(f[T]=x.x,f[L]=x.y,f[M]=x.z))),t.bitangent&&(l&&(P[T+I]=_.x,P[L+I]=_.y,P[M+I]=_.z),s&&(d?(P[T]=scratchPerPosBitangent.x,P[L]=scratchPerPosBitangent.y,P[M]=scratchPerPosBitangent.z):(P[T]=_.x,P[L]=_.y,P[M]=_.z))),T+=3}}t.st&&(r.attributes.st=new GeometryAttribute({componentDatatype:ComponentDatatype.FLOAT,componentsPerAttribute:2,values:h})),t.normal&&(r.attributes.normal=new GeometryAttribute({componentDatatype:ComponentDatatype.FLOAT,componentsPerAttribute:3,values:g})),t.tangent&&(r.attributes.tangent=new GeometryAttribute({componentDatatype:ComponentDatatype.FLOAT,componentsPerAttribute:3,values:f})),t.bitangent&&(r.attributes.bitangent=new GeometryAttribute({componentDatatype:ComponentDatatype.FLOAT,componentsPerAttribute:3,values:P})),o&&(r.attributes.extrudeDirection=new GeometryAttribute({componentDatatype:ComponentDatatype.FLOAT,componentsPerAttribute:3,values:C}))}if(e.extrude&&defined(e.offsetAttribute)){var B=a.length/3,k=new Uint8Array(B);if(e.offsetAttribute===GeometryOffsetAttribute.TOP)s&&l||n?k=arrayFill(k,1,0,B/2):s&&(k=arrayFill(k,1));else{var z=e.offsetAttribute===GeometryOffsetAttribute.NONE?0:1;k=arrayFill(k,z)}r.attributes.applyOffset=new GeometryAttribute({componentDatatype:ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:k})}return r}var startCartographicScratch=new Cartographic,endCartographicScratch=new Cartographic,idlCross={westOverIDL:0,eastOverIDL:0},ellipsoidGeodesic=new EllipsoidGeodesic;function computeRectangle(e,t,r,o,a){if(a=defaultValue(a,new Rectangle),!defined(e)||e.length<3)return a.west=0,a.north=0,a.south=0,a.east=0,a;if(r===ArcType.RHUMB)return Rectangle.fromCartesianArray(e,t,a);ellipsoidGeodesic.ellipsoid.equals(t)||(ellipsoidGeodesic=new EllipsoidGeodesic(void 0,void 0,t)),a.west=Number.POSITIVE_INFINITY,a.east=Number.NEGATIVE_INFINITY,a.south=Number.POSITIVE_INFINITY,a.north=Number.NEGATIVE_INFINITY,idlCross.westOverIDL=Number.POSITIVE_INFINITY,idlCross.eastOverIDL=Number.NEGATIVE_INFINITY;for(var i,n=1/CesiumMath.chordLength(o,t.maximumRadius),s=e.length,l=t.cartesianToCartographic(e[0],endCartographicScratch),c=startCartographicScratch,p=1;p<s;p++)i=c,c=l,l=t.cartesianToCartographic(e[p],i),ellipsoidGeodesic.setEndPoints(c,l),interpolateAndGrowRectangle(ellipsoidGeodesic,n,a,idlCross);return i=c,c=l,l=t.cartesianToCartographic(e[0],i),ellipsoidGeodesic.setEndPoints(c,l),interpolateAndGrowRectangle(ellipsoidGeodesic,n,a,idlCross),a.east-a.west>idlCross.eastOverIDL-idlCross.westOverIDL&&(a.west=idlCross.westOverIDL,a.east=idlCross.eastOverIDL,a.east>CesiumMath.PI&&(a.east=a.east-CesiumMath.TWO_PI),a.west>CesiumMath.PI&&(a.west=a.west-CesiumMath.TWO_PI)),a}var interpolatedCartographicScratch=new Cartographic;function interpolateAndGrowRectangle(e,t,r,o){for(var a=e.surfaceDistance,i=Math.ceil(a*t),n=i>0?a/(i-1):Number.POSITIVE_INFINITY,s=0,l=0;l<i;l++){var c=e.interpolateUsingSurfaceDistance(s,interpolatedCartographicScratch);s+=n;var p=c.longitude,m=c.latitude;r.west=Math.min(r.west,p),r.east=Math.max(r.east,p),r.south=Math.min(r.south,m),r.north=Math.max(r.north,m);var u=p>=0?p:p+CesiumMath.TWO_PI;o.westOverIDL=Math.min(o.westOverIDL,u),o.eastOverIDL=Math.max(o.eastOverIDL,u)}}var createGeometryFromPositionsExtrudedPositions=[];function createGeometryFromPositionsExtruded(e,t,r,o,a,i,n,s,l){var c,p={walls:[]};if(i||n){var m,u,d=PolygonGeometryLibrary.createGeometryFromPositions(e,t,r,a,s,l),y=d.attributes.position.values,g=d.indices;if(i&&n){var h=y.concat(y);m=h.length/3,(u=IndexDatatype.createTypedArray(m,2*g.length)).set(g);var f=g.length,P=m/2;for(c=0;c<f;c+=3){var C=u[c]+P,v=u[c+1]+P,T=u[c+2]+P;u[c+f]=T,u[c+1+f]=v,u[c+2+f]=C}if(d.attributes.position.values=h,a&&s.normal){var b=d.attributes.normal.values;d.attributes.normal.values=new Float32Array(h.length),d.attributes.normal.values.set(b)}d.indices=u}else if(n){for(m=y.length/3,u=IndexDatatype.createTypedArray(m,g.length),c=0;c<g.length;c+=3)u[c]=g[c+2],u[c+1]=g[c+1],u[c+2]=g[c];d.indices=u}p.topAndBottom=new GeometryInstance({geometry:d})}var x=o.outerRing,_=EllipsoidTangentPlane.fromPoints(x,e),G=_.projectPointsOntoPlane(x,createGeometryFromPositionsExtrudedPositions),w=PolygonPipeline.computeWindingOrder2D(G);w===WindingOrder.CLOCKWISE&&(x=x.slice().reverse());var A=PolygonGeometryLibrary.computeWallGeometry(x,e,r,a,l);p.walls.push(new GeometryInstance({geometry:A}));var E=o.holes;for(c=0;c<E.length;c++){var I=E[c];G=(_=EllipsoidTangentPlane.fromPoints(I,e)).projectPointsOntoPlane(I,createGeometryFromPositionsExtrudedPositions),(w=PolygonPipeline.computeWindingOrder2D(G))===WindingOrder.COUNTER_CLOCKWISE&&(I=I.slice().reverse()),A=PolygonGeometryLibrary.computeWallGeometry(I,e,r,a,l),p.walls.push(new GeometryInstance({geometry:A}))}return p}function PolygonGeometry(e){if(Check.typeOf.object("options",e),Check.typeOf.object("options.polygonHierarchy",e.polygonHierarchy),defined(e.perPositionHeight)&&e.perPositionHeight&&defined(e.height))throw new DeveloperError("Cannot use both options.perPositionHeight and options.height");if(defined(e.arcType)&&e.arcType!==ArcType.GEODESIC&&e.arcType!==ArcType.RHUMB)throw new DeveloperError("Invalid arcType. Valid options are ArcType.GEODESIC and ArcType.RHUMB.");var t=e.polygonHierarchy,r=defaultValue(e.vertexFormat,VertexFormat.DEFAULT),o=defaultValue(e.ellipsoid,Ellipsoid.WGS84),a=defaultValue(e.granularity,CesiumMath.RADIANS_PER_DEGREE),i=defaultValue(e.stRotation,0),n=defaultValue(e.perPositionHeight,!1),s=n&&defined(e.extrudedHeight),l=defaultValue(e.height,0),c=defaultValue(e.extrudedHeight,l);if(!s){var p=Math.max(l,c);c=Math.min(l,c),l=p}this._vertexFormat=VertexFormat.clone(r),this._ellipsoid=Ellipsoid.clone(o),this._granularity=a,this._stRotation=i,this._height=l,this._extrudedHeight=c,this._closeTop=defaultValue(e.closeTop,!0),this._closeBottom=defaultValue(e.closeBottom,!0),this._polygonHierarchy=t,this._perPositionHeight=n,this._perPositionHeightExtrude=s,this._shadowVolume=defaultValue(e.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=e.offsetAttribute,this._arcType=defaultValue(e.arcType,ArcType.GEODESIC),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=PolygonGeometryLibrary.computeHierarchyPackedLength(t)+Ellipsoid.packedLength+VertexFormat.packedLength+12}PolygonGeometry.fromPositions=function(e){return e=defaultValue(e,defaultValue.EMPTY_OBJECT),Check.defined("options.positions",e.positions),new PolygonGeometry({polygonHierarchy:{positions:e.positions},height:e.height,extrudedHeight:e.extrudedHeight,vertexFormat:e.vertexFormat,stRotation:e.stRotation,ellipsoid:e.ellipsoid,granularity:e.granularity,perPositionHeight:e.perPositionHeight,closeTop:e.closeTop,closeBottom:e.closeBottom,offsetAttribute:e.offsetAttribute,arcType:e.arcType})},PolygonGeometry.pack=function(e,t,r){return Check.typeOf.object("value",e),Check.defined("array",t),r=defaultValue(r,0),r=PolygonGeometryLibrary.packPolygonHierarchy(e._polygonHierarchy,t,r),Ellipsoid.pack(e._ellipsoid,t,r),r+=Ellipsoid.packedLength,VertexFormat.pack(e._vertexFormat,t,r),r+=VertexFormat.packedLength,t[r++]=e._height,t[r++]=e._extrudedHeight,t[r++]=e._granularity,t[r++]=e._stRotation,t[r++]=e._perPositionHeightExtrude?1:0,t[r++]=e._perPositionHeight?1:0,t[r++]=e._closeTop?1:0,t[r++]=e._closeBottom?1:0,t[r++]=e._shadowVolume?1:0,t[r++]=defaultValue(e._offsetAttribute,-1),t[r++]=e._arcType,t[r]=e.packedLength,t};var scratchEllipsoid=Ellipsoid.clone(Ellipsoid.UNIT_SPHERE),scratchVertexFormat=new VertexFormat,dummyOptions={polygonHierarchy:{}};function textureCoordinateRotationPoints(e){var t=-e._stRotation;if(0===t)return[0,0,0,1,1,0];var r=e._ellipsoid,o=e._polygonHierarchy.positions,a=e.rectangle;return Geometry._textureCoordinateRotationPoints(o,t,r,a)}PolygonGeometry.unpack=function(e,t,r){Check.defined("array",e),t=defaultValue(t,0);var o=PolygonGeometryLibrary.unpackPolygonHierarchy(e,t);t=o.startingIndex,delete o.startingIndex;var a=Ellipsoid.unpack(e,t,scratchEllipsoid);t+=Ellipsoid.packedLength;var i=VertexFormat.unpack(e,t,scratchVertexFormat);t+=VertexFormat.packedLength;var n=e[t++],s=e[t++],l=e[t++],c=e[t++],p=1===e[t++],m=1===e[t++],u=1===e[t++],d=1===e[t++],y=1===e[t++],g=e[t++],h=e[t++],f=e[t];return defined(r)||(r=new PolygonGeometry(dummyOptions)),r._polygonHierarchy=o,r._ellipsoid=Ellipsoid.clone(a,r._ellipsoid),r._vertexFormat=VertexFormat.clone(i,r._vertexFormat),r._height=n,r._extrudedHeight=s,r._granularity=l,r._stRotation=c,r._perPositionHeightExtrude=p,r._perPositionHeight=m,r._closeTop=u,r._closeBottom=d,r._shadowVolume=y,r._offsetAttribute=-1===g?void 0:g,r._arcType=h,r.packedLength=f,r},PolygonGeometry.computeRectangle=function(e,t){Check.typeOf.object("options",e),Check.typeOf.object("options.polygonHierarchy",e.polygonHierarchy);var r=defaultValue(e.granularity,CesiumMath.RADIANS_PER_DEGREE),o=defaultValue(e.arcType,ArcType.GEODESIC);if(o!==ArcType.GEODESIC&&o!==ArcType.RHUMB)throw new DeveloperError("Invalid arcType. Valid options are ArcType.GEODESIC and ArcType.RHUMB.");var a=e.polygonHierarchy,i=defaultValue(e.ellipsoid,Ellipsoid.WGS84);return computeRectangle(a.positions,i,o,r,t)},PolygonGeometry.createGeometry=function(e){var t=e._vertexFormat,r=e._ellipsoid,o=e._granularity,a=e._stRotation,i=e._polygonHierarchy,n=e._perPositionHeight,s=e._closeTop,l=e._closeBottom,c=e._arcType,p=i.positions;if(!(p.length<3)){var m=EllipsoidTangentPlane.fromPoints(p,r),u=PolygonGeometryLibrary.polygonsFromHierarchy(i,m.projectPointsOntoPlane.bind(m),!n,r),d=u.hierarchy,y=u.polygons;if(0!==d.length){p=d[0].outerRing;var g,h=PolygonGeometryLibrary.computeBoundingRectangle(m.plane.normal,m.projectPointOntoPlane.bind(m),p,a,scratchBoundingRectangle),f=[],P=e._height,C=e._extrudedHeight,v={perPositionHeight:n,vertexFormat:t,geometry:void 0,tangentPlane:m,boundingRectangle:h,ellipsoid:r,stRotation:a,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:c};if(e._perPositionHeightExtrude||!CesiumMath.equalsEpsilon(P,C,0,CesiumMath.EPSILON2))for(v.extrude=!0,v.top=s,v.bottom=l,v.shadowVolume=e._shadowVolume,v.offsetAttribute=e._offsetAttribute,g=0;g<y.length;g++){var T,b=createGeometryFromPositionsExtruded(r,y[g],o,d[g],n,s,l,t,c);s&&l?(T=b.topAndBottom,v.geometry=PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(T.geometry,P,C,r,n)):s?((T=b.topAndBottom).geometry.attributes.position.values=PolygonPipeline.scaleToGeodeticHeight(T.geometry.attributes.position.values,P,r,!n),v.geometry=T.geometry):l&&((T=b.topAndBottom).geometry.attributes.position.values=PolygonPipeline.scaleToGeodeticHeight(T.geometry.attributes.position.values,C,r,!0),v.geometry=T.geometry),(s||l)&&(v.wall=!1,T.geometry=computeAttributes(v),f.push(T));var x=b.walls;v.wall=!0;for(var _=0;_<x.length;_++){var G=x[_];v.geometry=PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(G.geometry,P,C,r,n),G.geometry=computeAttributes(v),f.push(G)}}else for(g=0;g<y.length;g++){var w=new GeometryInstance({geometry:PolygonGeometryLibrary.createGeometryFromPositions(r,y[g],o,n,t,c)});if(w.geometry.attributes.position.values=PolygonPipeline.scaleToGeodeticHeight(w.geometry.attributes.position.values,P,r,!n),v.geometry=w.geometry,w.geometry=computeAttributes(v),defined(e._offsetAttribute)){var A=w.geometry.attributes.position.values.length,E=new Uint8Array(A/3),I=e._offsetAttribute===GeometryOffsetAttribute.NONE?0:1;arrayFill(E,I),w.geometry.attributes.applyOffset=new GeometryAttribute({componentDatatype:ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:E})}f.push(w)}var O=GeometryPipeline.combineInstances(f)[0];O.attributes.position.values=new Float64Array(O.attributes.position.values),O.indices=IndexDatatype.createTypedArray(O.attributes.position.values.length/3,O.indices);var F=O.attributes,H=BoundingSphere.fromVertices(F.position.values);return t.position||delete F.position,new Geometry({attributes:F,indices:O.indices,primitiveType:O.primitiveType,boundingSphere:H,offsetAttribute:e._offsetAttribute})}}},PolygonGeometry.createShadowVolume=function(e,t,r){var o=e._granularity,a=e._ellipsoid,i=t(o,a),n=r(o,a);return new PolygonGeometry({polygonHierarchy:e._polygonHierarchy,ellipsoid:a,stRotation:e._stRotation,granularity:o,perPositionHeight:!1,extrudedHeight:i,height:n,vertexFormat:VertexFormat.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},Object.defineProperties(PolygonGeometry.prototype,{rectangle:{get:function(){if(!defined(this._rectangle)){var e=this._polygonHierarchy.positions;this._rectangle=computeRectangle(e,this._ellipsoid,this._arcType,this._granularity)}return this._rectangle}},textureCoordinateRotationPoints:{get:function(){return defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=textureCoordinateRotationPoints(this)),this._textureCoordinateRotationPoints}}});export default PolygonGeometry;